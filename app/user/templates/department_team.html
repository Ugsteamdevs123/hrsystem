{% extends 'base.html' %}
{% block title %}Add Department{% endblock %}
{% block content %}
    <div class="container mt-5">
        <h1 class="mb-4 text-primary">Add Department</h1>
        <div class="card shadow-sm p-4 bg-light">
            <form id="departmentForm">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <div class="mb-3">
                    <label for="company-select" class="form-label">Select Company</label>
                    <select id="company-select" class="form-select w-50" name="company_id" required onchange="fetchDepartments()">
                        <option value="" selected>Select a company</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="department-name" class="form-label">Department Name</label>
                    <input type="text" class="form-control w-50" id="department-name" name="name" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Department</button>
            </form>
            <div id="form-message" class="mt-3"></div>
            <div id="departments-table" class="mt-4">
                <p class="text-muted">Select a company to view departments.</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Delete -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Deleting this department will also delete associated increment summaries and employee increment details. Are you sure?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .custom-table {
            border-collapse: collapse;
        }
        .custom-table th, .custom-table td {
            min-width: 120px;
            max-width: 300px;
            text-align: left !important;
            padding: 12px;
        }
        .custom-table th {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .custom-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .custom-table tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .custom-table .editable-cell {
            background-color: #e6f3ff;
        }
        .custom-table .editable-cell:hover {
            background-color: #cce5ff;
        }
        .custom-table .btn-sm {
            padding: 4px 8px;
            margin-right: 5px;
        }
    </style>

    <script>
        let selectedDepartmentId = null;

        async function fetchCompaniesAndDepartmentTeams() {
            try {
                const response = await fetch('/pyroll/get-companies-and-department-teams/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                });
                if (!response.ok) throw new Error('Failed to fetch companies');
                const data = await response.json();
                const companySelect = document.getElementById('company-select');
                const selectedCompanyId = companySelect.value;
                companySelect.innerHTML = '<option value="" selected>Select a company</option>';
                window.companyData = data.data;
                data.data.forEach(company => {
                    companySelect.innerHTML += `<option value="${company.company_id}">${company.company}</option>`;
                });
                if (selectedCompanyId) {
                    companySelect.value = selectedCompanyId;
                }
                fetchDepartments();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error fetching companies.</p>';
            }
        }

        function fetchDepartments() {
            const companySelect = document.getElementById('company-select');
            const companyId = companySelect.value;
            const departmentsTable = document.getElementById('departments-table');

            if (!companyId) {
                departmentsTable.innerHTML = '<p class="text-muted">Select a company to view departments.</p>';
                return;
            }

            const company = window.companyData.find(c => c.company_id == companyId);
            if (!company || !company.departments || company.departments.length === 0) {
                departmentsTable.innerHTML = '<p class="text-muted">No departments found for this company.</p>';
                return;
            }

            let html = '<h6 class="mb-3">Registered Departments</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-bordered custom-table">';
            html += '<thead><tr><th class="font-weight-bold border-end">Department Name</th><th class="font-weight-bold border-end">Actions</th></tr></thead><tbody>';
            company.departments.forEach(department => {
                html += `<tr data-department-id="${department.id}">`;
                html += `<td class="border-end editable-cell" contenteditable="false">${department.name}</td>`;
                html += `<td class="border-end">`;
                html += `<button class="btn btn-sm btn-primary edit-dept-btn">Edit</button>`;
                html += `<button class="btn btn-sm btn-success save-dept-btn" style="display: none;">Save</button>`;
                html += `<button class="btn btn-sm btn-danger delete-dept-btn">Delete</button>`;
                html += `</td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            departmentsTable.innerHTML = html;

            // Edit button listeners
            document.querySelectorAll('.edit-dept-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const row = this.closest('tr');
                    const cell = row.querySelector('.editable-cell');
                    cell.contentEditable = 'true';
                    cell.focus();
                    this.style.display = 'none';
                    row.querySelector('.save-dept-btn').style.display = 'inline-block';
                });
            });

            // Save button listeners
            document.querySelectorAll('.save-dept-btn').forEach(button => {
                button.addEventListener('click', async function () {
                    const row = this.closest('tr');
                    const id = row.dataset.departmentId;
                    const value = row.querySelector('.editable-cell').textContent.trim();
                    if (!value) {
                        alert('Department name cannot be empty');
                        fetchDepartments();
                        return;
                    }
                    try {
                        // formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
                        const response = await fetch('/pyroll/department-team/', {
                            method: 'PATCH',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ id, name: value })
                        });
                        
                        if (!response.ok) throw new Error('Failed to update');
                        const result = await response.json();
                        if (result.error) {
                            alert(result.error);
                            fetchDepartments();
                        } else {
                            row.querySelector('.editable-cell').contentEditable = 'false';
                            this.style.display = 'none';
                            row.querySelector('.edit-dept-btn').style.display = 'inline-block';
                            fetchCompaniesAndDepartmentTeams();
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error updating department');
                        fetchDepartments();
                    }
                });
            });

            // Delete button listeners
            document.querySelectorAll('.delete-dept-btn').forEach(button => {
                button.addEventListener('click', function () {
                    selectedDepartmentId = this.closest('tr').dataset.departmentId;
                    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    modal.show();
                });
            });

            // Confirm delete button
            document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
                if (!selectedDepartmentId) return;
                try {
                    const formData = new FormData();
                    // formData.append('csrfmiddlewaretoken', document.querySelector('input[name="csrfmiddlewaretoken"]').value);
                    const response = await fetch('/pyroll/department-team/', {
                        method: 'DELETE',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 'id': selectedDepartmentId })
                    });
                    if (!response.ok) throw new Error('Failed to delete');
                    const result = await response.json();
                    if (result.error) {
                        alert(result.error);
                    }
                    fetchCompaniesAndDepartmentTeams();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting department');
                }
                selectedDepartmentId = null;
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            });
        }

        document.getElementById('departmentForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const companyId = document.getElementById('company-select').value;
            const departmentName = document.getElementById('department-name').value.trim();
            if (!companyId) {
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Please select a company.</p>';
                return;
            }
            if (!departmentName) {
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Please enter a department name.</p>';
                return;
            }
            const formData = new FormData(this);
            try {
                const response = await fetch('/pyroll/department-team/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to add department');
                const result = await response.json();
                if (result.error) {
                    document.getElementById('form-message').innerHTML = `<p class="text-danger">${result.error}</p>`;
                } else {
                    document.getElementById('form-message').innerHTML = '<p class="text-success">Department added successfully!</p>';
                    document.getElementById('department-name').value = '';
                    fetchCompaniesAndDepartmentTeams();
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error adding department.</p>';
            }
        });

        window.onload = fetchCompaniesAndDepartmentTeams;
    </script>
{% endblock %}