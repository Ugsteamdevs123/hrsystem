{% extends 'base.html' %}
{% block title %}Add Department{% endblock %}

{% block content %}
<div>
    <h1 class="mb-3" style="color:#0d6efd;">Add Department</h1>

    <div style="background:#f8f9fa; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); max-width:600px;">
        <form id="departmentForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

            <div style="margin-bottom:15px;">
                <label for="company-select" style="display:block; margin-bottom:5px;">Select Company</label>
                <select id="company-select" name="company_id" style="width:50%; padding:6px 8px; border-radius:4px; border:1px solid #ced4da;" required onchange="fetchDepartments()">
                    <option value="" selected>Select a company</option>
                </select>
            </div>

            <div style="margin-bottom:15px;">
                <label for="department-name" style="display:block; margin-bottom:5px;">Department Name</label>
                <input type="text" id="department-name" name="name" style="width:50%; padding:6px 8px; border-radius:4px; border:1px solid #ced4da;" required>
            </div>

            <button type="submit" style="padding:8px 16px; border:none; border-radius:5px; background:#0d6efd; color:#fff; cursor:pointer;">Add Department</button>
        </form>

        <div id="form-message" style="margin-top:15px;"></div>

        <div id="departments-table" style="margin-top:20px;">
            <p class="muted">Select a company to view departments.</p>
        </div>
    </div>
</div>

<style>
    /* Custom table styling consistent with base.html */
    .custom-table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
    }
    .custom-table th, .custom-table td {
        min-width: 120px;
        padding: 10px;
        border: 1px solid #dee2e6;
    }
    .custom-table th {
        background-color: #e9ecef;
        font-weight: bold;
        text-align: left;
    }
    .custom-table tr:nth-child(even) { background-color: #f8f9fa; }
    .custom-table tr:nth-child(odd) { background-color: #ffffff; }
    .custom-table .editable-cell {
        background-color: #e6f3ff;
        cursor: text;
    }
    .custom-table .editable-cell:hover { background-color: #cce5ff; }
    .custom-table button {
        padding: 4px 8px;
        margin-right: 5px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-edit { background:#0d6efd; color:#fff; }
    .btn-save { background:#198754; color:#fff; }
    .btn-delete { background:#dc3545; color:#fff; }
</style>

<script>
let selectedDepartmentId = null;

// Fetch companies and populate dropdown
async function fetchCompaniesAndDepartmentTeams() {
    try {
        const response = await fetch("{% url 'get_companies_and_department_teams' %}", {
            method: 'GET',
            headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        });
        if (!response.ok) throw new Error('Failed to fetch companies');

        const data = await response.json();
        const companySelect = document.getElementById('company-select');
        const selectedCompanyId = companySelect.value;
        companySelect.innerHTML = '<option value="" selected>Select a company</option>';
        window.companyData = data.data;

        data.data.forEach(company => {
            companySelect.innerHTML += `<option value="${company.company_id}">${company.company_name}</option>`;
        });

        if (selectedCompanyId) companySelect.value = selectedCompanyId;
        fetchDepartments();

    } catch (error) {
        console.error(error);
        document.getElementById('form-message').innerHTML = '<p style="color:#dc3545;">Error fetching companies.</p>';
    }
}

// Render departments table
function fetchDepartments() {
    const companySelect = document.getElementById('company-select');
    const companyId = companySelect.value;
    const departmentsTable = document.getElementById('departments-table');

    if (!companyId) {
        departmentsTable.innerHTML = '<p class="muted">Select a company to view departments.</p>';
        return;
    }

    const company = window.companyData.find(c => c.company_id == companyId);
    if (!company || !company.departments || company.departments.length === 0) {
        departmentsTable.innerHTML = '<p class="muted">No departments found for this company.</p>';
        return;
    }

    let html = '<h6 style="margin-bottom:10px;">Registered Departments</h6>';
    html += '<table class="custom-table"><thead><tr><th>Department Name</th><th>Actions</th></tr></thead><tbody>';
    company.departments.forEach(dept => {
        html += `<tr data-department-id="${dept.id}">`;
        html += `<td class="editable-cell" contenteditable="false">${dept.name}</td>`;
        html += `<td>`;
        html += `<button class="btn-edit">Edit</button>`;
        html += `<button class="btn-save" style="display:none;">Save</button>`;
        html += `<button class="btn-delete">Delete</button>`;
        html += `</td></tr>`;
    });
    html += '</tbody></table>';
    departmentsTable.innerHTML = html;

    // Edit / Save buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function(){
            const row = this.closest('tr');
            row.querySelector('.editable-cell').contentEditable = 'true';
            row.querySelector('.editable-cell').focus();
            this.style.display = 'none';
            row.querySelector('.btn-save').style.display = 'inline-block';
        });
    });

    document.querySelectorAll('.btn-save').forEach(btn => {
        btn.addEventListener('click', async function(){
            const row = this.closest('tr');
            const id = row.dataset.departmentId;
            const value = row.querySelector('.editable-cell').textContent.trim();
            if (!value) { alert('Department name cannot be empty'); fetchDepartments(); return; }

            try {
                const response = await fetch("{% url 'department_team' %}", {
                    method: 'PATCH',
                    headers: {
                        'X-Requested-With':'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({id, name:value})
                });
                if (!response.ok) throw new Error('Failed to update');
                const result = await response.json();
                if (result.error) { alert(result.error); fetchDepartments(); return; }

                row.querySelector('.editable-cell').contentEditable = 'false';
                this.style.display = 'none';
                row.querySelector('.btn-edit').style.display = 'inline-block';
                fetchCompaniesAndDepartmentTeams();

            } catch(err){ console.error(err); alert('Error updating department'); fetchDepartments(); }
        });
    });

    // Delete buttons
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function(){
            selectedDepartmentId = this.closest('tr').dataset.departmentId;
            showConfirmPopup(
                'Deleting this department will also delete associated increment summaries and employee increment details. Are you sure?',
                async function(){
                    try {
                        const response = await fetch("{% url 'department_team' %}", {
                            method: 'DELETE',
                            headers: {
                                'X-Requested-With':'XMLHttpRequest',
                                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({id:selectedDepartmentId})
                        });
                        if (!response.ok) throw new Error('Failed to delete');
                        const result = await response.json();
                        if (result.error) alert(result.error);
                        fetchCompaniesAndDepartmentTeams();
                    } catch(err){ console.error(err); alert('Error deleting department'); }
                    selectedDepartmentId = null;
                }
            );
        });
    });
}

// Form submission
document.getElementById('departmentForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const companyId = document.getElementById('company-select').value;
    const departmentName = document.getElementById('department-name').value.trim();
    const msg = document.getElementById('form-message');

    if (!companyId) { msg.innerHTML = '<p style="color:#dc3545;">Please select a company.</p>'; return; }
    if (!departmentName) { msg.innerHTML = '<p style="color:#dc3545;">Please enter a department name.</p>'; return; }

    const formData = new FormData(this);
    try {
        const response = await fetch("{% url 'department_team' %}", {
            method:'POST',
            headers:{'X-Requested-With':'XMLHttpRequest'},
            body: formData
        });
        if (!response.ok) throw new Error('Failed to add department');
        const result = await response.json();
        if (result.error) { msg.innerHTML = `<p style="color:#dc3545;">${result.error}</p>`; }
        else {
            msg.innerHTML = '<p style="color:#28a745;">Department added successfully!</p>';
            document.getElementById('department-name').value = '';
            fetchCompaniesAndDepartmentTeams();
        }
    } catch(err){ console.error(err); msg.innerHTML = '<p style="color:#dc3545;">Error adding department.</p>'; }
});

// Initialize
window.onload = fetchCompaniesAndDepartmentTeams;
</script>
{% endblock %}
