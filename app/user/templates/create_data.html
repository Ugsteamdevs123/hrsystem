{% extends 'base.html' %}
{% block title %}Create Data for Department{% endblock %}
{% block content %}
    <div class="container mt-5">
        <h1 class="mb-4 text-primary">Create Data for Department</h1>
        <div class="card shadow-sm p-4 bg-light">
            <form id="createForm">
                <!-- Step 1: Employee -->
                <div id="step1">
                    <h5>Step 1: Create Employee</h5>
                    <div class="mb-3">
                        <label for="fullname" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullname" name="fullname" required>
                    </div>
                    <!-- Add other Employee fields -->
                    <button type="button" class="btn btn-primary" onclick="createEmployee()">Next</button>
                </div>
                <!-- Step 2: CurrentPackageDetails -->
                <div id="step2" style="display: none;">
                    <h5>Step 2: Current Package Details</h5>
                    <div class="mb-3">
                        <label for="gross_salary" class="form-label">Gross Salary</label>
                        <input type="number" class="form-control" id="gross_salary" name="gross_salary" required>
                    </div>
                    <!-- Add other CurrentPackageDetails fields -->
                    <button type="button" class="btn btn-primary" onclick="createCurrentPackage()">Next</button>
                </div>
                <!-- Step 3: ProposedPackageDetails -->
                <div id="step3" style="display: none;">
                    <h5>Step 3: Proposed Package Details</h5>
                    <div class="mb-3">
                        <label for="increment_percentage" class="form-label">Increment Percentage</label>
                        <input type="number" class="form-control" id="increment_percentage" name="increment_percentage" required>
                    </div>
                    <!-- Add other ProposedPackageDetails fields -->
                    <button type="button" class="btn btn-primary" onclick="createProposedPackage()">Next</button>
                </div>
                <!-- Step 4: FinancialImpactPerMonth -->
                <div id="step4" style="display: none;">
                    <h5>Step 4: Financial Impact Per Month</h5>
                    <div class="mb-3">
                        <label for="emp_status" class="form-label">Employee Status</label>
                        <input type="text" class="form-control" id="emp_status" name="emp_status" required>
                    </div>
                    <!-- Add other FinancialImpactPerMonth fields -->
                    <button type="submit" class="btn btn-primary" onclick="createFinancialImpact()">Finish</button>
                </div>
            </form>
            <div id="form-message" class="mt-3"></div>
        </div>
    </div>

    <script>
        let employeeId = null;

        async function createEmployee() {
            const formData = new FormData(document.getElementById('createForm'));
            formData.append('step', 'employee');
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            try {
                const response = await fetch('/pyroll/create-data/{{ department_id }}/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to create employee');
                const result = await response.json();
                if (result.error) {
                    document.getElementById('form-message').innerHTML = `<p class="text-danger">${result.error}</p>`;
                } else {
                    employeeId = result.employee_id;
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error creating employee.</p>';
            }
        }

        async function createCurrentPackage() {
            const formData = new FormData(document.getElementById('createForm'));
            formData.append('step', 'current_package');
            formData.append('employee_id', employeeId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            try {
                const response = await fetch('/pyroll/create-data/{{ department_id }}/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to create current package');
                const result = await response.json();
                if (result.error) {
                    document.getElementById('form-message').innerHTML = `<p class="text-danger">${result.error}</p>`;
                } else {
                    document.getElementById('step2').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error creating current package.</p>';
            }
        }

        async function createProposedPackage() {
            const formData = new FormData(document.getElementById('createForm'));
            formData.append('step', 'proposed_package');
            formData.append('employee_id', employeeId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            try {
                const response = await fetch('/pyroll/create-data/{{ department_id }}/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to create proposed package');
                const result = await response.json();
                if (result.error) {
                    document.getElementById('form-message').innerHTML = `<p class="text-danger">${result.error}</p>`;
                } else {
                    document.getElementById('step3').style.display = 'none';
                    document.getElementById('step4').style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error creating proposed package.</p>';
            }
        }

        async function createFinancialImpact() {
            const formData = new FormData(document.getElementById('createForm'));
            formData.append('step', 'financial_impact');
            formData.append('employee_id', employeeId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            try {
                const response = await fetch('/pyroll/create-data/{{ department_id }}/', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                if (!response.ok) throw new Error('Failed to create financial impact');
                const result = await response.json();
                if (result.error) {
                    document.getElementById('form-message').innerHTML = `<p class="text-danger">${result.error}</p>`;
                } else {
                    document.getElementById('form-message').innerHTML = '<p class="text-success">Data created successfully!</p>';
                    // Reset form or redirect
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('form-message').innerHTML = '<p class="text-danger">Error creating financial impact.</p>';
            }
        }
    </script>