{% extends 'base.html' %}
{% block title %}Group - {{ department.name }}{% endblock %}

{% block content %}
{% if perms.user.view_employee %}
    <div class="container">
        <!-- CSRF token form -->
        <form id="csrf-form" style="display: none;">
            {% csrf_token %}
        </form>

        <!-- Page Heading -->
        <div class="section-head">
            <h2>Group - {{ department.name }}</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; margin-right: 20px;">Fuel Rate: {{ fuel_rate }}</span>
            </div>
        </div>

        <!-- Buttons -->
        <div class="button-group">
            <button type="button" class="form-btn btn-submit" id="saveDraftBtn">Save Draft</button>
        </div>

        </br>

        <!-- Combined Table -->
        <div class="table-wrap">
            <table border="1" cellpadding="8" cellspacing="0" class="custom-table">
                <thead>
                    <tr>
                        <th rowspan="2" class="sticky-col sticky-col-1 sticky-header employee-color">SR.No</th>
                        <th rowspan="2" class="sticky-col sticky-col-2 sticky-header employee-color">Emp ID</th>
                        <th rowspan="2" class="sticky-col sticky-col-3 sticky-header employee-color">Full Name</th>
                        <th rowspan="2" class="sticky-col sticky-col-4 sticky-header employee-color">Designation</th>
                        <!-- Employee Details -->
                        <th colspan="9" class="group-header non-sticky-header employee-color">Employee Details</th>
                        <!-- Current Package -->
                        <th colspan="6" class="group-header non-sticky-header current-package-color">Current Package</th>
                        <!-- Proposed Package -->
                        <th colspan="9" class="group-header non-sticky-header proposed-package-color">Proposed Package</th>
                        <!-- Financial Impact -->
                        <th colspan="8" class="group-header non-sticky-header financial-impact-color">Financial Impact</th>
                        <!-- Dynamic Attributes group header -->
                        {% if employees.0.dynamic_attributes|length > 0 %}
                            <th colspan="{{ employees.0.dynamic_attributes|length }}" class="group-header non-sticky-header dynamic-attributes-color">Dynamic Columns</th>
                        {% endif %}
                    </tr>
                    <tr>
                        <!-- Employee Details Subheaders -->
                        <th class="non-sticky-header employee-color">Eligible For Increment</th>
                        <th class="non-sticky-header employee-color">Department Group</th>
                        <th class="non-sticky-header employee-color">Department</th>
                        <th class="non-sticky-header employee-color">Section</th>
                        <th class="non-sticky-header employee-color">Location</th>
                        <th class="non-sticky-header employee-color">Date of Joining</th>
                        <th class="non-sticky-header employee-color">Resign</th>
                        <th class="non-sticky-header employee-color">Date of Resignation</th>
                        <th class="non-sticky-header employee-color">Remarks</th>
                        <!-- Current Package Subheaders -->
                        <th class="non-sticky-header current-package-color">Gross Salary</th>
                        <th class="non-sticky-header current-package-color">Company Pickup</th>
                        <th class="non-sticky-header current-package-color">Vehicle</th>
                        <th class="non-sticky-header current-package-color">Fuel Allowance</th>
                        <th class="non-sticky-header current-package-color">Fuel Litre</th>
                        <th class="non-sticky-header current-package-color">Mobile Provided</th>
                        <!-- Proposed Package Subheaders -->
                        <th class="non-sticky-header proposed-package-color">Increment Percentage</th>
                        <th class="non-sticky-header proposed-package-color">Increased Amount</th>
                        <th class="non-sticky-header proposed-package-color">Revised Salary</th>
                        <th class="non-sticky-header proposed-package-color">Increased Fuel Allowance</th>
                        <th class="non-sticky-header proposed-package-color">Increased Fuel Litre</th>
                        <th class="non-sticky-header proposed-package-color">Revised Fuel Allowance</th>
                        <th class="non-sticky-header proposed-package-color">Mobile Provided</th>
                        <th class="non-sticky-header proposed-package-color">Company Pickup</th>
                        <th class="non-sticky-header proposed-package-color">Vehicle</th>
                        <!-- Financial Impact Subheaders -->
                        <th class="non-sticky-header financial-impact-color">Employee Status</th>
                        <th class="non-sticky-header financial-impact-color">Serving Years</th>
                        <th class="non-sticky-header financial-impact-color">Salary</th>
                        <th class="non-sticky-header financial-impact-color">Gratuity</th>
                        <th class="non-sticky-header financial-impact-color">Bonus</th>
                        <th class="non-sticky-header financial-impact-color">Leave Encashment</th>
                        <th class="non-sticky-header financial-impact-color">Fuel</th>
                        <th class="non-sticky-header financial-impact-color">Total</th>
                        <!-- Dynamic Attributes Subheaders -->
                        {% for attr in employees.0.dynamic_attributes %}
                            <th class="group-header non-sticky-header dynamic-attributes-color">
                                {{ attr.display_name }}
                                <button class="edit-dynamic-btn" data-key="{{ attr.key }}" data-display-name="{{ attr.display_name }}" data-type="{{ attr.data_type }}" data-editable="{{ attr.inline_editable }}" title="Edit Column">âœŽ</button>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                        <tr data-employee-id="{{ employee.emp_id }}" data-past-six-months="{{ employee.past_six_months|yesno:'true,false' }}" class="{% if employee.is_draft %}draft-row{% endif %}">
                            <td class="sticky-col sticky-col-1">{{ forloop.counter }}</td>
                            <td class="sticky-col sticky-col-2">{{ employee.emp_id|default:"-" }}</td>
                            <td class="sticky-col sticky-col-3">{{ employee.fullname|default:"-" }}</td>
                            <td class="sticky-col sticky-col-4 editable" data-tab="Employee" data-field="designation_id" data-type="select" data-endpoint="/payroll/designations/?company_id={{ department.company.id }}">{{ employee.designation.title|default:"-" }}</td>
                            <!-- Employee Details -->
                            <td class="non-sticky editable" data-tab="Employee" data-field="eligible_for_increment" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ employee.eligible_for_increment|yesno:"Yes,No,-" }}</td>
                            <td class="non-sticky">{{ employee.department_team.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.department_group.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.section.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.location.location|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.date_of_joining|date:"Y-m-d"|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.resign|yesno:"Yes,No,-" }}</td>
                            <td class="non-sticky">{{ employee.date_of_resignation|date:"Y-m-d"|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.remarks|default:"-" }}</td>
                            <!-- Current Package -->
                            {% with current_package=employee.currentpackagedetails %}
                                <td class="non-sticky" data-tab="CurrentPackageDetails" data-field="gross_salary">{{ current_package.gross_salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.company_pickup|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky">{{ current_package.vehicle|default:"-" }}</td>
                                <td class="non-sticky" data-tab="CurrentPackageDetails" data-field="fuel_allowance">{{ current_package.fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.fuel_litre|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                            {% endwith %}
                            <!-- Proposed Package -->
                            {% with proposed_package=employee.proposedpackagedetails %}
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="increment_percentage" data-type="number" data-step="0.01">{{ proposed_package.increment_percentage|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="ProposedPackageDetails" data-field="increased_amount">{{ proposed_package.increased_amount|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="ProposedPackageDetails" data-field="revised_salary">{{ proposed_package.revised_salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="increased_fuel_allowance" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="increased_fuel_litre" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_litre|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="ProposedPackageDetails" data-field="revised_fuel_allowance">{{ proposed_package.revised_fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="mobile_provided" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="company_pickup" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.company_pickup|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky editable" data-tab="ProposedPackageDetails" data-field="vehicle_id" data-type="select" data-endpoint="/payroll/vehicles-dropdown/">{{ proposed_package.vehicle|default:"-" }}</td>
                            {% endwith %}
                            <!-- Financial Impact -->
                            {% with financial_impact=employee.financialimpactpermonth %}
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="emp_status">{{ financial_impact.emp_status.status|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.serving_years|floatformat:1|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="salary">{{ financial_impact.salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="gratuity">{{ financial_impact.gratuity|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="bonus">{{ financial_impact.bonus|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="leave_encashment">{{ financial_impact.leave_encashment|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="fuel">{{ financial_impact.fuel|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky" data-tab="FinancialImpactPerMonth" data-field="total">{{ financial_impact.total|floatformat:2|default:"-" }}</td>
                            {% endwith %}
                            <!-- Dynamic Attributes -->
                            {% for attr in employee.dynamic_attributes %}
                                <td class="non-sticky {% if attr.inline_editable %}editable{% endif %}"
                                    data-dynamic="true"
                                    data-tab="DynamicAttribute"
                                    data-field="{{ attr.key }}"
                                    {% if attr.data_type == 'number' %}
                                        data-type="number"
                                        >{{ attr.value|default_if_none:"-"|floatformat:2 }}</td>
                                    {% elif attr.data_type == 'date' %}
                                        >{{ attr.value|default_if_none:"-"|date:"Y-m-d" }}</td>
                                    {% else %}
                                        >{{ attr.value|default:"-" }}</td>
                                    {% endif %}
                            {% endfor %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="42" style="text-align: center;">No employees found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="btn-add-dynamic-backgorund">
                <button type="button" class="form-btn btn-add-dynamic" id="addDynamicAttributeBtn" title="Add New Column">+</button>
            </div>
        </div>

        <!-- Add Dynamic Attribute Modal -->
        <div id="addDynamicAttributeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Add New Column</h3>
                <form id="addDynamicAttributeForm">
                    <input type="hidden" name="company_id" value="{{ department.company.id }}">
                    <input type="hidden" name="department_team_id" value="{{ department_id }}">
                    <div class="form-group">
                        <label for="attribute_mode">Column Creation Mode:</label>
                        <select id="attribute_mode" name="attribute_mode" required onchange="toggleAttributeMode()">
                            <option value="new">Create New Column</option>
                            <option value="existing">Select Existing Column (from other groups)</option>
                        </select>
                    </div>
                    <div id="new_attribute_group" class="form-group">
                        <label for="attribute_name">Column Name:</label>
                        <input type="text" id="attribute_name" name="attribute_name" required>
                        <label for="data_type" class="form-elements">Data Type:</label>
                        <select id="data_type" name="data_type" required>
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="boolean">Boolean</option>
                        </select>
                        <label for="inline_editable" class="form-elements">Inline Editable:</label>
                        <select id="inline_editable" name="inline_editable" required>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div id="existing_attribute_group" class="form-group" style="display: none;">
                        <label for="existing_field_reference_id">Select Existing Column:</label>
                        <select id="existing_field_reference_id" name="existing_field_reference_id">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="form-btn btn-submit">Add Attribute</button>
                        <button type="button" class="form-btn btn-back" onclick="document.getElementById('addDynamicAttributeModal').style.display='none';">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Dynamic Attribute Modal -->
        <div id="editDynamicAttributeModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Edit Column</h3>
                <form id="editDynamicAttributeForm">
                    <input type="hidden" name="key" id="edit_attribute_key">
                    <input type="hidden" name="company_id" value="{{ department.company.id }}">
                    <input type="hidden" name="department_team_id" value="{{ department_id }}">
                    <div class="form-group">
                        <label for="edit_attribute_name">Column Name:</label>
                        <input type="text" id="edit_attribute_name" name="attribute_name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit_data_type">Data Type:</label>
                        <select id="edit_data_type" name="data_type" required>
                            <option value="text">Text</option>
                            <option value="number">Number</option>
                            <option value="date">Date</option>
                            <option value="boolean">Boolean</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit_inline_editable">Inline Editable:</label>
                        <select id="edit_inline_editable" name="inline_editable" required>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="form-btn btn-submit">Update Attribute</button>
                        <button type="button" class="form-btn btn-back" onclick="document.getElementById('editDynamicAttributeModal').style.display='none';">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .dynamic-attributes-color {
            background-color: #01d6f3;
        }
        .employee-color {
            background-color: #6495ed;
        }
        .current-package-color {
            background-color: #b2a1c7;
        }
        .proposed-package-color {
            background-color: #f2dbdb;
        }
        .financial-impact-color {
            background-color: #31859b;
        }
        .container {
            overflow: hidden !important;
            padding: 20px;
        }
        .content {
            overflow: hidden !important;
        }
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-head h2 {
            margin: 0;
            font-size: 24px;
            color: #343a40;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .table-wrap {
            display: flex;
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            -webkit-clip-path: inset(0);
            clip-path: inset(0);
        }
        .custom-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px;
            table-layout: auto;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            background-color: inherit;
        }
        th {
            font-weight: 600;
        }
        th[rowspan="2"] {
            vertical-align: middle;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: #f2f2f2 !important;
        }
        .sticky-col {
            position: sticky;
            z-index: 30;
            background-color: #ffffff !important;
        }
        .sticky-col.sticky-header {
            z-index: 50;
            background-color: #6495ed !important;
        }
        .non-sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        .non-sticky {
            z-index: 5;
        }
        th.group-header {
            text-align: center;
            position: relative;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f3f5;
        }
        .draft-row {
            border-left: 4px solid #ffc107;
        }
        .editable.eligible {
            background-color: #e6ffe6 !important;
        }
        .editable.edited {
            background-color: #fff3cd !important;
        }
        .edited-row {
            background-color: #fff3cd !important;
        }
        .form-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            text-decoration: none;
        }
        .btn-submit {
            background-color: #28a745;
            color: #fff;
        }
        .btn-submit:hover {
            background-color: #218838;
        }
        .btn-add-dynamic-backgorund {
            background-color: #00ccff7c;
        }
        .btn-add-dynamic {
            background-color: #17a2b8;
            color: #fff;
            font-size: 18px;
            width: 25px;
            height: 25px;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 8px;
            margin-top: 8px;
            cursor: pointer;
            font-size: 12px;
            vertical-align: middle;
        }
        .btn-add-dynamic:hover {
            background-color: #138496;
        }
        .edit-dynamic-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 12px;
            vertical-align: middle;
        }
        .edit-dynamic-btn:hover {
            background-color: #0056b3;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: min(500px, 90vw);
            max-height: 80vh;
            overflow-y: auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-elements {
            margin-top: 15px;
        }
        .editable select, .editable input, .editable textarea {
							
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .editable textarea {
            min-height: 60px;
            resize: vertical;
        }
        .confirm-popup {
            background: #fff;
            width: min(960px, 94vw);
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            padding: 16px;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .confirm-popup p {
            margin: 0 0 20px;
            font-size: 16px;
        }
        .confirm-popup .form-btn {
            min-width: 100px;
        }
        .sticky-col-1 { width: 60px; }
        .sticky-col-2 { width: 100px; }
        .sticky-col-3 { width: 150px; }
        .sticky-col-4 { width: 120px; }
        .non-sticky {
            min-width: 100px;
        }
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            th, td {
                font-size: 14px;
                padding: 6px;
            }
            .form-btn, .edit-dynamic-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
            .sticky-col-3, .sticky-col-4 {
                white-space: normal;
                width: 100px;
            }
        }
        @media screen and (max-width: 500px) {
            .form-btn {
                font-size: 12px;
                padding: 10px;
            }
            .modal-content {
                width: 90vw;
            }
        }
    </style>

    <script>
    const editedCells = {};
    const draftData = {{ draft_data|safe }};

    // Toggle between new and existing attribute fields
    function toggleAttributeMode() {
        const mode = document.getElementById('attribute_mode').value;
        const newGroup = document.getElementById('new_attribute_group');
        const existingGroup = document.getElementById('existing_attribute_group');
        const existingSelect = document.getElementById('existing_field_reference_id');
        const attributeName = document.getElementById('attribute_name');
        const dataType = document.getElementById('data_type');
        const inlineEditable = document.getElementById('inline_editable');

        if (mode === 'existing') {
            newGroup.style.display = 'none';
            existingGroup.style.display = 'block';
            existingSelect.required = true;
            attributeName.required = false;
            dataType.required = false;
            inlineEditable.required = false;
        } else {
            newGroup.style.display = 'block';
            existingGroup.style.display = 'none';
            existingSelect.required = false;
            attributeName.required = true;
            dataType.required = true;
            inlineEditable.required = true;
        }
    }

    // Fetch existing dynamic attributes from other departments
    async function fetchExistingDynamicAttributes() {
        const select = document.getElementById('existing_field_reference_id');
        select.innerHTML = '<option value="">Loading...</option>';
        try {
            const res = await fetchJSON(`/payroll/get-dynamic-attributes/?company_id={{ department.company.id }}&department_team_id={{ department_id }}`);
            select.innerHTML = '<option value="">Select an attribute</option>';
            res.forEach(attr => {
                const option = document.createElement('option');
                option.value = attr.field_reference_id;
                option.textContent = `${attr.display_name} (${attr.key}) - Type: ${attr.data_type}, Editable: ${attr.inline_editable ? 'Yes' : 'No'}`;
                select.appendChild(option);
            });
            if (res.length === 0) {
                select.innerHTML = '<option value="">No existing attributes available</option>';
            }
        } catch (e) {
            showSnackbar('Failed to load existing dynamic columns', '#dc3545');
            select.innerHTML = '<option value="">Error loading columns</option>';
        }
    }

    async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                },
                signal: controller.signal,
                ...opts
            });
            clearTimeout(timeoutId);
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`HTTP error! Status: ${res.status}, Response: ${errorText}`);
            }
            return await res.json();
        } catch (err) {
            clearTimeout(timeoutId);
            console.error(`Error fetching ${url}:`, err);
            showSnackbar(`Error: ${err.message}`, '#dc3545');
            throw err;
        }
    }

    function asArray(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.data)) return payload.data;
        if (payload && Array.isArray(payload.results)) return payload.results;
        if (payload && Array.isArray(payload.items)) return payload.items;
        return [];
    }

    function isEligibleForIncrement(row, employeeId) {
        const eligibleCell = row.querySelector('[data-tab="Employee"][data-field="eligible_for_increment"]');
        // let eligibleValue = eligibleCell.dataset.original || eligibleCell.textContent;
        let eligibleValue = eligibleCell.textContent;
        if (draftData[employeeId]?.employee?.eligible_for_increment) {
            eligibleValue = draftData[employeeId].employee.eligible_for_increment;
        }
        if (editedCells[employeeId]?.employee?.eligible_for_increment) {
            eligibleValue = editedCells[employeeId].employee.eligible_for_increment;
        }
        return eligibleValue === 'true' || eligibleValue === 'Yes';
    }

    function hasPastSixMonths(row, employeeId) {
        let pastSixMonths = row.dataset.pastSixMonths;
        if (draftData[employeeId]?.employee?.past_six_months) {
            pastSixMonths = draftData[employeeId].employee.past_six_months;
        }
        if (editedCells[employeeId]?.employee?.past_six_months) {
            pastSixMonths = editedCells[employeeId].employee.past_six_months;
        }
        return pastSixMonths === 'true';
    }

    function updateRowEditability(row) {
        const employeeId = row.dataset.employeeId;
        const isEligible = isEligibleForIncrement(row, employeeId);
        row.querySelectorAll('.editable').forEach(cell => {
            if (cell.dataset.field !== 'eligible_for_increment' && cell.dataset.field !== 'designation_id') {
                cell.classList.toggle('eligible', isEligible);
            } else {
                cell.classList.add('eligible');
            }
        });
    }

    async function makeEditable(cell) {
        if (!cell.classList.contains('editable') || !cell.classList.contains('eligible')) {
            return;
        }
        const field = cell.dataset.field;
        const type = cell.dataset.type;
        const employeeId = cell.parentElement.dataset.employeeId;
        const tab = cell.dataset.tab;
        const endpoint = cell.dataset.endpoint;
        const options = cell.dataset.options ? JSON.parse(cell.dataset.options) : null;
        const depends = cell.dataset.depends;
        const step = cell.dataset.step || 'any';

        if (cell.querySelector('input, select, textarea')) {
            return;
        }

        let input;
        if (type === 'select') {
            input = document.createElement('select');
            if (options) {
                if (field === 'eligible_for_increment' && hasPastSixMonths(cell.parentElement, employeeId)) {
                    input.innerHTML = '<option value="true">Yes</option>';
                } else {
                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label;
                        input.appendChild(option);
                    });
                }
            } else if (endpoint) {
                try {
                    const data = await fetchJSON(endpoint);
                    const items = asArray(data);
                    input.innerHTML = '<option value="">Select</option>';
                    if (field === 'department_group_id') {
                        window.departmentGroups = items.map(dept => ({
                            id: dept.id,
                            name: dept.name,
                            sections: dept.sections || []
                        }));
                        items.forEach(dept => {
                            const opt = document.createElement('option');
                            opt.value = dept.id;
                            opt.textContent = dept.name;
                            input.appendChild(opt);
                        });
                    } else if (field === 'section_id' && depends) {
                        const groupId = cell.parentElement.querySelector(`[data-tab="Employee"][data-field="${depends}"] select`)?.value;
                        if (groupId && window.departmentGroups) {
                            const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
                            if (group && group.sections) {
                                group.sections.forEach(section => {
                                    const opt = document.createElement('option');
                                    opt.value = section.id;
                                    opt.textContent = section.name;
                                    input.appendChild(opt);
                                });
                            }
                        }
                    } else {
                        items.forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.id;
                            opt.textContent = field === 'vehicle_id' ? item.label : (item.title || item.location || item.status || item.name);
                            input.appendChild(opt);
                        });
                    }
                } catch (e) {
                    showSnackbar('Failed to load dropdown options', '#dc3545');
                    return;
                }
            }
            input.value = cell.dataset.originalId || cell.dataset.original || '';
        } else if (type === 'textarea') { 
            input = document.createElement('textarea');
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        } else {
            input = document.createElement('input');
            input.type = type;
            if (type === 'number') input.step = step;
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        }
        
        cell.textContent = '';
        cell.appendChild(input);
        input.focus();

        input.addEventListener('blur', () => {
            let displayText = input.value.trim() || '-';
            let value = input.value.trim();
            let effectiveField = field;

            if (cell.dataset.dynamic === 'true') {
                effectiveField = `dynamic_attribute__${field}`;
            }
            
            if (field === 'eligible_for_increment' && hasPastSixMonths(cell.parentElement, employeeId) && value === 'false') {
                showSnackbar('Cannot set Eligible for Increment to No when Past Six Months is true', '#dc3545');
                value = 'true';
                displayText = 'Yes';
                input.value = 'true';
            }

            if (type === 'select' && input.selectedIndex >= 0) {
                displayText = input.options[input.selectedIndex].text || '-';
            }
            
            cell.textContent = displayText;
            const originalValue = type === 'select' ? (cell.dataset.originalId || cell.dataset.original || '-') : (cell.dataset.original || '-');
            const isChanged = value !== originalValue;
            cell.classList.toggle('edited', isChanged);
            if (!isChanged && cell.dataset.hasDraft === 'true') {
                cell.classList.add('edited');
            }
            
            if (!editedCells[employeeId]) editedCells[employeeId] = {};
            if (!editedCells[employeeId][tab]) editedCells[employeeId][tab] = {};
            
            if (value && value !== '-') {
                editedCells[employeeId][tab][effectiveField] = value;
            } else {
                if (cell.dataset.hasDraft !== 'true') {
                    delete editedCells[employeeId][tab][effectiveField];
                    if (Object.keys(editedCells[employeeId][tab]).length === 0) {
                        delete editedCells[employeeId][tab];
                    }
                    if (Object.keys(editedCells[employeeId]).length === 0) {
                        delete editedCells[employeeId];
                    }
                }
            }
            const row = cell.parentElement;
            const hasEdits = Object.keys(editedCells[employeeId] || {}).some(tab => Object.keys(editedCells[employeeId][tab]).length > 0);
            row.classList.toggle('edited-row', hasEdits);

            if (field === 'eligible_for_increment') {
                updateRowEditability(row);
            }

            if (field === 'increment_percentage' || field === 'increased_fuel_allowance' || field === 'increased_fuel_litre' || field === 'vehicle_id' || field === "revised_salary" || effectiveField.startsWith("dynamic_attribute__")) {
                recalcValues(row);
            }
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') input.blur();
        });
    }

    async function saveDraft() {
        if (Object.keys(editedCells).length === 0) {
            showSnackbar('No changes to save', '#dc3545');
            return;
        }
        Object.keys(editedCells).forEach(empId => {
            if (editedCells[empId].employee && editedCells[empId].employee.designation_id) {
                editedCells[empId].employee.designation_id = parseInt(editedCells[empId].employee.designation_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.department_group_id) {
                editedCells[empId].employee.department_group_id = parseInt(editedCells[empId].employee.department_group_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.section_id) {
                editedCells[empId].employee.section_id = parseInt(editedCells[empId].employee.section_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.location_id) {
                editedCells[empId].employee.location_id = parseInt(editedCells[empId].employee.location_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.vehicle_id) {
                editedCells[empId].current_package.vehicle_id = parseInt(editedCells[empId].current_package.vehicle_id, 10);
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.vehicle_id) {
                editedCells[empId].proposed_package.vehicle_id = parseInt(editedCells[empId].proposed_package.vehicle_id, 10);
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.revised_salary) {
                editedCells[empId].proposed_package.revised_salary = parseInt(editedCells[empId].proposed_package.revised_salary, 10);
            }
            if (editedCells[empId].financial_impact && editedCells[empId].financial_impact.emp_status_id) {
                editedCells[empId].financial_impact.emp_status_id = parseInt(editedCells[empId].financial_impact.emp_status_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.company_pickup) {
                editedCells[empId].current_package.company_pickup = editedCells[empId].current_package.company_pickup === 'true';
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.company_pickup) {
                editedCells[empId].proposed_package.company_pickup = editedCells[empId].proposed_package.company_pickup === 'true';
            }
        });
        try {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (!csrfInput || !csrfInput.value) {
                showSnackbar('CSRF token missing or invalid', '#dc3545');
                throw new Error('CSRF token missing or invalid');
            }
            const res = await fetch(`/payroll/save-draft/{{ department_id }}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfInput.value,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(editedCells),
            });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to save draft: ${res.status}, Response: ${errorText}`);
            }
            const result = await res.json();
            if (result.error) {
                showSnackbar(result.error, '#dc3545');
            } else {
                showSpinner();
                showSnackbar('Draft saved successfully', '#28a745');
                Object.keys(editedCells).forEach(empId => {
                    Object.keys(editedCells[empId]).forEach(tab => {
                        Object.keys(editedCells[empId][tab]).forEach(field => {
                            const cell = document.querySelector(`tr[data-employee-id="${empId}"] [data-tab="${tab}"][data-field="${field}"]`);
                            if (cell) {
                                if (cell.dataset.type === 'select') {
                                    cell.dataset.originalId = editedCells[empId][tab][field];
                                } else {
                                    cell.dataset.original = editedCells[empId][tab][field];
                                }
                                cell.classList.remove('edited');
                            }
                        });
                    });
                });
                document.querySelectorAll('tr.edited-row').forEach(row => row.classList.remove('edited-row'));
                document.querySelectorAll('tr[data-employee-id]').forEach(row => updateRowEditability(row));
            }
        } catch (e) {
            showSnackbar(`Error saving draft: ${e.message}`, '#dc3545');
        }
    }

    function showSnackbar(message, bgColor) {
        const snackbar = document.createElement('div');
        snackbar.textContent = message;
        snackbar.style.position = 'fixed';
        snackbar.style.bottom = '20px';
        snackbar.style.left = '50%';
        snackbar.style.transform = 'translateX(-50%)';
        snackbar.style.backgroundColor = bgColor;
        snackbar.style.color = '#fff';
        snackbar.style.padding = '12px 24px';
        snackbar.style.borderRadius = '6px';
        snackbar.style.zIndex = '1000';
        document.body.appendChild(snackbar);
        setTimeout(() => snackbar.remove(), 3000);
    }

    function showSpinner() {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '50%';
        spinner.style.left = '50%';
        spinner.style.transform = 'translate(-50%, -50%)';
        spinner.style.width = '40px';
        spinner.style.height = '40px';
        spinner.style.border = '4px solid #f3f3f3';
        spinner.style.borderTop = '4px solid #3498db';
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'spin 1s linear infinite';
        document.body.appendChild(spinner);
        setTimeout(() => spinner.remove(), 1000);
    }

    function getValueFromRow(row, model, field) {
        if (model == "Configurations") {
            return configurations[field.trim().toLowerCase().replaceAll(' ', '_')];
        } else {
            const selector = `[data-tab="${model}"][data-field="${field.trim().toLowerCase().replaceAll(' ', '_')}"]`;
            const cell = row.querySelector(selector);
            if (!cell) return 0;
            const val = cell.textContent?.trim() || cell.value || '0';
            return parseFloat(val) || 0;
        }
    }

    function recalcValues(row) {
        console.log('sjsj');
        const IncreasedFuelAllowance = row.querySelector('[data-tab="ProposedPackageDetails"][data-field="increased_fuel_allowance"]');
        const IncreasedFuelLitre = row.querySelector('[data-tab="ProposedPackageDetails"][data-field="increased_fuel_litre"]');
        
        if (IncreasedFuelLitre.textContent > 0) {
            IncreasedFuelAllowance.textContent = (parseFloat(configurations['fuel_rate']) * parseFloat(IncreasedFuelLitre.textContent)).toFixed(2);
        }

        const FinancialEmployeeStatus = row.querySelector('[data-tab="FinancialImpactPerMonth"][data-field="emp_status"]');
        
        fieldFormulas.forEach((formula) => {
            if (FinancialEmployeeStatus.textContent != 'P' && formula.target_field.trim().toLowerCase().replaceAll(' ', '_') == 'gratuity') {
                return;
            }
            let expression = formula.formula_expression;
            const regex = /\[([^\]:]+):\s*([^\]]+)\]/g;
            expression = expression.replace(regex, (_, model, field) => {
                const value = getValueFromRow(row, model, field);
                return value;
            });
            let result = 0;
            try {
                result = eval(expression);
            } catch (e) {
                console.error("Failed to evaluate formula:", formula.formula_name, e);
            }
            console.log(formula.target_field.trim().toLowerCase().replace('dynamic_attribute__', '').replaceAll(' ', '_'));
            const targetSelector = `[data-tab="${formula.target_model}"][data-field="${formula.target_field.trim().toLowerCase().replace('dynamic_attribute__', '').replaceAll(' ', '_')}"]`;
            console.log(targetSelector);
            console.log("result: ", result);
            const targetCell = row.querySelector(targetSelector);
            if (targetCell) {
                targetCell.textContent = result.toFixed(2);
            } else {
                console.warn("Target cell not found for formula:", formula.formula_name);
            }
        });
    }

    let fieldFormulas = [];
    let configurations = [];
    document.addEventListener('DOMContentLoaded', () => {
        fetch(`/payroll/get-formulas/?department_team_id={{department_id}}`)
            .then(res => res.json())
            .then(data => {
                fieldFormulas = data.field_formulas_data.map(item => item.formula);
                configurations = data.configurations_data;
            });

        const table = document.querySelector('.custom-table');
        const headerRows = table.querySelectorAll('thead tr');
        const bodyRows = table.querySelectorAll('tbody tr');

        const setStickyOffsets = () => {
            const stickyColumns = [1, 2, 3, 4];
            let cumulativeLeft = 0;
            stickyColumns.forEach((colIndex) => {
                const headerCell = headerRows[0].querySelector(`th.sticky-col-${colIndex}`);
                if (headerCell) {
                    const width = headerCell.offsetWidth;
                    const className = `.sticky-col-${colIndex}`;
                    document.querySelectorAll(className).forEach(cell => {
                        cell.style.left = `${cumulativeLeft}px`;
                    });
                    cumulativeLeft += width;
                }
            });
        };

        setStickyOffsets();
        window.addEventListener('resize', setStickyOffsets);

        document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);

        // Add Dynamic Attribute
        document.getElementById('addDynamicAttributeBtn').addEventListener('click', () => {
            document.getElementById('addDynamicAttributeModal').style.display = 'flex';
            fetchExistingDynamicAttributes();
            toggleAttributeMode(); // Default to 'new' mode
        });

        document.getElementById('addDynamicAttributeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            try {
                const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfInput || !csrfInput.value) {
                    showSnackbar('CSRF token missing or invalid', '#dc3545');
                    throw new Error('CSRF token missing or invalid');
                }
                const res = await fetch('/payroll/create-dynamic-attribute/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfInput.value,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData,
                });
                const result = await res.json();
                if (res.ok) {
                    showSnackbar('New Column added successfully', '#28a745');
                    showSpinner();
                    setTimeout(() => window.location.reload(), 1000); // Reload to reflect new column
                } else {
                    showSnackbar(result.error || 'Failed to add new column', '#dc3545');
                }
            } catch (e) {
                showSnackbar(`Error: ${e.message}`, '#dc3545');
            }
            form.reset();
            document.getElementById('addDynamicAttributeModal').style.display = 'none';
        });

        // Edit Dynamic Attribute
        document.querySelectorAll('.edit-dynamic-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = document.getElementById('editDynamicAttributeModal');
                const form = document.getElementById('editDynamicAttributeForm');
                form.querySelector('#edit_attribute_key').value = btn.dataset.key;
                form.querySelector('#edit_attribute_name').value = btn.dataset.displayName;
                form.querySelector('#edit_data_type').value = btn.dataset.type;
                form.querySelector('#edit_inline_editable').value = btn.dataset.editable.toLowerCase();
                modal.style.display = 'flex';
            });
        });

        document.getElementById('editDynamicAttributeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            try {
                const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfInput || !csrfInput.value) {
                    showSnackbar('CSRF token missing or invalid', '#dc3545');
                    throw new Error('CSRF token missing or invalid');
                }
                const res = await fetch('/payroll/edit-dynamic-attribute/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfInput.value,
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: formData,
                });
                const result = await res.json();
                if (res.ok) {
                    showSnackbar('Column updated successfully', '#28a745');
                    showSpinner();
                    setTimeout(() => window.location.reload(), 1000); // Reload to reflect changes
                } else {
                    showSnackbar(result.error || 'Failed to update column', '#dc3545');
                }
            } catch (e) {
                showSnackbar(`Error: ${e.message}`, '#dc3545');
            }
            form.reset();
            document.getElementById('editDynamicAttributeModal').style.display = 'none';
        });

        bodyRows.forEach(row => {
            updateRowEditability(row);
            row.querySelectorAll('.editable').forEach(cell => {
                cell.dataset.original = cell.textContent;
                if (cell.dataset.type === 'select') {
                    const employeeId = cell.parentElement.dataset.employeeId;
                    const tab = cell.dataset.tab;
                    const field = cell.dataset.field;
                    const draftValue = draftData[employeeId]?.[tab]?.[field];
                    cell.dataset.originalId = draftValue || (field === 'designation_id' ? '{{ employee.designation.id|default:"" }}' : '');
                    if (draftValue && cell.dataset.endpoint) {
                        fetchJSON(cell.dataset.endpoint).then(data => {
                            const items = asArray(data);
                            const item = items.find(i => i.id == draftValue);
                            if (item) {
                                cell.textContent = field === 'vehicle_id' ? item.label : (item.title || item.location || item.status || item.name);
                            }
                            updateRowEditability(row);
                        });
                    }
                }
                cell.addEventListener('click', () => {
                    makeEditable(cell);
                });
            });
        });

        Object.keys(draftData).forEach(empId => {
            editedCells[empId] = JSON.parse(JSON.stringify(draftData[empId]));
            const row = document.querySelector(`tr[data-employee-id="${empId}"]`);
            if (row) {
                ['employee', 'current_package', 'proposed_package', 'financial_impact'].forEach(tab => {
                    const draftDataTab = draftData?.[empId]?.[tab] || {};
                    Object.keys(draftDataTab).forEach(field => {
                        const cell = row.querySelector(`[data-tab="${tab}"][data-field="${field}"]`);
                        if (cell) {
                            cell.classList.add('edited');
                            cell.dataset.hasDraft = 'true';
                            row.classList.add('edited-row');
                        }
                    });
                });
                updateRowEditability(row);
            }
        });
    });
    </script>
{% else %}
    <p>You do not have permission to view this page.</p>
{% endif %}
{% endblock %}