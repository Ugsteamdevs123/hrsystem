{% extends 'base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
{% if perms.user.view_employee %}
    <div class="container">
        <!-- CSRF token form -->
        <form id="csrf-form" style="display: none;">
            {% csrf_token %}
        </form>

        <!-- Page Heading -->
        <div class="section-head">
            <h2>Department â€” {{ department.name }}</h2>
        </div>

        <!-- Buttons -->
        <div class="button-group">
            <button type="button" class="form-btn btn-submit" id="saveDraftBtn">Save Draft</button>
        </div>

        </br>

        <!-- Combined Table -->
        <div class="table-wrap">
            <table border="1" cellpadding="8" cellspacing="0" class="custom-table">
                <thead>
                    <tr>
                        <th rowspan="2" class="sticky-col sticky-col-1 sticky-header">SR.No</th>
                        <th rowspan="2" class="sticky-col sticky-col-2 sticky-header">Employee ID</th>
                        <th rowspan="2" class="sticky-col sticky-col-3 sticky-header">Full Name</th>
                        <th rowspan="2" class="sticky-col sticky-col-4 sticky-header">Designation</th>
                        <!-- Employee Details -->
                        <th colspan="9" class="group-header non-sticky-header">Employee Details</th>
                        <!-- Current Package -->
                        <th colspan="6" class="group-header non-sticky-header">Current Package</th>
                        <!-- Proposed Package -->
                        <th colspan="9" class="group-header non-sticky-header">Proposed Package</th>
                        <!-- Financial Impact -->
                        <th colspan="9" class="group-header non-sticky-header">Financial Impact</th>
                    </tr>
                    <tr>
                        <!-- Employee Details Subheaders -->
                        <th class="non-sticky-header">Eligible For Increment</th>
                        <th class="non-sticky-header">Department Group</th>
                        <th class="non-sticky-header">Department</th>
                        <th class="non-sticky-header">Section</th>
                        <th class="non-sticky-header">Location</th>
                        <th class="non-sticky-header">Date of Joining</th>
                        <th class="non-sticky-header">Resign</th>
                        <th class="non-sticky-header">Date of Resignation</th>
                        <th class="non-sticky-header">Remarks</th>
                        <!-- Current Package Subheaders -->
                        <th class="non-sticky-header">Gross Salary</th>
                        <th class="non-sticky-header">Company Pickup</th>
                        <th class="non-sticky-header">Vehicle</th>
                        <th class="non-sticky-header">Fuel Allowance</th>
                        <th class="non-sticky-header">Fuel Litre</th>
                        <th class="non-sticky-header">Mobile Provided</th>
                        {# <th class="non-sticky-header">Total</th> #}
                        <!-- Proposed Package Subheaders -->
                        <th class="non-sticky-header">Increment Percentage</th>
                        <th class="non-sticky-header">Increased Amount</th>
                        <th class="non-sticky-header">Revised Salary</th>
                        <th class="non-sticky-header">Increased Fuel Allowance</th>
                        <th class="non-sticky-header">Increased Fuel Litre</th>
                        <th class="non-sticky-header">Revised Fuel Allowance</th>
                        <th class="non-sticky-header">Mobile Provided</th>
                        <th class="non-sticky-header">Company Pickup</th>
                        <th class="non-sticky-header">Vehicle</th>
                        {# <th class="non-sticky-header">Total</th>  #}
                        <!-- Financial Impact Subheaders -->
                        <th class="non-sticky-header">Employee Status</th>
                        <th class="non-sticky-header">Serving Years</th>
                        <th class="non-sticky-header">Salary</th>
                        <th class="non-sticky-header">Gratuity</th>
                        <th class="non-sticky-header">Bonus</th>
                        <th class="non-sticky-header">Leave Encashment</th>
                        <th class="non-sticky-header">Fuel</th>
                        <th class="non-sticky-header">Vehicle</th>
                        <th class="non-sticky-header">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for employee in employees %}
                        <tr data-employee-id="{{ employee.emp_id }}" class="{% if employee.is_draft %}draft-row{% endif %}">
                            <td class="sticky-col sticky-col-1">{{ forloop.counter }}</td>
                            <td class="sticky-col sticky-col-2">{{ employee.emp_id|default:"-" }}</td>
                            <td class="sticky-col sticky-col-3">{{ employee.fullname|default:"-" }}</td>
                            <td class="sticky-col sticky-col-4 editable" data-tab="employee" data-field="designation_id" data-type="select" data-endpoint="/payroll/designations/?company_id={{ department.company.id }}">{{ employee.designation.title|default:"-" }}</td>
                            <!-- Employee Details -->
                            <td class="non-sticky editable" data-tab="employee" data-field="eligible_for_increment" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ employee.eligible_for_increment|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.department_team.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.department_group.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.section.name|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.location.location|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.date_of_joining|date:"Y-m-d"|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.resign|yesno:"Yes,No,-" }}</td>
                            <td class="non-sticky">{{ employee.date_of_resignation|date:"Y-m-d"|default:"-" }}</td>
                            <td class="non-sticky">{{ employee.remarks|default:"-" }}</td>
                            <!-- Current Package -->
                            {% with current_package=employee.currentpackagedetails %}
                                <td class="non-sticky">{{ current_package.gross_salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.company_pickup|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky">{{ current_package.vehicle|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.fuel_litre|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ current_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                                {% comment %} <td class="non-sticky">{{ current_package.total|floatformat:2|default:"-" }}</td> {% endcomment %}
                            {% endwith %}
                            <!-- Proposed Package -->
                            {% with proposed_package=employee.proposedpackagedetails %}
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="increment_percentage" data-type="number" data-step="0.01">{{ proposed_package.increment_percentage|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ proposed_package.increased_amount|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ proposed_package.revised_salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="increased_fuel_allowance" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="increased_fuel_litre" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_litre|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ proposed_package.revised_fuel_allowance|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="mobile_provided" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="company_pickup" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.company_pickup|yesno:"Yes,No,-" }}</td>
                                <td class="non-sticky editable" data-tab="proposed_package" data-field="vehicle_id" data-type="select" data-endpoint="/payroll/vehicles-dropdown/">{{ proposed_package.vehicle|default:"-" }}</td>
                                {% comment %} <td class="non-sticky">{{ proposed_package.total|floatformat:2|default:"-" }}</td> {% endcomment %}
                            {% endwith %}
                            <!-- Financial Impact -->
                            {% with financial_impact=employee.financialimpactpermonth %}
                                <td class="non-sticky">{{ financial_impact.emp_status.status|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.serving_years|floatformat:1|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.salary|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.gratuity|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.bonus|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.leave_encashment|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.fuel|floatformat:2|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.vehicle|default:"-" }}</td>
                                <td class="non-sticky">{{ financial_impact.total|floatformat:2|default:"-" }}</td>
                            {% endwith %}
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="42" style="text-align: center;">No employees found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <style>
        .container {
            overflow: hidden !important;
            padding: 20px;
        }
        .content {
            overflow: hidden !important;
        }
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-head h2 {
            margin: 0;
            font-size: 24px;
            color: #343a40;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .table-wrap {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 500px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            -webkit-clip-path: inset(0);
            clip-path: inset(0);
        }
        .custom-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 2000px; /* Ensure table is wide enough to trigger scrollbar */
            table-layout: auto;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            background-color: inherit;
        }
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        th[rowspan="2"] {
            vertical-align: middle;
        }
        /* Sticky headers and columns */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: #f2f2f2 !important;
        }
        .sticky-col {
            position: sticky;
            z-index: 30;
            background-color: #ffffff !important;
        }
        .sticky-col.sticky-header {
            z-index: 50;
            background-color: #f2f2f2 !important;
        }
        /* Non-sticky headers and cells */
        .non-sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
            background-color: #f2f2f2 !important;
        }
        .non-sticky {
            z-index: 5;
            background-color: #ffffff !important;
        }
        th.group-header {
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f3f5;
        }
        .draft-row {
            border-left: 4px solid #ffc107;
        }
        .editable.edited {
            background-color: #fff3cd;
        }
        .edited-row {
            background-color: #fff3cd !important;
        }
        .form-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            text-decoration: none;
        }
        .btn-submit {
            background-color: #28a745;
            color: #fff;
        }
        .btn-submit:hover {
            background-color: #218838;
        }
        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #007bff;
        }
        .edit-btn:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
            border: none;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .editable:hover {
            cursor: pointer;
            background-color: #e9ecef;
        }
        .editable select, .editable input, .editable textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .editable textarea {
            min-height: 60px;
            resize: vertical;
        }
        .confirm-popup {
            background: #fff;
            width: min(960px, 94vw);
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            padding: 16px;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .confirm-popup p {
            margin: 0 0 20px;
            font-size: 16px;
        }
        .confirm-popup .form-btn {
            min-width: 100px;
        }
        /* Specific column widths for sticky columns */
        .sticky-col-1 { width: 60px; }
        .sticky-col-2 { width: 100px; }
        .sticky-col-3 { width: 150px; }
        .sticky-col-4 { width: 120px; }
        /* Non-sticky columns */
        .non-sticky {
            min-width: 100px; /* Ensure sufficient width for non-sticky columns */
        }
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            th, td {
                font-size: 14px;
                padding: 6px;
            }
            .form-btn, .action-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
            .sticky-col-3, .sticky-col-4 {
                white-space: normal; /* Allow wrapping for readability */
                width: 100px;
            }
        }
        @media screen and (max-width: 500px) {
            .form-btn {
                font-size: 12px;
                padding: 10px;
            }
            .confirm-popup {
                width: 90vw;
                max-width: 400px;
            }
        }
    </style>

    <script>
    // Existing JavaScript functions (unchanged)
    const editedCells = {};
    const draftData = {{ draft_data|safe }};

    async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                },
                signal: controller.signal,
                ...opts
            });
            clearTimeout(timeoutId);
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`HTTP error! Status: ${res.status}, Response: ${errorText}`);
            }
            return await res.json();
        } catch (err) {
            clearTimeout(timeoutId);
            console.error(`Error fetching ${url}:`, err);
            showSnackbar(`Error: ${err.message}`, '#dc3545');
            throw err;
        }
    }

    function asArray(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.data)) return payload.data;
        if (payload && Array.isArray(payload.results)) return payload.results;
        if (payload && Array.isArray(payload.items)) return payload.items;
        return [];
    }

    async function makeEditable(cell) {
        if (!cell.classList.contains('editable')) return;
        const field = cell.dataset.field;
        const type = cell.dataset.type;
        const employeeId = cell.parentElement.dataset.employeeId;
        const tab = cell.dataset.tab;
        const endpoint = cell.dataset.endpoint;
        const options = cell.dataset.options ? JSON.parse(cell.dataset.options) : null;
        const depends = cell.dataset.depends;
        const step = cell.dataset.step || 'any';

        if (cell.querySelector('input, select, textarea')) return;

        let input;
        if (type === 'select') {
            input = document.createElement('select');
            if (options) {
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    input.appendChild(option);
                });
            } else if (endpoint) {
                try {
                    const data = await fetchJSON(endpoint);
                    const items = asArray(data);
                    input.innerHTML = '<option value="">Select</option>';
                    if (field === 'department_group_id') {
                        window.departmentGroups = items.map(dept => ({
                            id: dept.id,
                            name: dept.name,
                            sections: dept.sections || []
                        }));
                        items.forEach(dept => {
                            const opt = document.createElement('option');
                            opt.value = dept.id;
                            opt.textContent = dept.name;
                            input.appendChild(opt);
                        });
                    } else if (field === 'section_id' && depends) {
                        const groupId = cell.parentElement.querySelector(`[data-tab="employee"][data-field="${depends}"] select`)?.value;
                        if (groupId && window.departmentGroups) {
                            const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
                            if (group && group.sections) {
                                group.sections.forEach(section => {
                                    const opt = document.createElement('option');
                                    opt.value = section.id;
                                    opt.textContent = section.name;
                                    input.appendChild(opt);
                                });
                            }
                        }
                    } else {
                        items.forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.id;
                            opt.textContent = field === 'vehicle_id' ? item.label : (item.title || item.location || item.status || item.name);
                            input.appendChild(opt);
                        });
                    }
                } catch (e) {
                    console.error('Error loading dropdown:', e);
                    showSnackbar('Failed to load dropdown options', '#dc3545');
                    return;
                }
            }
            input.value = cell.dataset.originalId || cell.dataset.original || '';
        } else if (type === 'textarea') {
            input = document.createElement('textarea');
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        } else {
            input = document.createElement('input');
            input.type = type;
            if (type === 'number') input.step = step;
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        }

        cell.textContent = '';
        cell.appendChild(input);
        input.focus();

        input.addEventListener('blur', () => {
            let displayText = input.value.trim() || '-';
            const value = input.value.trim();
            
            if (type === 'select' && input.selectedIndex >= 0) {
                displayText = input.options[input.selectedIndex].text || '-';
            }
            
            cell.textContent = displayText;
            const originalValue = type === 'select' ? (cell.dataset.originalId || cell.dataset.original || '-') : (cell.dataset.original || '-');
            const isChanged = value !== originalValue;
            cell.classList.toggle('edited', isChanged);
            if (!isChanged && cell.dataset.hasDraft === 'true') {
                cell.classList.add('edited');
            }
            
            if (!editedCells[employeeId]) editedCells[employeeId] = {};
            if (!editedCells[employeeId][tab]) editedCells[employeeId][tab] = {};
            
            if (value && value !== '-') {
                editedCells[employeeId][tab][field] = value;
            } else {
                if (cell.dataset.hasDraft !== 'true') {
                    delete editedCells[employeeId][tab][field];
                    if (Object.keys(editedCells[employeeId][tab]).length === 0) {
                        delete editedCells[employeeId][tab];
                    }
                    if (Object.keys(editedCells[employeeId]).length === 0) {
                        delete editedCells[employeeId];
                    }
                }
            }
            // Update row highlighting
            const row = cell.parentElement;
            const hasEdits = Object.keys(editedCells[employeeId] || {}).some(tab => Object.keys(editedCells[employeeId][tab]).length > 0);
            row.classList.toggle('edited-row', hasEdits);
            console.log('Updated editedCells:', JSON.stringify(editedCells));

            // trigger recalculation if increment_percentage or fuel-related fields change
            if (field === "increment_percentage" || field === "increased_fuel_allowance" || field === "increased_fuel_litre" || field === "vehicle_id") {
                recalcProposedPackage(cell.closest("tr"));
            }
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') input.blur();
        });
    }

    async function saveDraft() {
        console.log('editedCells before saveDraft:', JSON.stringify(editedCells));
        if (Object.keys(editedCells).length === 0) {
            showSnackbar('No changes to save', '#dc3545');
            return;
        }
        // Convert ID fields to integers
        Object.keys(editedCells).forEach(empId => {
            if (editedCells[empId].employee && editedCells[empId].employee.designation_id) {
                editedCells[empId].employee.designation_id = parseInt(editedCells[empId].employee.designation_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.department_group_id) {
                editedCells[empId].employee.department_group_id = parseInt(editedCells[empId].employee.department_group_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.section_id) {
                editedCells[empId].employee.section_id = parseInt(editedCells[empId].employee.section_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.location_id) {
                editedCells[empId].employee.location_id = parseInt(editedCells[empId].employee.location_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.vehicle_id) {
                editedCells[empId].current_package.vehicle_id = parseInt(editedCells[empId].current_package.vehicle_id, 10);
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.vehicle_id) {
                editedCells[empId].proposed_package.vehicle_id = parseInt(editedCells[empId].proposed_package.vehicle_id, 10);
            }
            if (editedCells[empId].financial_impact && editedCells[empId].financial_impact.emp_status_id) {
                editedCells[empId].financial_impact.emp_status_id = parseInt(editedCells[empId].financial_impact.emp_status_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.company_pickup) {
                editedCells[empId].current_package.company_pickup = editedCells[empId].current_package.company_pickup === 'true';
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.company_pickup) {
                editedCells[empId].proposed_package.company_pickup = editedCells[empId].proposed_package.company_pickup === 'true';
            }
        });
        try {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (!csrfInput || !csrfInput.value) {
                showSnackbar('CSRF token missing or invalid', '#dc3545');
                console.error('CSRF token not found or empty');
                throw new Error('CSRF token missing or invalid');
            }
            console.log('CSRF token:', csrfInput.value);
            console.log('Saving draft with payload:', JSON.stringify(editedCells));
            const res = await fetch(`/payroll/save-draft/{{ department_id }}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfInput.value,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(editedCells),
            });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to save draft: ${res.status}, Response: ${errorText}`);
            }
            const result = await res.json();
            if (result.error) {
                showSnackbar(result.error, '#dc3545');
            } else {
                showSpinner();
                showSnackbar('Draft saved successfully', '#28a745');
                // Update original values to reflect saved draft
                Object.keys(editedCells).forEach(empId => {
                    Object.keys(editedCells[empId]).forEach(tab => {
                        Object.keys(editedCells[empId][tab]).forEach(field => {
                            const cell = document.querySelector(`tr[data-employee-id="${empId}"] [data-tab="${tab}"][data-field="${field}"]`);
                            if (cell) {
                                if (cell.dataset.type === 'select') {
                                    cell.dataset.originalId = editedCells[empId][tab][field];
                                } else {
                                    cell.dataset.original = editedCells[empId][tab][field];
                                }
                                cell.classList.remove('edited');
                            }
                        });
                    });
                });
                // Clear row highlighting
                document.querySelectorAll('tr.edited-row').forEach(row => row.classList.remove('edited-row'));
                console.log('editedCells after draft save:', JSON.stringify(editedCells));
            }
        } catch (e) {
            showSnackbar(`Error saving draft: ${e.message}`, '#dc3545');
            console.error('Save draft error:', e);
        }
    }

    function showSnackbar(message, bgColor) {
        const snackbar = document.createElement('div');
        snackbar.textContent = message;
        snackbar.style.position = 'fixed';
        snackbar.style.bottom = '20px';
        snackbar.style.left = '50%';
        snackbar.style.transform = 'translateX(-50%)';
        snackbar.style.backgroundColor = bgColor;
        snackbar.style.color = '#fff';
        snackbar.style.padding = '12px 24px';
        snackbar.style.borderRadius = '6px';
        snackbar.style.zIndex = '1000';
        document.body.appendChild(snackbar);
        setTimeout(() => snackbar.remove(), 3000);
    }

    function showConfirmPopup(message, callback) {
        const popup = document.createElement('div');
        popup.className = 'confirm-popup';
        popup.innerHTML = `
            <p>${message}</p>
            <div class="button-group">
                <button class="form-btn btn-submit" onclick="this.closest('.confirm-popup').remove(); (${callback.toString()})();">Confirm</button>
                <button class="form-btn btn-back" onclick="this.closest('.confirm-popup').remove();">Cancel</button>
            </div>
        `;
        document.body.appendChild(popup);
    }

    function showSpinner() {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '50%';
        spinner.style.left = '50%';
        spinner.style.transform = 'translate(-50%, -50%)';
        spinner.style.width = '40px';
        spinner.style.height = '40px';
        spinner.style.border = '4px solid #f3f3f3';
        spinner.style.borderTop = '4px solid #3498db';
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'spin 1s linear infinite';
        document.body.appendChild(spinner);
        setTimeout(() => spinner.remove(), 1000);
    }

    function recalcProposedPackage(row) {
        const grossSalary = parseFloat(row.querySelector('td:nth-child(14)')?.textContent) || 0;
        // console.log("grossSalary: ", grossSalary);
        // const totalCurrent = parseFloat(row.querySelector('td:nth-child(21)')?.textContent) || 0;
        // console.log("totalCurrent: ", totalCurrent);
        const incrementCell = row.querySelector('[data-tab="proposed_package"][data-field="increment_percentage"]');
        // console.log("incrementCell: ", incrementCell.textContent);
        const increasedAmountCell = row.querySelector('td:nth-child(21)');
        // console.log("increasedAmountCell: ", increasedAmountCell.textContent);
        const revisedSalaryCell = row.querySelector('td:nth-child(22)');
        // console.log("revisedSalaryCell: ", revisedSalaryCell.textContent);
        const CurrentFuelAllowance = row.querySelector('td:nth-child(17)');
        // console.log("CurrentFuelAllowance: ", CurrentFuelAllowance.textContent);
        const IncreasedFuelAllowance = row.querySelector('td:nth-child(23)');
        // console.log("IncreasedFuelAllowance: ", IncreasedFuelAllowance.textContent);
        const IncreasedFuelLitre = row.querySelector('td:nth-child(24)');
        // console.log("IncreasedFuelLitre: ", IncreasedFuelLitre.textContent);
        const RevisedFuelAllowance = row.querySelector('td:nth-child(25)');
        // console.log("RevisedFuelAllowance: ", RevisedFuelAllowance.textContent);
        const FinancialSalary = row.querySelector('td:nth-child(31)');
        // console.log("FinancialSalary: ", FinancialSalary.textContent);
        const FinancialGratuity = row.querySelector('td:nth-child(32)');
        // console.log("FinancialGratuity: ", FinancialGratuity.textContent);
        const FinancialBonus = row.querySelector('td:nth-child(33)');
        // console.log("FinancialBonus: ", FinancialBonus.textContent);
        const LeaveEncashment = row.querySelector('td:nth-child(34)');
        // console.log("LeaveEncashment: ", LeaveEncashment.textContent);
        const FinancialFuel = row.querySelector('td:nth-child(35)');
        // console.log("FinancialFuel: ", FinancialFuel.textContent);
        const FinancialTotal = row.querySelector('td:nth-child(37)');
        // console.log("FinancialTotal: ", FinancialTotal.textContent);
        // const totalProposedCell = row.querySelector('td:nth-child(32)');
        // console.log("totalProposedCell: ", totalProposedCell);

        if (!incrementCell || !increasedAmountCell || !revisedSalaryCell) return;

        const incPercent = parseFloat(incrementCell.textContent) || 0;
        // console.log("incPercent: ", incPercent);
        const increasedAmount = (grossSalary * incPercent) / 100;
        // console.log("increasedAmount: ", increasedAmount);
        const revisedSalary = grossSalary + increasedAmount;
        // console.log("revisedSalary: ", revisedSalary);
        // const totalProposed = totalCurrent + increasedAmount;
        // console.log("totalProposed: ", totalProposed);

        increasedAmountCell.textContent = increasedAmount.toFixed(2);
        revisedSalaryCell.textContent = revisedSalary.toFixed(2);

        if (IncreasedFuelLitre.textContent > 0) {
            IncreasedFuelAllowance.textContent = (154.7 * parseFloat(IncreasedFuelLitre.textContent)).toFixed(2);
            // console.log("updated IncreasedFuelAllowance.textContent: ", IncreasedFuelAllowance.textContent);
        }
        
        RevisedFuelAllowance.textContent = (parseFloat(IncreasedFuelAllowance.textContent) + parseFloat(CurrentFuelAllowance.textContent)).toFixed(2);
        FinancialSalary.textContent = parseFloat(increasedAmountCell.textContent).toFixed(2);
        FinancialGratuity.textContent = (parseFloat(FinancialSalary.textContent)/12).toFixed(2);
        FinancialBonus.textContent = (1.7*parseFloat(FinancialSalary.textContent)/12).toFixed(2);
        LeaveEncashment.textContent = (parseFloat(FinancialSalary.textContent)/12).toFixed(2);
        FinancialFuel.textContent = parseFloat(IncreasedFuelAllowance.textContent).toFixed(2);
        FinancialTotal.textContent = (parseFloat(FinancialFuel.textContent)+parseFloat(LeaveEncashment.textContent)+parseFloat(FinancialBonus.textContent)+parseFloat(FinancialSalary.textContent)+parseFloat(FinancialGratuity.textContent)).toFixed(2);
        // totalProposedCell.textContent = totalProposed.toFixed(2);
        // console.log("updated FinancialTotal.textContent: ", FinancialTotal.textContent);

        // console.log("ehehehe");
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Calculate and set sticky column offsets
        const table = document.querySelector('.custom-table');
        const headerRows = table.querySelectorAll('thead tr');
        const bodyRows = table.querySelectorAll('tbody tr');

        const setStickyOffsets = () => {
            const stickyColumns = [1, 2, 3, 4]; // Sticky column indices
            let cumulativeLeft = 0;

            stickyColumns.forEach((colIndex) => {
                const headerCell = headerRows[0].querySelector(`th.sticky-col-${colIndex}`);
                if (headerCell) {
                    const width = headerCell.offsetWidth;
                    const className = `.sticky-col-${colIndex}`;
                    document.querySelectorAll(className).forEach(cell => {
                        cell.style.left = `${cumulativeLeft}px`;
                    });
                    cumulativeLeft += width;
                }
            });

            // Log table width for debugging
            console.log('Table scrollWidth:', table.scrollWidth);
        };

        // Run initially and on window resize
        setStickyOffsets();
        window.addEventListener('resize', setStickyOffsets);

        // Existing event listeners
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            console.log('CSRF token on load:', csrfInput.value);
        } else {
            console.error('CSRF token input not found on page load');
        }

        document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
        document.querySelectorAll('.editable').forEach(cell => {
            cell.dataset.original = cell.textContent;

            if (cell.dataset.type === 'select') {
                const employeeId = cell.parentElement.dataset.employeeId;
                const tab = cell.dataset.tab;
                const field = cell.dataset.field;
                const draftValue = draftData[employeeId]?.[tab]?.[field];
                cell.dataset.originalId = draftValue || (field === 'designation_id' ? '{{ employee.designation.id|default:"" }}' : '');

                if (draftValue && cell.dataset.endpoint) {
                    fetchJSON(cell.dataset.endpoint).then(data => {
                        const items = asArray(data);
                        const item = items.find(i => i.id == draftValue);
                        if (item) {
                            cell.textContent = field === 'vehicle_id' ? item.label : (item.title || item.location || item.status || item.name);
                        }
                    });
                }
            }

            cell.addEventListener('click', () => makeEditable(cell));
        });
        document.querySelectorAll('tr[data-employee-id]').forEach(row => {
            const employeeId = row.dataset.employeeId;
            ['employee', 'current_package', 'proposed_package', 'financial_impact'].forEach(tab => {
                const draftDataTab = draftData?.[employeeId]?.[tab] || {};
                Object.keys(draftDataTab).forEach(field => {
                    const cell = row.querySelector(`[data-tab="${tab}"][data-field="${field}"]`);
                    if (cell) {
                        cell.classList.add('edited');
                        cell.dataset.hasDraft = 'true';
                        row.classList.add('edited-row');
                    }
                });
            });
        });
        Object.keys(draftData).forEach(empId => {
            editedCells[empId] = JSON.parse(JSON.stringify(draftData[empId]));
        });
    });
    </script>
{% else %}
    <p>You do not have permission to view this page.</p>
{% endif %}
{% endblock %}