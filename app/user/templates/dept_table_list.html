{% extends 'base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
{% if perms.user.view_employee %}
    <div class="container">
        <!-- CSRF token form -->
        <form id="csrf-form" style="display: none;">
            {% csrf_token %}
        </form>

        <!-- Page Heading -->
        <div class="section-head">
            <h2>Department — {{ department.name }}</h2>
        </div>

        <!-- Combined Table -->
        <div class="table-wrap">
            <table border="1" cellpadding="8" cellspacing="0">
                <thead>
                    <tr>
                        <th rowspan="2">SR.No</th>
                        <th rowspan="2">Full Name</th>
                        <!-- Employee Details -->
                        <th colspan="11" class="group-header">Employee Details</th>
                        <!-- Current Package -->
                        <th colspan="8" class="group-header">Current Package</th>
                        <!-- Proposed Package -->
                        <th colspan="10" class="group-header">Proposed Package</th>
                        <!-- Financial Impact -->
                        <th colspan="9" class="group-header">Financial Impact</th>
                        <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                        <!-- Employee Details Subheaders -->
                        <th>Employee ID</th>
                        <th>Eligible For Increment</th>
                        <th>Company</th>
                        <th>Department Team</th>
                        <th>Department Group</th>
                        <th>Section</th>
                        <th>Designation</th>
                        <th>Location</th>
                        <th>Date of Joining</th>
                        <th>Resign</th>
                        <th>Date of Resignation</th>
                        <th>Remarks</th>
                        <!-- Current Package Subheaders -->
                        <th>Gross Salary</th>
                        <th>Company Pickup</th>
                        <th>Vehicle</th>
                        <th>Fuel Allowance</th>
                        <th>Fuel Litre</th>
                        <th>Mobile Provided</th>
                        <th>Total</th>
                        <!-- Proposed Package Subheaders -->
                        <th>Increment Percentage</th>
                        <th>Increased Amount</th>
                        <th>Revised Salary</th>
                        <th>Increased Fuel Allowance</th>
                        <th>Increased Fuel Litre</th>
                        <th>Revised Fuel Allowance</th>
                        <th>Mobile Provided</th>
                        <th>Company Pickup</th>
                        <th>Vehicle</th>
                        <th>Total</th>
                        <!-- Financial Impact Subheaders -->
                        <th>Employee Status</th>
                        <th>Serving Years</th>
                        <th>Salary</th>
                        <th>Gratuity</th>
                        <th>Bonus</th>
                        <th>Leave Encashment</th>
                        <th>Fuel</th>
                        <th>Vehicle</th>
                        <th>Total</th>
                    </tr>
                </thead>

                

                <tbody>
    {% for employee in employees %}
        <tr data-employee-id="{{ employee.emp_id }}" class="{% if employee.is_draft %}draft-row{% endif %}">
            <td>{{ forloop.counter }}</td>
            <td>{{ employee.fullname|default:"-" }}</td>
            <!-- Employee Details -->
            <td>{{ employee.emp_id|default:"-" }}</td>
            <td class="editable" data-tab="employee" data-field="eligible_for_increment" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ employee.eligible_for_increment|default:"-" }}</td>
            <td>{{ employee.company|default:"-" }}</td>
            <td>{{ employee.department_team.name|default:"-" }}</td>
            <td>{{ employee.department_group.name|default:"-" }}</td>
            <td>{{ employee.section.name|default:"-" }}</td>
            <td class="editable" data-tab="employee" data-field="designation_id" data-type="select" data-endpoint="/payroll/designations/?company_id={{ department.company.id }}">{{ employee.designation.title|default:"-" }}</td>
            <td>{{ employee.location.location|default:"-" }}</td>
            <td>{{ employee.date_of_joining|date:"Y-m-d"|default:"-" }}</td>
            <td>{{ employee.resign|yesno:"Yes,No,-" }}</td>
            <td>{{ employee.date_of_resignation|date:"Y-m-d"|default:"-" }}</td>
            <td>{{ employee.remarks|default:"-" }}</td>
            <!-- Current Package -->
            {% with current_package=employee.currentpackagedetails %}
                <td>{{ current_package.gross_salary|floatformat:2|default:"-" }}</td>
                <td>{{ current_package.company_pickup|yesno:"Yes,No,-" }}</td>
                <td>{{ current_package.vehicle|default:"-" }}</td>
                <td>{{ current_package.fuel_allowance|floatformat:2|default:"-" }}</td>
                <td>{{ current_package.fuel_litre|floatformat:2|default:"-" }}</td>
                <td>{{ current_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                <td>{{ current_package.total|floatformat:2|default:"-" }}</td>
            {% endwith %}
            <!-- Proposed Package -->
            {% with proposed_package=employee.proposedpackagedetails %}
                <td class="editable" data-tab="proposed_package" data-field="increment_percentage" data-type="number" data-step="0.01">{{ proposed_package.increment_percentage|floatformat:2|default:"-" }}</td>
                <td>{{ proposed_package.increased_amount|floatformat:2|default:"-" }}</td>
                <td>{{ proposed_package.revised_salary|floatformat:2|default:"-" }}</td>
                <!-- <td class="editable" data-tab="proposed_package" data-field="increased_fuel_amount" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_amount|floatformat:2|default:"-" }}</td> -->
                <td class="editable" data-tab="proposed_package" data-field="increased_fuel_allowance" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_allowance|floatformat:2|default:"-" }}</td>
                <td class="editable" data-tab="proposed_package" data-field="increased_fuel_litre" data-type="number" data-step="0.01">{{ proposed_package.increased_fuel_litre|floatformat:2|default:"-" }}</td>
                <td>{{ proposed_package.revised_fuel_allowance|floatformat:2|default:"-" }}</td>
                <!-- <td class="editable" data-tab="proposed_package" data-field="fuel_litre" data-type="number" data-step="0.01">{{ proposed_package.fuel_litre|floatformat:2|default:"-" }}</td> -->
                <!-- <td class="editable" data-tab="proposed_package" data-field="vehicle_allowance" data-type="number" data-step="0.01">{{ proposed_package.vehicle_allowance|floatformat:2|default:"-" }}</td> -->
                <td class="editable" data-tab="proposed_package" data-field="mobile_provided" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.mobile_provided|yesno:"Yes,No,-" }}</td>
                <td class="editable" data-tab="proposed_package" data-field="company_pickup" data-type="select" data-options='[{"value": "true", "label": "Yes"}, {"value": "false", "label": "No"}]'>{{ proposed_package.company_pickup|yesno:"Yes,No,-" }}</td>
                <td>{{ proposed_package.vehicle|default:"-" }}</td>
                <td>{{ proposed_package.total|floatformat:2|default:"-" }}</td>
            {% endwith %}
            <!-- Financial Impact -->
            {% with financial_impact=employee.financialimpactpermonth %}
                <td>{{ financial_impact.emp_status.status|default:"-" }}</td>
                <td>{{ financial_impact.serving_years|floatformat:1|default:"-" }}</td>
                <td>{{ financial_impact.salary|floatformat:2|default:"-" }}</td>
                <td>{{ financial_impact.gratuity|floatformat:2|default:"-" }}</td>
                <td>{{ financial_impact.bonus|floatformat:2|default:"-" }}</td>
                <td>{{ financial_impact.leave_encashment|floatformat:2|default:"-" }}</td>
                <td>{{ financial_impact.fuel|floatformat:2|default:"-" }}</td>
                <td>{{ financial_impact.vehicle|default:"-" }}</td>
                <td>{{ financial_impact.total|floatformat:2|default:"-" }}</td>
            {% endwith %}
            <!-- Actions -->
            <td>
                {% if perms.user.change_employee %}
                    <a href="{% url 'update_employee' department_id=department_id employee_id=employee.emp_id %}" class="action-btn edit-btn">Edit</a>
                {% endif %}
                {% if perms.user.delete_employee %}
                    <button class="action-btn delete-btn delete-employee-btn" data-employee-id="{{ employee.emp_id }}">Delete</button>
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="42" style="text-align: center;">No employees found.</td>
        </tr>
    {% endfor %}
</tbody>

            </table>
        </div>

        <!-- Buttons -->
        <div class="button-group">
            {% if perms.user.add_employee %}
                <a href="{% url 'create_employee' department_id=department_id %}" class="form-btn btn-submit">Add New Employee</a>
            {% endif %}
            <button type="button" class="form-btn btn-submit" id="saveDraftBtn">Save Draft</button>
            <button type="button" class="form-btn btn-submit" id="saveBtn">Save</button>
        </div>
    </div>

    <style>
        .container {
            overflow: hidden !important;
            padding: 20px;
        }
        .content {
            overflow: hidden !important;
        }
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-head h2 {
            margin: 0;
            font-size: 24px;
            color: #343a40;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        .table-wrap {
            width: 100%;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th[rowspan="2"] {
            vertical-align: middle;
        }
        th.group-header {
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f3f5;
        }
        .draft-row {
            border-left: 4px solid #ffc107;
        }
        .editable.edited {
            background-color: #fff3cd;
        }
        .edited-row {
            background-color: #fff3cd !important;
        }
        .form-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            text-decoration: none;
        }
        .btn-submit {
            background-color: #28a745;
            color: #fff;
        }
        .btn-submit:hover {
            background-color: #218838;
        }
        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #007bff;
        }
        .edit-btn:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
            border: none;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .editable:hover {
            cursor: pointer;
            background-color: #e9ecef;
        }
        .editable select, .editable input, .editable textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .editable textarea {
            min-height: 60px;
            resize: vertical;
        }
        .confirm-popup {
            background: #fff;
            width: min(960px, 94vw);
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            padding: 16px;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .confirm-popup p {
            margin: 0 0 20px;
            font-size: 16px;
        }
        .confirm-popup .form-btn {
            min-width: 100px;
        }
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            table, th, td {
                font-size: 14px;
            }
            .form-btn, .action-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
        @media screen and (max-width: 500px) {
            .form-btn {
                font-size: 12px;
                padding: 10px;
            }
            .confirm-popup {
                width: 90vw;
                max-width: 400px;
            }
        }
    </style>

    <script>
    const editedCells = {};
    const draftData = {{ draft_data|safe }};

    async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        try {
            const res = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                },
                signal: controller.signal,
                ...opts
            });
            clearTimeout(timeoutId);
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`HTTP error! Status: ${res.status}, Response: ${errorText}`);
            }
            return await res.json();
        } catch (err) {
            clearTimeout(timeoutId);
            console.error(`Error fetching ${url}:`, err);
            showSnackbar(`Error: ${err.message}`, '#dc3545');
            throw err;
        }
    }

    function asArray(payload) {
        if (Array.isArray(payload)) return payload;
        if (payload && Array.isArray(payload.data)) return payload.data;
        if (payload && Array.isArray(payload.results)) return payload.results;
        if (payload && Array.isArray(payload.items)) return payload.items;
        return [];
    }

    async function makeEditable(cell) {
        if (!cell.classList.contains('editable')) return;
        const field = cell.dataset.field;
        const type = cell.dataset.type;
        const employeeId = cell.parentElement.dataset.employeeId;
        const tab = cell.dataset.tab;
        const endpoint = cell.dataset.endpoint;
        const options = cell.dataset.options ? JSON.parse(cell.dataset.options) : null;
        const depends = cell.dataset.depends;
        const step = cell.dataset.step || 'any';

        if (cell.querySelector('input, select, textarea')) return;

        let input;
        if (type === 'select') {
            input = document.createElement('select');
            if (options) {
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    input.appendChild(option);
                });
            } else if (endpoint) {
                try {
                    const data = await fetchJSON(endpoint);
                    const items = asArray(data);
                    input.innerHTML = '<option value="">Select</option>';
                    if (field === 'department_group_id') {
                        window.departmentGroups = items.map(dept => ({
                            id: dept.id,
                            name: dept.name,
                            sections: dept.sections || []
                        }));
                        items.forEach(dept => {
                            const opt = document.createElement('option');
                            opt.value = dept.id;
                            opt.textContent = dept.name;
                            input.appendChild(opt);
                        });
                    } else if (field === 'section_id' && depends) {
                        const groupId = cell.parentElement.querySelector(`[data-tab="employee"][data-field="${depends}"] select`)?.value;
                        if (groupId && window.departmentGroups) {
                            const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
                            if (group && group.sections) {
                                group.sections.forEach(section => {
                                    const opt = document.createElement('option');
                                    opt.value = section.id;
                                    opt.textContent = section.name;
                                    input.appendChild(opt);
                                });
                            }
                        }
                    } else {
                        items.forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.id;
                            opt.textContent = field === 'vehicle_id' || field === 'vehicle_proposed_id' || field === 'vehicle'
                                ? `${item.brand_name} ${item.model_name} - (${item.engine_cc})`
                                : (item.title || item.location || item.status || item.name);
                            input.appendChild(opt);
                        });
                    }
                } catch (e) {
                    console.error('Error loading dropdown:', e);
                    showSnackbar('Failed to load dropdown options', '#dc3545');
                    return;
                }
            }
            input.value = cell.dataset.originalId || cell.dataset.original || '';
        } else if (type === 'textarea') {
            input = document.createElement('textarea');
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        } else {
            input = document.createElement('input');
            input.type = type;
            if (type === 'number') input.step = step;
            input.value = cell.textContent !== '-' ? cell.textContent : '';
        }

        cell.textContent = '';
        cell.appendChild(input);
        input.focus();

        input.addEventListener('blur', () => {
            let displayText = input.value.trim() || '-';
            const value = input.value.trim();
            
            if (type === 'select' && input.selectedIndex >= 0) {
                displayText = input.options[input.selectedIndex].text || '-';
            }
            
            cell.textContent = displayText;
            const originalValue = type === 'select' ? (cell.dataset.originalId || cell.dataset.original || '-') : (cell.dataset.original || '-');
            const isChanged = value !== originalValue;
            cell.classList.toggle('edited', isChanged);
            if (!isChanged && cell.dataset.hasDraft === 'true') {
                cell.classList.add('edited');
            }
            
            if (!editedCells[employeeId]) editedCells[employeeId] = {};
            if (!editedCells[employeeId][tab]) editedCells[employeeId][tab] = {};
            
            if (value && value !== '-') {
                editedCells[employeeId][tab][field] = value;
            } else {
                if (cell.dataset.hasDraft !== 'true') {
                    delete editedCells[employeeId][tab][field];
                    if (Object.keys(editedCells[employeeId][tab]).length === 0) {
                        delete editedCells[employeeId][tab];
                    }
                    if (Object.keys(editedCells[employeeId]).length === 0) {
                        delete editedCells[employeeId];
                    }
                }
            }
            // Update row highlighting
            const row = cell.parentElement;
            const hasEdits = Object.keys(editedCells[employeeId] || {}).some(tab => Object.keys(editedCells[employeeId][tab]).length > 0);
            row.classList.toggle('edited-row', hasEdits);
            console.log('Updated editedCells:', JSON.stringify(editedCells));

            // trigger recalculation if increment_percentage (or other triggers)
            if (field === "increment_percentage" || field === "increased_fuel_allowance" || field === "increased_fuel_litre") {
                recalcProposedPackage(cell.closest("tr"));
            }
            
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') input.blur();
        });
    }

    async function saveDraft() {
        console.log('editedCells before saveDraft:', JSON.stringify(editedCells));
        if (Object.keys(editedCells).length === 0) {
            showSnackbar('No changes to save', '#dc3545');
            return;
        }
        // Convert ID fields to integers
        Object.keys(editedCells).forEach(empId => {
            if (editedCells[empId].employee && editedCells[empId].employee.designation_id) {
                editedCells[empId].employee.designation_id = parseInt(editedCells[empId].employee.designation_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.department_group_id) {
                editedCells[empId].employee.department_group_id = parseInt(editedCells[empId].employee.department_group_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.section_id) {
                editedCells[empId].employee.section_id = parseInt(editedCells[empId].employee.section_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.location_id) {
                editedCells[empId].employee.location_id = parseInt(editedCells[empId].employee.location_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.vehicle_id) {
                editedCells[empId].current_package.vehicle_id = parseInt(editedCells[empId].current_package.vehicle_id, 10);
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.vehicle_id) {
                editedCells[empId].proposed_package.vehicle_id = parseInt(editedCells[empId].proposed_package.vehicle_id, 10);
            }
            if (editedCells[empId].financial_impact && editedCells[empId].financial_impact.emp_status_id) {
                editedCells[empId].financial_impact.emp_status_id = parseInt(editedCells[empId].financial_impact.emp_status_id, 10);
            }

            // ... existing ID conversions ...
            if (editedCells[empId].current_package && editedCells[empId].current_package.company_pickup) {
                editedCells[empId].current_package.company_pickup = editedCells[empId].current_package.company_pickup === 'true';
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.company_pickup) {
                editedCells[empId].proposed_package.company_pickup = editedCells[empId].proposed_package.company_pickup === 'true';
            }
            
        });
        try {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (!csrfInput || !csrfInput.value) {
                showSnackbar('CSRF token missing or invalid', '#dc3545');
                console.error('CSRF token not found or empty');
                throw new Error('CSRF token missing or invalid');
            }
            console.log('CSRF token:', csrfInput.value);
            console.log('Saving draft with payload:', JSON.stringify(editedCells));
            const res = await fetch(`/payroll/save-draft/{{ department_id }}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfInput.value,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(editedCells),
            });
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`Failed to save draft: ${res.status}, Response: ${errorText}`);
            }
            const result = await res.json();
            if (result.error) {
                showSnackbar(result.error, '#dc3545');
            } else {
                showSpinner();
                showSnackbar('Draft saved successfully', '#28a745');
                // Update original values to reflect saved draft
                Object.keys(editedCells).forEach(empId => {
                    Object.keys(editedCells[empId]).forEach(tab => {
                        Object.keys(editedCells[empId][tab]).forEach(field => {
                            const cell = document.querySelector(`tr[data-employee-id="${empId}"] [data-tab="${tab}"][data-field="${field}"]`);
                            if (cell) {
                                if (cell.dataset.type === 'select') {
                                    cell.dataset.originalId = editedCells[empId][tab][field];
                                } else {
                                    cell.dataset.original = editedCells[empId][tab][field];
                                }
                                cell.classList.remove('edited');
                            }
                        });
                    });
                });
                // Clear row highlighting
                document.querySelectorAll('tr.edited-row').forEach(row => row.classList.remove('edited-row'));
                console.log('editedCells after draft save:', JSON.stringify(editedCells));
            }
        } catch (e) {
            showSnackbar(`Error saving draft: ${e.message}`, '#dc3545');
            console.error('Save draft error:', e);
        }
    }

    async function saveFinal() {
        console.log('editedCells before saveFinal:', JSON.stringify(editedCells));
        if (Object.keys(editedCells).length === 0) {
            showSnackbar('No changes to save', '#dc3545');
            return;
        }
        // Convert ID fields to integers
        Object.keys(editedCells).forEach(empId => {
            if (editedCells[empId].employee && editedCells[empId].employee.designation_id) {
                editedCells[empId].employee.designation_id = parseInt(editedCells[empId].employee.designation_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.department_group_id) {
                editedCells[empId].employee.department_group_id = parseInt(editedCells[empId].employee.department_group_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.section_id) {
                editedCells[empId].employee.section_id = parseInt(editedCells[empId].employee.section_id, 10);
            }
            if (editedCells[empId].employee && editedCells[empId].employee.location_id) {
                editedCells[empId].employee.location_id = parseInt(editedCells[empId].employee.location_id, 10);
            }
            if (editedCells[empId].current_package && editedCells[empId].current_package.vehicle_id) {
                editedCells[empId].current_package.vehicle_id = parseInt(editedCells[empId].current_package.vehicle_id, 10);
            }
            if (editedCells[empId].proposed_package && editedCells[empId].proposed_package.vehicle_id) {
                editedCells[empId].proposed_package.vehicle_id = parseInt(editedCells[empId].proposed_package.vehicle_id, 10);
            }
            if (editedCells[empId].financial_impact && editedCells[empId].financial_impact.emp_status_id) {
                editedCells[empId].financial_impact.emp_status_id = parseInt(editedCells[empId].financial_impact.emp_status_id, 10);
            }
        });
        showConfirmPopup('Are you sure you want to save changes to the original tables?', async () => {
            try {
                const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (!csrfInput || !csrfInput.value) {
                    showSnackbar('CSRF token missing or invalid', '#dc3545');
                    console.error('CSRF token not found or empty');
                    throw new Error('CSRF token missing or invalid');
                }
                console.log('CSRF token:', csrfInput.value);
                console.log('Saving final with payload:', JSON.stringify(editedCells));
                const res = await fetch(`/payroll/save-final/{{ department_id }}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfInput.value,
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(editedCells),
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Failed to save changes: ${res.status}, Response: ${errorText}`);
                }
                const result = await res.json();
                if (result.error) {
                    showSnackbar(result.error, '#dc3545');
                } else {
                    showSpinner();
                    showSnackbar('Changes saved successfully', '#28a745');
                    // Update original values to reflect saved changes
                    Object.keys(editedCells).forEach(empId => {
                        Object.keys(editedCells[empId]).forEach(tab => {
                            Object.keys(editedCells[empId][tab]).forEach(field => {
                                const cell = document.querySelector(`tr[data-employee-id="${empId}"] [data-tab="${tab}"][data-field="${field}"]`);
                                if (cell) {
                                    if (cell.dataset.type === 'select') {
                                        cell.dataset.originalId = editedCells[empId][tab][field];
                                    } else {
                                        cell.dataset.original = editedCells[empId][tab][field];
                                    }
                                    cell.classList.remove('edited');
                                }
                            });
                        });
                    });
                    // Clear editedCells and row highlighting after saving
                    document.querySelectorAll('tr.edited-row').forEach(row => row.classList.remove('edited-row'));
                    Object.keys(editedCells).forEach(empId => delete editedCells[empId]);
                    console.log('Cleared editedCells after final save:', JSON.stringify(editedCells));
                    // window.location.reload();
                }
            } catch (e) {
                showSnackbar(`Error saving changes: ${e.message}`, '#dc3545');
                console.error('Save final error:', e);
            }
        });
    }

    function bindRowActions() {
        document.querySelectorAll('.delete-employee-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const employeeId = this.dataset.employeeId;
                if (!employeeId) {
                    showSnackbar('Invalid employee ID', '#dc3545');
                    return;
                }
                showConfirmPopup('Are you sure you want to delete this employee?', async () => {
                    try {
                        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                        if (!csrfInput || !csrfInput.value) {
                            showSnackbar('CSRF token missing or invalid', '#dc3545');
                            console.error('CSRF token not found or empty');
                            throw new Error('CSRF token missing or invalid');
                        }
                        console.log('CSRF token:', csrfInput.value);
                        const res = await fetch(`/payroll/department/{{ department_id }}/delete/${employeeId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfInput.value,
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json',
                            },
                        });
                        if (!res.ok) {
                            const errorText = await res.text();
                            throw new Error(`Failed to delete employee: ${res.status}, Response: ${errorText}`);
                        }
                        const out = await res.json();
                        if (out.error) {
                            showSnackbar(out.error, '#dc3545');
                        } else {
                            showSpinner();
                            showSnackbar('Deleted successfully', '#28a745');
                            window.location.reload();
                        }
                    } catch (e) {
                        showSnackbar(`Error deleting employee: ${e.message}`, '#dc3545');
                        console.error('Delete employee error:', e);
                    }
                });
            });
        });
    }

    function showSnackbar(message, bgColor) {
        const snackbar = document.createElement('div');
        snackbar.textContent = message;
        snackbar.style.position = 'fixed';
        snackbar.style.bottom = '20px';
        snackbar.style.left = '50%';
        snackbar.style.transform = 'translateX(-50%)';
        snackbar.style.backgroundColor = bgColor;
        snackbar.style.color = '#fff';
        snackbar.style.padding = '12px 24px';
        snackbar.style.borderRadius = '6px';
        snackbar.style.zIndex = '1000';
        document.body.appendChild(snackbar);
        setTimeout(() => snackbar.remove(), 3000);
    }

    function showConfirmPopup(message, callback) {
        const popup = document.createElement('div');
        popup.className = 'confirm-popup';
        popup.innerHTML = `
            <p>${message}</p>
            <div class="button-group">
                <button class="form-btn btn-submit" onclick="this.closest('.confirm-popup').remove(); (${callback.toString()})();">Confirm</button>
                <button class="form-btn btn-back" onclick="this.closest('.confirm-popup').remove();">Cancel</button>
            </div>
        `;
        document.body.appendChild(popup);
    }

    function showSpinner() {
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        spinner.style.position = 'fixed';
        spinner.style.top = '50%';
        spinner.style.left = '50%';
        spinner.style.transform = 'translate(-50%, -50%)';
        spinner.style.width = '40px';
        spinner.style.height = '40px';
        spinner.style.border = '4px solid #f3f3f3';
        spinner.style.borderTop = '4px solid #3498db';
        spinner.style.borderRadius = '50%';
        spinner.style.animation = 'spin 1s linear infinite';
        document.body.appendChild(spinner);
        setTimeout(() => spinner.remove(), 1000);
    }

    {% comment %} For RunTime Edit {% endcomment %}

    function recalcProposedPackage(row) {
        const grossSalary = parseFloat(row.querySelector('td:nth-child(15)')?.textContent) || 0; // Current Gross Salary col
        const totalCurrent = parseFloat(row.querySelector('td:nth-child(21)')?.textContent) || 0; // Current Package Total col

        const incrementCell = row.querySelector('[data-tab="proposed_package"][data-field="increment_percentage"]');
        const increasedAmountCell = row.querySelector('td:nth-child(23)'); // Increased Amount col
        const revisedSalaryCell = row.querySelector('td:nth-child(24)');   // Revised Salary col
        const totalProposedCell = row.querySelector('td:nth-child(32)');   // Proposed Package Total col

        if (!incrementCell || !increasedAmountCell || !revisedSalaryCell || !totalProposedCell) return;

        const incPercent = parseFloat(incrementCell.textContent) || 0;
        const increasedAmount = (grossSalary * incPercent) / 100;
        const revisedSalary = grossSalary + increasedAmount;
        const totalProposed = totalCurrent + increasedAmount; // simplified — adjust if more fields affect total

        increasedAmountCell.textContent = increasedAmount.toFixed(2);
        revisedSalaryCell.textContent = revisedSalary.toFixed(2);
        totalProposedCell.textContent = totalProposed.toFixed(2);
    }


    document.addEventListener('DOMContentLoaded', () => {
        // Log CSRF token on page load for debugging
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            console.log('CSRF token on load:', csrfInput.value);
        } else {
            console.error('CSRF token input not found on page load');
        }

        bindRowActions();
        document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
        document.getElementById('saveBtn').addEventListener('click', saveFinal);
        document.querySelectorAll('.editable').forEach(cell => {
            cell.dataset.original = cell.textContent;

            if (cell.dataset.type === 'select') {
                const employeeId = cell.parentElement.dataset.employeeId;
                const tab = cell.dataset.tab;
                const field = cell.dataset.field;
                const draftValue = draftData[employeeId]?.[tab]?.[field];
                cell.dataset.originalId = draftValue || (field === 'designation_id' ? '{{ employee.designation.id|default:"" }}' : '');

                if (draftValue) {
                    // Fetch display text for draft values
                    fetchJSON(cell.dataset.endpoint).then(data => {
                        const items = asArray(data);
                        const item = items.find(i => i.id == draftValue);
                        if (item) {
                            if (field === 'vehicle_id' || field === 'vehicle_proposed_id' || field === 'vehicle') {
                                cell.textContent = `${item.brand_name} ${item.model_name} (${item.engine_cc})cc`;
                            } else {
                                // fallback for other select fields
                                cell.textContent = item.title || item.location || item.status || item.name;
                            }
                        }
                    });
                }
            }

            cell.addEventListener('click', () => makeEditable(cell));
        });
        document.querySelectorAll('tr[data-employee-id]').forEach(row => {
            const employeeId = row.dataset.employeeId;
            ['employee', 'current_package', 'proposed_package', 'financial_impact'].forEach(tab => {
                const draftDataTab = draftData?.[employeeId]?.[tab] || {};
                Object.keys(draftDataTab).forEach(field => {
                    const cell = row.querySelector(`[data-tab="${tab}"][data-field="${field}"]`);
                    if (cell) {
                        cell.classList.add('edited');
                        cell.dataset.hasDraft = 'true';
                        row.classList.add('edited-row');
                    }
                });
            });
        });
        // Initialize editedCells with draftData
        Object.keys(draftData).forEach(empId => {
            editedCells[empId] = JSON.parse(JSON.stringify(draftData[empId]));
        });
    });
</script>


{% else %}
    <p>You do not have permission to view this page.</p>
{% endif %}
{% endblock %}