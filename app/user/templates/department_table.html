{% extends 'base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
<!-- Page Heading + Actions -->
<section class="section-head">
  <h1 class="page-title">Department â€” {{ department.name }}</h1>
  <button id="openCreateModalBtn" class="btn btn-primary">Create New Record</button>
</section>

<!-- Card -->
<section class="card-like">
  <header class="card-head">
    <h2 class="card-title">Employee Data</h2>
  </header>

  <!-- Responsive table container -->
  <div class="table-wrap">
    {{ table_html | safe }}
  </div>
</section>

<!-- Pure HTML/JS Modal (no Bootstrap) -->
<div id="createModal" class="modal-overlay" aria-hidden="true" data-company-id="{{ department.company.id }}" data-mode="create">
  <div class="modal-window" role="dialog" aria-modal="true" aria-labelledby="createModalLabel">
    <header class="modal-header">
      <h3 id="createModalLabel">Create New Record</h3>
      <button class="modal-close" type="button" aria-label="Close" id="modalCloseBtn">&times;</button>
    </header>

    <div class="modal-body">
      <form id="createForm" enctype="multipart/form-data">
        <!-- Step 1: Employee -->
        <div class="step" id="step-employee">
          <h4 class="step-title">Step 1: Employee Details</h4>

          <div class="form-field">
            <label for="fullname">Full Name <span class="req">*</span></label>
            <input type="text" id="fullname" name="fullname" required>
          </div>

          <div class="form-field">
            <label for="department_group_id">Department Group <span class="req">*</span></label>
            <select id="department_group_id" name="department_group_id" required>
              <option value="">Select Department Group</option>
            </select>
          </div>

          <div class="form-field">
            <label for="section_id">Section <span class="req">*</span></label>
            <select id="section_id" name="section_id">
              <option value="">Select Section</option>
            </select>
          </div>

          <div class="form-field">
            <label>Designation <span class="req">*</span></label>
            <div class="inline-group">
              <select id="designation_id" name="designation_id">
                <option value="">Select Designation</option>
              </select>
              <label class="inline-check">
                <input type="checkbox" id="add_new_designation">
                <span>Add New</span>
              </label>
            </div>
            <input type="text" id="new_designation_title" name="new_designation_title" placeholder="Enter new designation title" disabled>
          </div>

          <div class="form-field">
            <label for="location_id">Location <span class="req">*</span></label>
            <select id="location_id" name="location_id">
              <option value="">Select Location</option>
            </select>
          </div>

          <div class="form-field split">
            <div>
              <label for="date_of_joining">Date of Joining <span class="req">*</span></label>
              <input type="date" id="date_of_joining" name="date_of_joining">
            </div>
            <div>
              <label for="resign">Resign</label>
              <select id="resign" name="resign">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
          </div>

          <div class="form-field">
            <label for="date_of_resignation">Date of Resignation</label>
            <input type="date" id="date_of_resignation" name="date_of_resignation" disabled>
          </div>

          <div class="form-field">
            <label for="remarks">Remarks</label>
            <textarea id="remarks" name="remarks"></textarea>
          </div>

          <div class="form-field">
            <label for="image">Image</label>
            <input type="file" id="image" name="image" accept="image/*">
          </div>
        </div>

        <!-- Step 2: Current Package -->
        <div class="step hidden" id="step-current_package">
          <h4 class="step-title">Step 2: Current Package Details</h4>

          <div class="form-field">
            <label for="gross_salary">Gross Salary</label>
            <input type="number" id="gross_salary" name="gross_salary" step="0.01">
          </div>

          <div class="form-field">
            <label for="vehicle_id">Vehicle</label>
            <select id="vehicle_id" name="vehicle_id">
              <option value="">Select Vehicle</option>
            </select>
          </div>

          <div class="form-field">
            <label for="fuel_limit">Fuel Limit</label>
            <input type="number" id="fuel_limit" name="fuel_limit" step="0.01">
          </div>

          <div class="form-field">
            <label for="mobile_allowance">Mobile Allowance</label>
            <input type="number" id="mobile_allowance" name="mobile_allowance" step="0.01">
          </div>
        </div>

        <!-- Step 3: Proposed Package -->
        <div class="step hidden" id="step-proposed_package">
          <h4 class="step-title">Step 3: Proposed Package Details</h4>

          <div class="form-field">
            <label for="increment_percentage">Increment Percentage</label>
            <input type="number" id="increment_percentage" name="increment_percentage" step="0.01">
          </div>

          <div class="form-field">
            <label for="increased_fuel_amount">Increased Fuel Amount</label>
            <input type="number" id="increased_fuel_amount" name="increased_fuel_amount" step="0.01">
          </div>

          <div class="form-field">
            <label for="mobile_allowance_proposed">Mobile Allowance</label>
            <input type="number" id="mobile_allowance_proposed" name="mobile_allowance_proposed" step="0.01">
          </div>

          <div class="form-field">
            <label for="vehicle_proposed_id">Vehicle</label>
            <select id="vehicle_proposed_id" name="vehicle_proposed">
              <option value="">Select Vehicle</option>
            </select>
          </div>
        </div>

        <!-- Step 4: Financial Impact -->
        <div class="step hidden" id="step-financial_impact">
          <h4 class="step-title">Step 4: Financial Impact Details</h4>

          <div class="form-field">
            <label for="emp_status_id">Employee Status</label>
            <select id="emp_status_id" name="emp_status_id">
              <option value="">Select Employee Status</option>
            </select>
          </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" name="step" id="step">
        <input type="hidden" name="employee_id" id="employee_id">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
      </form>
    </div>

    <footer class="modal-footer">
      <button type="button" class="btn btn-secondary hidden" id="prevBtn">Previous</button>
      <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
      <button type="button" class="btn btn-primary hidden" id="submitBtn">Submit</button>
      <button type="button" class="btn" id="modalCancelBtn">Cancel</button>
    </footer>
  </div>
</div>

<!-- Page-specific styles (pure CSS, no Bootstrap) -->
<style>
  /* Layout */
  .section-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .page-title {
    margin: 0;
    font-size: 20px;
    color: #343a40;
  }

  /* Card */
  .card-like {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
    padding: 16px;
  }
  .card-head {
    margin-bottom: 8px;
  }
  .card-title {
    margin: 0;
    font-size: 16px;
    color: #343a40;
  }

  /* Buttons */
  .btn {
    appearance: none;
    border: none;
    cursor: pointer;
    padding: 10px 14px;
    border-radius: 6px;
    background: #e9ecef;
    color: #343a40;
    font-size: 14px;
    transition: background 0.2s;
  }
  .btn:hover {
    background: #dfe3e6;
  }
  .btn-primary {
    background: #007bff;
    color: #fff;
  }
  .btn-primary:hover {
    background: #0069d9;
  }
  .btn-secondary {
    background: #6c757d;
    color: #fff;
  }
  .btn-secondary:hover {
    background: #5a6268;
  }
  .btn-sm {
    padding: 6px 10px;
    font-size: 12px;
  }

  /* Table wrapper */
  .table-wrap {
    width: 100%;
    overflow: auto;
  }

  /* Table styles (for backend-rendered table) */
  .table {
    width: 100%;
    border-collapse: collapse;
  }
  .table th,
  .table td {
    border: 1px solid #dee2e6;
    padding: 10px;
    text-align: left;
  }
  .table thead th {
    background: #f1f3f5;
  }
  .table-striped tbody tr:nth-child(even) {
    background: #f8f9fa;
  }

  /* Custom table styles */
  .custom-table {
    border-collapse: collapse;
    width: 100%;
  }
  .custom-table th,
  .custom-table td {
    min-width: 120px;
    max-width: 300px;
    padding: 12px;
    border: 2px solid #dee2e6;
    text-align: left;
  }
  .custom-table th {
    background: #e9ecef;
    font-weight: 700;
  }
  .custom-table tr:nth-child(even) {
    background: #f8f9fa;
  }
  .custom-table tr:nth-child(odd) {
    background: #fff;
  }
  .employee-col {
    background: #b3d7ff !important;
  }
  .current-package-col {
    background: #b8e4b8 !important;
  }
  .proposed-package-col {
    background: #ffd699 !important;
  }
  .financial-impact-col {
    background: #d8b8f0 !important;
  }
  .subheader {
    background: #6c757d !important;
    color: #fff !important;
    text-align: center !important;
    font-weight: 700;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1100;
  }
  .modal-overlay.show {
    display: flex;
  }
  .modal-window {
    background: #fff;
    width: min(960px, 94vw);
    max-height: 90vh;
    overflow: auto;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    display: flex;
    flex-direction: column;
  }
  .modal-header,
  .modal-footer {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
  }
  .modal-footer {
    border-top: 1px solid #eee;
    border-bottom: none;
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .modal-body {
    padding: 16px;
  }

  /* Modal close */
  .modal-close {
    background: transparent;
    border: none;
    font-size: 22px;
    line-height: 1;
    cursor: pointer;
    color: #343a40;
  }
  .modal-close:hover {
    opacity: 0.7;
  }

  /* Form */
  .form-field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 12px;
  }
  .form-field.split {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .form-field input[type="text"],
  .form-field input[type="number"],
  .form-field input[type="date"],
  .form-field input[type="file"],
  .form-field select,
  .form-field textarea {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ced4da;
    font-size: 14px;
  }
  .form-field textarea {
    min-height: 90px;
  }
  .inline-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .inline-check {
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .req {
    color: #dc3545;
  }
  .step {
    /* visible by default; control via JS */
  }
  .hidden {
    display: none !important;
  }

  /* Spacing helpers */
  .mt-5 {
    margin-top: 2rem;
  }
  .mb-3 {
    margin-bottom: 1rem;
  }
  .mb-4 {
    margin-bottom: 1.5rem;
  }

  /* Table action buttons */
  .table .btn {
    margin-right: 6px;
  }
</style>

<script>
  (function () {
    console.log('DOM loaded, initializing modal and table');

    // ===== Modal Helpers =====
    const modal = document.getElementById('createModal');
    const openBtn = document.getElementById('openCreateModalBtn');
    const closeBtn = document.getElementById('modalCloseBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const modalTitle = document.getElementById('createModalLabel');
    const form = document.getElementById('createForm');

    function openModal(mode = 'create') {
      modal.dataset.mode = mode;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      currentStep = 0;
      showStep(currentStep);
    }

    function closeModal() {
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden', 'true');
      modal.dataset.mode = 'create';
      modalTitle.textContent = 'Create New Record';
      delete modal.dataset.employeeId;
      form.reset();
      document.getElementById('employee_id').value = '';
      document.getElementById('add_new_designation').checked = false;
      document.getElementById('new_designation_title').disabled = true;
      document.getElementById('date_of_resignation').disabled = true;
      document.getElementById('designation_id').disabled = false;
      currentStep = 0;
      showStep(currentStep);
    }

    openBtn?.addEventListener('click', () => {
      modalTitle.textContent = 'Create New Record - Step 1';
      openModal('create');
    });
    closeBtn?.addEventListener('click', closeModal);
    cancelBtn?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // ===== Data Fetching =====
    const companyId = modal.dataset.companyId;

    async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, {
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json',
          },
          signal: controller.signal,
          ...opts,
        });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        return await res.json();
      } catch (err) {
        clearTimeout(timeoutId);
        console.error(`Error fetching ${url}:`, err);
        throw err;
      }
    }

    function asArray(payload) {
      if (Array.isArray(payload)) return payload;
      if (payload && Array.isArray(payload.data)) return payload.data;
      if (payload && Array.isArray(payload.results)) return payload.results;
      if (payload && Array.isArray(payload.items)) return payload.items;
      return [];
    }

    async function fetchDropdownData() {
      console.log('Fetching dropdown data for company:', companyId);

      // Department groups + sections
      try {
        const raw = await fetchJSON('/payroll/department-groups-sections/');
        const list = asArray(raw);
        if (!Array.isArray(list)) {
          console.error('Invalid department groups data:', raw);
          showSnackbar('No department groups available', '#dc3545');
          window.departmentGroups = [];
          return;
        }
        populateDepartmentGroups(list);
      } catch (e) {
        console.error('Error fetching department groups:', e);
        showSnackbar('Error loading department groups: ' + e.message, '#dc3545');
        window.departmentGroups = [];
      }

      // Designations and Locations
      try {
        const [designationsRaw, locationsRaw] = await Promise.all([
          fetchJSON(`/payroll/designations/?company_id=${companyId}`),
          fetchJSON('/payroll/locations/'),
        ]);
        const designations = asArray(designationsRaw);
        const locations = asArray(locationsRaw);
        if (designationsRaw.error || !designations) {
          console.error('Invalid designations data:', designationsRaw);
          showSnackbar(designationsRaw.error || 'Invalid designations data', '#dc3545');
        } else {
          populateDesignations(designations);
        }
        if (locationsRaw.error || !locations) {
          console.error('Invalid locations data:', locationsRaw);
          showSnackbar(locationsRaw.error || 'Invalid locations data', '#dc3545');
        } else {
          populateLocations(locations);
        }
      } catch (e) {
        console.error('Error fetching designations/locations:', e);
        showSnackbar('Error loading designations/locations: ' + e.message, '#dc3545');
      }

      // Employee status choices
      try {
        const statusRaw = await fetchJSON('/payroll/employee-status-choices/');
        const list = asArray(statusRaw);
        if (!Array.isArray(list)) {
          console.error('Invalid employee status data:', statusRaw);
          showSnackbar(statusRaw.error || 'No employee status choices available', '#dc3545');
          window.employeeStatusChoices = [];
          return;
        }
        populateEmployeeStatusDropdown(list);
      } catch (e) {
        console.error('Error fetching employee status choices:', e);
        showSnackbar('Error loading employee status choices: ' + e.message, '#dc3545');
        window.employeeStatusChoices = [];
      }

      // Vehicles
      try {
        const vehiclesRaw = await fetchJSON('/payroll/vehicles-dropdown/');
        const list = asArray(vehiclesRaw);
        if (!Array.isArray(list)) {
          console.error('Invalid vehicles data:', vehiclesRaw);
          showSnackbar('No vehicles available', '#dc3545');
          return;
        }
        populateVehicles(list);
      } catch (e) {
        console.error('Error fetching vehicles:', e);
        showSnackbar('Error loading vehicles: ' + e.message, '#dc3545');
      }
    }

    function populateDepartmentGroups(data) {
      const select = document.getElementById('department_group_id');
      select.innerHTML = '<option value="">Select Department Group</option>';
      window.departmentGroups = [];
      data.forEach(dept => {
        const opt = document.createElement('option');
        opt.value = dept.id;
        opt.textContent = dept.name;
        select.appendChild(opt);
        window.departmentGroups.push({ id: dept.id, name: dept.name, sections: dept.sections || [] });
      });
    }

    function populateDesignations(data) {
      const select = document.getElementById('designation_id');
      select.innerHTML = '<option value="">Select Designation</option>';
      data.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.title;
        select.appendChild(opt);
      });
    }

    function populateLocations(data) {
      const select = document.getElementById('location_id');
      select.innerHTML = '<option value="">Select Location</option>';
      data.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.location;
        select.appendChild(opt);
      });
    }

    function populateVehicles(data) {
      const currentSelect = document.getElementById('vehicle_id');
      const proposedSelect = document.getElementById('vehicle_proposed_id');
      currentSelect.innerHTML = '<option value="">Select Vehicle</option>';
      proposedSelect.innerHTML = '<option value="">Select Vehicle</option>';

      data.forEach(v => {
        const plateText = `Number Plate (${v.registration_number && v.registration_number.trim() ? v.registration_number : 'Not Assigned'})`;
        const label = `${v.brand_name} ${v.model_name} ${v.year} (${v.condition}) - ${plateText}`;
        const opt1 = document.createElement('option');
        opt1.value = v.id;
        opt1.textContent = label;
        currentSelect.appendChild(opt1);
        const opt2 = opt1.cloneNode(true);
        proposedSelect.appendChild(opt2);
      });
    }

    function populateEmployeeStatusDropdown(data) {
      const select = document.getElementById('emp_status_id');
      select.innerHTML = '<option value="">Select Employee Status</option>';
      window.employeeStatusChoices = [];
      if (!data || !Array.isArray(data)) {
        console.error('populateEmployeeStatusDropdown: data is not an array', data);
        return;
      }
      data.forEach(choice => {
        const opt = document.createElement('option');
        opt.value = choice.id;
        opt.textContent = choice.status;
        select.appendChild(opt);
        window.employeeStatusChoices.push({ id: choice.id, status: choice.status });
      });
    }

    function populateSections(groupId) {
      const select = document.getElementById('section_id');
      select.innerHTML = '<option value="">Select Section</option>';
      console.log('Populating sections for departmentGroupId:', groupId);
      if (!window.departmentGroups) {
        console.error('window.departmentGroups is undefined');
        showSnackbar('Department groups not loaded. Please try again.', '#dc3545');
        return;
      }
      if (groupId) {
        const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
        if (group && group.sections) {
          group.sections.forEach(section => {
            const opt = document.createElement('option');
            opt.value = section.id;
            opt.textContent = section.name;
            select.appendChild(opt);
          });
        } else {
          console.warn('No group or sections found for departmentGroupId:', groupId);
        }
      }
    }

    // Load dropdowns on DOM ready
    document.addEventListener('DOMContentLoaded', fetchDropdownData);

    // ===== Form Interactivity =====
    const resignDropdown = document.getElementById('resign');
    const resignationInput = document.getElementById('date_of_resignation');
    resignDropdown.addEventListener('change', function () {
      const yes = this.value === 'true';
      resignationInput.disabled = !yes;
      if (!yes) resignationInput.value = '';
    });

    const addNewDesignationCheckbox = document.getElementById('add_new_designation');
    const newDesignationInput = document.getElementById('new_designation_title');
    const designationSelect = document.getElementById('designation_id');
    addNewDesignationCheckbox.addEventListener('change', function () {
      const on = this.checked;
      newDesignationInput.disabled = !on;
      designationSelect.disabled = on;
      if (!on) {
        newDesignationInput.value = '';
        designationSelect.value = '';
      }
    });

    document.getElementById('department_group_id').addEventListener('change', function () {
      populateSections(this.value);
    });

    async function createNewDesignation() {
      const title = newDesignationInput.value.trim();
      if (!title) {
        showSnackbar('Please enter a designation title', '#dc3545');
        return null;
      }
      try {
        const res = await fetch('/payroll/designations/create/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
            'Accept': 'application/json',
          },
          body: JSON.stringify({ title, company: companyId }),
        });
        if (!res.ok) throw new Error('Failed to create designation');
        const result = await res.json();
        if (result.error) {
          showSnackbar(result.error, '#dc3545');
          return null;
        }
        return result;
      } catch (e) {
        console.error('Error creating designation:', e);
        showSnackbar('Error creating designation: ' + e.message, '#dc3545');
        return null;
      }
    }

    function validateEmployeeStep() {
      const errors = [];
      const q = sel => form.querySelector(sel);
      if (!q('#fullname').value.trim()) errors.push('Full Name is required');
      if (!q('#department_group_id').value) errors.push('Department Group is required');
      if (!q('#section_id').value) errors.push('Section is required');
      if (!q('#location_id').value) errors.push('Location is required');
      if (!q('#date_of_joining').value) errors.push('Date of Joining is required');
      if (q('#resign').value === 'true' && !q('#date_of_resignation').value.trim()) errors.push('Date of Resignation is required');
      if (addNewDesignationCheckbox.checked && !newDesignationInput.value.trim()) errors.push('New Designation Title is required when adding a new designation');
      if (!addNewDesignationCheckbox.checked && !designationSelect.value) errors.push('Designation is required');
      return errors;
    }

    async function fetchEmployeeData(employeeId) {
      console.log('Fetching data for employee:', employeeId);
      try {
        const data = await fetchJSON(`/payroll/get-data/employee/${employeeId}/`);
        if (data.error || !data.data || !data.data.employee) {
          console.error('Invalid response structure or error:', data);
          showSnackbar(data.error || 'Invalid employee data received', '#dc3545');
          return null;
        }
        console.log('Employee data fetched:', data.data);
        return data.data;
      } catch (e) {
        console.error('Error fetching employee data:', e);
        showSnackbar('Error fetching employee data: ' + e.message, '#dc3545');
        return null;
      }
    }

    function populateForm(data) {
      console.log('Populating form with data:', data);
      if (!data || !data.employee) {
        console.error('No employee data provided to populateForm');
        showSnackbar('No employee data available', '#dc3545');
        return;
      }
      const q = sel => form.querySelector(sel);
      q('#fullname').value = data.employee.fullname || '';
      q('#department_group_id').value = data.employee.department_group_id || '';
      populateSections(data.employee.department_group_id);
      q('#section_id').value = data.employee.section_id || '';
      q('#designation_id').value = data.employee.designation_id || '';
      addNewDesignationCheckbox.checked = false;
      newDesignationInput.disabled = true;
      designationSelect.disabled = false;
      newDesignationInput.value = '';
      q('#location_id').value = data.employee.location_id || '';
      q('#date_of_joining').value = data.employee.date_of_joining || '';
      q('#resign').value = data.employee.resign ? 'true' : 'false';
      resignationInput.disabled = !data.employee.resign;
      q('#date_of_resignation').value = data.employee.date_of_resignation || '';
      q('#remarks').value = data.employee.remarks || '';
      q('#gross_salary').value = data.current_package.gross_salary || '';
      q('#vehicle_id').value = data.current_package.vehicle_id || '';
      q('#fuel_limit').value = data.current_package.fuel_limit || '';
      q('#mobile_allowance').value = data.current_package.mobile_allowance || '';
      q('#increment_percentage').value = data.proposed_package.increment_percentage || '';
      q('#increased_fuel_amount').value = data.proposed_package.increased_fuel_amount || '';
      q('#mobile_allowance_proposed').value = data.proposed_package.mobile_allowance || '';
      q('#vehicle_proposed_id').value = data.proposed_package.vehicle_id || '';
      q('#emp_status_id').value = data.financial_impact.emp_status_id || '';
    }

    // ===== Multi-step Form Logic =====
    const steps = ['employee', 'current_package', 'proposed_package', 'financial_impact'];
    let currentStep = 0;

    function showStep(stepIndex) {
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('hidden', i !== stepIndex);
      });
      document.getElementById('step').value = steps[stepIndex];
      document.getElementById('prevBtn').classList.toggle('hidden', stepIndex === 0);
      document.getElementById('nextBtn').classList.toggle('hidden', stepIndex === steps.length - 1);
      document.getElementById('submitBtn').classList.toggle('hidden', stepIndex !== steps.length - 1);
      const mode = modal.dataset.mode === 'edit' ? 'Edit Record' : 'Create New Record';
      modalTitle.textContent = `${mode} - Step ${stepIndex + 1}`;
    }

    async function handleFormSubmission(formData, step) {
      if (step === 'employee') {
        const errors = validateEmployeeStep();
        if (errors.length) {
          alert('Please fix the following errors:\n- ' + errors.join('\n- '));
          return null;
        }
        if (addNewDesignationCheckbox.checked) {
          const created = await createNewDesignation();
          if (created) {
            formData.set('designation_id', created.id);
            try {
              const data = await fetchJSON(`/payroll/designations/?company_id=${companyId}`);
              populateDesignations(asArray(data));
              designationSelect.value = created.id;
            } catch (e) {
              console.error('Error refreshing designations:', e);
            }
          } else {
            return null;
          }
        }
      }
      return formData;
    }

    // Next button
    document.getElementById('nextBtn').addEventListener('click', async function () {
      let formData = new FormData(form);
      formData = await handleFormSubmission(formData, steps[currentStep]);
      if (!formData) return;

      const isEdit = modal.dataset.mode === 'edit';
      const url = isEdit ? `/payroll/update-data/{{ department_id }}/` : `/payroll/create-data/{{ department_id }}/`;
      if (isEdit) formData.append('employee_id', modal.dataset.employeeId);

      try {
        let headers = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
        let body = formData;
        let method = isEdit ? 'PATCH' : 'POST';

        if (isEdit) {
          headers['X-CSRFToken'] = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
          headers['Content-Type'] = 'application/json';
          const obj = {};
          for (const [k, v] of formData.entries()) {
            if (k === 'csrfmiddlewaretoken') continue;
            obj[k] = v;
          }
          body = JSON.stringify(obj, null, 2);
        }

        const res = await fetch(url, { method, headers, body });
        if (!res.ok) throw new Error('Failed to save step');
        const result = await res.json();
        if (result.error) {
          alert(result.error);
          return;
        }
        if (result.employee_id) document.getElementById('employee_id').value = result.employee_id;

        currentStep++;
        if (currentStep < steps.length) {
          showStep(currentStep);
          if (!isEdit) {
            form.querySelectorAll('input:not([type="hidden"]), textarea, select').forEach(input => {
              if (['employee_id', 'step', 'csrfmiddlewaretoken'].includes(input.id)) return;
              input.value = '';
            });
            addNewDesignationCheckbox.checked = false;
            newDesignationInput.disabled = true;
            designationSelect.disabled = false;
          }
        }
      } catch (e) {
        console.error('Error saving step:', e);
        alert('Error saving step: ' + e.message);
      }
    });

    // Submit button
    document.getElementById('submitBtn').addEventListener('click', async function () {
      let formData = new FormData(form);
      formData = await handleFormSubmission(formData, steps[currentStep]);
      if (!formData) return;

      const isEdit = modal.dataset.mode === 'edit';
      const url = isEdit ? `/payroll/update-data/{{ department_id }}/` : `/payroll/create-data/{{ department_id }}/`;
      if (isEdit) formData.append('employee_id', modal.dataset.employeeId);

      try {
        let headers = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
        let body = formData;
        let method = isEdit ? 'PATCH' : 'POST';

        if (isEdit) {
          headers['X-CSRFToken'] = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
          headers['Content-Type'] = 'application/json';
          const obj = {};
          for (const [k, v] of formData.entries()) {
            if (k === 'csrfmiddlewaretoken') continue;
            obj[k] = v;
          }
          body = JSON.stringify(obj, null, 2);
        }

        const res = await fetch(url, { method, headers, body });
        if (!res.ok) throw new Error('Failed to save final step');
        const result = await res.json();
        if (result.error) {
          alert(result.error);
        } else {
          closeModal();
          showSnackbar('Saved successfully');
          window.location.reload();
        }
      } catch (e) {
        console.error('Error saving final step:', e);
        alert('Error saving final step: ' + e.message);
      }
    });

    // Previous button
    document.getElementById('prevBtn').addEventListener('click', function () {
      if (currentStep > 0) {
        currentStep--;
        showStep(currentStep);
      }
    });

    // ===== Row Actions (Edit/Delete) =====
    function bindRowActions() {
      document.querySelectorAll('.edit-employee-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
          const tr = this.closest('tr');
          const employeeId = tr?.dataset?.employeeId;
          if (!employeeId) {
            alert('Invalid employee ID');
            return;
          }
          console.log('Edit button clicked for employee:', employeeId);
          if (!window.departmentGroups || !window.employeeStatusChoices) {
            console.log('Dropdown data not loaded, fetching now');
            await fetchDropdownData();
          }
          const data = await fetchEmployeeData(employeeId);
          if (data) {
            modal.dataset.mode = 'edit';
            modal.dataset.employeeId = employeeId;
            modalTitle.textContent = 'Edit Record - Step 1';
            populateForm(data);
            openModal('edit');
            console.log('Modal shown for edit, employeeId:', employeeId);
          }
        });
      });

      document.querySelectorAll('.delete-employee-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const tr = this.closest('tr');
          const employeeId = tr?.dataset?.employeeId;
          if (!employeeId) {
            alert('Invalid employee ID');
            return;
          }
          console.log('Delete button clicked for employee:', employeeId);
          showConfirmPopup('Are you sure you want to delete this employee?', async () => {
            try {
              const res = await fetch(`/payroll/delete-data/employee/${employeeId}/`, {
                method: 'DELETE',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                  'Accept': 'application/json',
                },
              });
              if (!res.ok) throw new Error('Failed to delete employee');
              const out = await res.json();
              if (out.error) {
                showSnackbar(out.error, '#dc3545');
              } else {
                showSnackbar('Deleted successfully');
                window.location.reload();
              }
            } catch (e) {
              console.error('Error deleting employee:', e);
              showSnackbar('Error deleting employee: ' + e.message, '#dc3545');
            }
          });
        });
      });
    }

    // Bind row actions on DOM ready
    document.addEventListener('DOMContentLoaded', bindRowActions);
  })();
</script>
{% endblock %}