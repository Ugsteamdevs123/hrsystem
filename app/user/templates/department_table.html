{% extends 'base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Department - {{ department.name }}</h1>
</div>

<div class="card shadow p-4 mt-4">
    <div class="card-header d-flex justify-content-between align-items-center mb-3">
        <h5>Employee Data</h5>
        {% if perms.user.add_employee %}
        <button id="openCreateBtn" class="btn btn-primary btn-sm">Add Employee</button>
        {% endif %}
    </div>
    <div class="table-responsive">
        {{ table_html|safe }}
    </div>
</div>

<!-- Create/Edit Employee Modal -->
<div id="createModal" class="modal-overlay" data-company-id="{{ department.company.id }}" data-department-id="{{ department.id }}">
  <div class="modal-content-lg">
    <div class="modal-header">
        <h5 id="createModalLabel">Add Employee</h5>
        <span class="modal-close" id="cancelBtn">&times;</span>
    </div>
    <form id="createForm" enctype="multipart/form-data">
        <!-- Step 1 -->
        <div class="step" id="step-employee">
            <h6>Step 1: Employee Details</h6>
            <div class="form-group">
                <label for="fullname">Full Name <span class="required">*</span></label>
                <input type="text" id="fullname" name="fullname" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="department_group_id">Department Group</label>
                <select id="department_group_id" name="department_group_id" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="section_id">Section</label>
                <select id="section_id" name="section_id" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="designation_id">Designation</label>
                <select id="designation_id" name="designation_id" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="location_id">Location</label>
                <select id="location_id" name="location_id" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="date_of_joining">Date of Joining</label>
                <input type="date" id="date_of_joining" name="date_of_joining" class="form-control">
            </div>
            <div class="form-group">
                <label for="remarks">Remarks</label>
                <textarea id="remarks" name="remarks" class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="image">Employee Image</label>
                <input type="file" id="image" name="image" class="form-control" accept="image/*">
            </div>
        </div>

        <!-- Step 2 -->
        <div class="step d-none" id="step-current_package">
            <h6>Step 2: Current Package</h6>
            <div class="form-group">
                <label for="gross_salary">Gross Salary</label>
                <input type="number" id="gross_salary" name="gross_salary" class="form-control">
            </div>
            <div class="form-group">
                <label for="vehicle">Vehicle</label>
                <input type="text" id="vehicle" name="vehicle" class="form-control">
            </div>
            <div class="form-group">
                <label for="fuel_limit">Fuel Limit</label>
                <input type="number" id="fuel_limit" name="fuel_limit" class="form-control">
            </div>
            <div class="form-group">
                <label for="mobile_allowance">Mobile Allowance</label>
                <input type="number" id="mobile_allowance" name="mobile_allowance" class="form-control">
            </div>
        </div>

        <!-- Step 3 -->
        <div class="step d-none" id="step-proposed_package">
            <h6>Step 3: Proposed Package</h6>
            <div class="form-group">
                <label for="increment_percentage">Increment %</label>
                <input type="number" id="increment_percentage" name="increment_percentage" class="form-control">
            </div>
        </div>

        <!-- Step 4 -->
        <div class="step d-none" id="step-financial_impact">
            <h6>Step 4: Financial Impact</h6>
            <div class="form-group">
                <label for="salary">Salary</label>
                <input type="number" id="salary" name="salary" class="form-control">
            </div>
        </div>

        <input type="hidden" id="step" name="step">
        <input type="hidden" id="employee_id" name="employee_id">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    </form>
    <div class="modal-footer">
        <button id="prevBtn" class="btn btn-secondary btn-sm d-none">Previous</button>
        <button id="nextBtn" class="btn btn-primary btn-sm">Next</button>
        <button id="submitBtn" class="btn btn-success btn-sm d-none">Submit</button>
    </div>
  </div>
</div>

<style>
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1050}
.modal-content-lg{background:#fff;border-radius:8px;padding:20px;max-width:800px;width:95%;box-shadow:0 5px 15px rgba(0,0,0,.3)}
.modal-header{display:flex;justify-content:space-between;align-items:center}
.modal-close{cursor:pointer;font-size:24px}
.step{margin-bottom:10px}
.required{color:red}
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const modal=document.getElementById("createModal");
    const openBtn=document.getElementById("openCreateBtn");
    const cancelBtn=document.getElementById("cancelBtn");
    const steps=['employee','current_package','proposed_package','financial_impact'];
    let currentStep=0;

    function showModal(){modal.style.display='flex';}
    function hideModal(){modal.style.display='none';}
    function showStep(i){
        steps.forEach((s,idx)=>document.getElementById("step-"+s).classList.toggle("d-none",idx!==i));
        document.getElementById("prevBtn").classList.toggle("d-none",i===0);
        document.getElementById("nextBtn").classList.toggle("d-none",i===steps.length-1);
        document.getElementById("submitBtn").classList.toggle("d-none",i!==steps.length-1);
        document.getElementById("step").value=steps[i];
    }

    openBtn?.addEventListener("click",()=>{currentStep=0;document.getElementById("createForm").reset();showModal();showStep(currentStep);fetchDropdownData();});
    cancelBtn.addEventListener("click",hideModal);
    document.getElementById("prevBtn").addEventListener("click",()=>{if(currentStep>0){currentStep--;showStep(currentStep);}});
    document.getElementById("nextBtn").addEventListener("click",()=>{submitStep(false);});
    document.getElementById("submitBtn").addEventListener("click",()=>{submitStep(true);});

    // AJAX - fetch dropdowns (from old file)
    async function fetchDropdownData(){
        const companyId=modal.dataset.companyId;
        const deptGroup=document.getElementById("department_group_id");
        const section=document.getElementById("section_id");
        const designation=document.getElementById("designation_id");
        const location=document.getElementById("location_id");
        deptGroup.innerHTML=""; section.innerHTML=""; designation.innerHTML=""; location.innerHTML="";
        // Example endpoints (adjust if needed)
        await populateSelect(`/payroll/get-department-groups/${companyId}/`,deptGroup);
        await populateSelect(`/payroll/get-sections/${companyId}/`,section);
        await populateSelect(`/payroll/get-designations/${companyId}/`,designation);
        await populateSelect(`/payroll/get-locations/${companyId}/`,location);
    }
    async function populateSelect(url,select){
        try{
            const res=await fetch(url);
            const data=await res.json();
            data.forEach(opt=>{
                const o=document.createElement("option");
                o.value=opt.id;o.textContent=opt.name||opt.title||opt.location;
                select.appendChild(o);
            });
        }catch(e){console.error("Dropdown fetch error",e);}
    }

    // AJAX - create/edit steps
    async function submitStep(isFinal){
        const form=document.getElementById("createForm");
        const formData=new FormData(form);
        formData.append("step",steps[currentStep]);
        const deptId=modal.dataset.departmentId;
        try{
            const res=await fetch(`/payroll/department-table/${deptId}/create/`,{
                method:"POST",
                body:formData,
                headers:{"X-Requested-With":"XMLHttpRequest"}
            });
            const data=await res.json();
            if(data.employee_id){document.getElementById("employee_id").value=data.employee_id;}
            if(isFinal){hideModal();location.reload();}
            else{currentStep++;showStep(currentStep);}
        }catch(e){console.error("Submit error",e);}
    }

    // DELETE employee
    document.querySelectorAll(".delete-employee-btn").forEach(btn=>{
        btn.addEventListener("click",async e=>{
            const empId=e.target.closest("tr").dataset.employeeId;
            if(confirm("Delete this employee?")){
                try{
                    await fetch(`/payroll/employees/${empId}/delete/`,{method:"DELETE",headers:{"X-CSRFToken":document.querySelector("[name=csrfmiddlewaretoken]").value}});
                    location.reload();
                }catch(e){console.error("Delete error",e);}
            }
        });
    });

    // EDIT employee (prefill + open modal)
    document.querySelectorAll(".edit-employee-btn").forEach(btn=>{
        btn.addEventListener("click",async e=>{
            const empId=e.target.closest("tr").dataset.employeeId;
            try{
                const res=await fetch(`/payroll/employees/${empId}/`);
                const data=await res.json();
                document.getElementById("fullname").value=data.fullname;
                document.getElementById("department_group_id").value=data.department_group_id;
                document.getElementById("section_id").value=data.section_id;
                document.getElementById("designation_id").value=data.designation_id;
                document.getElementById("location_id").value=data.location_id;
                document.getElementById("remarks").value=data.remarks;
                document.getElementById("employee_id").value=empId;
                currentStep=0;showStep(currentStep);showModal();
            }catch(e){console.error("Edit fetch error",e);}
        });
    });

});
</script>
{% endblock %}
