{% extends 'base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
{% if perms.user.view_employee %}
    <!-- Page Heading -->
    <div class="section-head">
        <h2>Department â€” {{ department.name }}</h2>
    </div>

    <!-- Add New Employee Button -->
    <div class="button-group">
        {% if perms.user.add_employee %}
            <button type="button" class="form-btn btn-submit" onclick="openModal('create')">
                Add New Employee
            </button>
        {% endif %}
    </div>

    <!-- Tabbed Interface -->
    <div class="tab-container">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="employee">Employee Details</button>
            <button class="tab-btn" data-tab="current_package">Current Package</button>
            <button class="tab-btn" data-tab="proposed_package">Proposed Package</button>
            <button class="tab-btn" data-tab="financial_impact">Financial Impact</button>
        </div>
        <div class="tab-content">
            <!-- Employee Details Tab -->
            <div class="tab-pane active" id="employee">
                <div class="table-wrap">
                    <table border="1" cellpadding="8" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>SR.No</th>
                                <th>Full Name</th>
                                <th>Company</th>
                                <th>Department Group</th>
                                <th>Section</th>
                                <th>Designation</th>
                                <th>Location</th>
                                <th>Date of Joining</th>
                                <th>Resign</th>
                                <th>Date of Resignation</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                                <tr data-employee-id="{{ employee.emp_id }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ employee.fullname|default:"-" }}</td>
                                    <td>{{ employee.company.company_name|default:"-" }}</td>
                                    <td>{{ employee.department_group.name|default:"-" }}</td>
                                    <td>{{ employee.section.name|default:"-" }}</td>
                                    <td>{{ employee.designation.title|default:"-" }}</td>
                                    <td>{{ employee.location.location|default:"-" }}</td>
                                    <td>{{ employee.date_of_joining|date:"Y-m-d"|default:"-" }}</td>
                                    <td>{{ employee.resign|yesno:"Yes,No,-" }}</td>
                                    <td>{{ employee.date_of_resignation|date:"Y-m-d"|default:"-" }}</td>
                                    <td>{{ employee.remarks|default:"-" }}</td>
                                    <td>
                                        {% if perms.user.change_employee %}
                                            <a href="#" class="action-btn edit-btn edit-employee-btn" data-employee-id="{{ employee.emp_id }}">Edit</a>
                                        {% endif %}
                                        {% if perms.user.delete_employee %}
                                            <button class="action-btn delete-btn delete-employee-btn" data-employee-id="{{ employee.emp_id }}">Delete</button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="12" style="text-align: center;">No employees found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Current Package Tab -->
            <div class="tab-pane" id="current_package">
                <div class="table-wrap">
                    <table border="1" cellpadding="8" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>SR.No</th>
                                <th>Full Name</th>
                                <th>Gross Salary</th>
                                <th>Vehicle</th>
                                <th>Fuel Limit</th>
                                <th>Mobile Allowance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                                {% with current_package=employee.currentpackagedetails %}
                                    <tr data-employee-id="{{ employee.emp_id }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ employee.fullname|default:"-" }}</td>
                                        <td>{{ current_package.gross_salary|floatformat:2|default:"-" }}</td>
                                        <td>{{ current_package.vehicle|default:"-" }}</td>
                                        <td>{{ current_package.fuel_limit|floatformat:2|default:"-" }}</td>
                                        <td>{{ current_package.mobile_allowance|floatformat:2|default:"-" }}</td>
                                    </tr>
                                {% endwith %}
                            {% empty %}
                                <tr>
                                    <td colspan="6" style="text-align: center;">No current package details found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Proposed Package Tab -->
            <div class="tab-pane" id="proposed_package">
                <div class="table-wrap">
                    <table border="1" cellpadding="8" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>SR.No</th>
                                <th>Full Name</th>
                                <th>Increment Percentage</th>
                                <th>Increased Amount</th>
                                <th>Revised Salary</th>
                                <th>Increased Fuel Amount</th>
                                <th>Revised Fuel Allowance</th>
                                <th>Mobile Allowance</th>
                                <th>Vehicle</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                                {% with proposed_package=employee.proposedpackagedetails %}
                                    <tr data-employee-id="{{ employee.emp_id }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ employee.fullname|default:"-" }}</td>
                                        <td>{{ proposed_package.increment_percentage|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.increased_amount|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.revised_salary|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.increased_fuel_amount|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.revised_fuel_allowance|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.mobile_allowance|floatformat:2|default:"-" }}</td>
                                        <td>{{ proposed_package.vehicle|default:"-" }}</td>
                                    </tr>
                                {% endwith %}
                            {% empty %}
                                <tr>
                                    <td colspan="9" style="text-align: center;">No proposed package details found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Financial Impact Tab -->
            <div class="tab-pane" id="financial_impact">
                <div class="table-wrap">
                    <table border="1" cellpadding="8" cellspacing="0" width="100%">
                        <thead>
                            <tr>
                                <th>SR.No</th>
                                <th>Full Name</th>
                                <th>Employee Status</th>
                                <th>Serving Years</th>
                                <th>Salary</th>
                                <th>Gratuity</th>
                                <th>Bonus</th>
                                <th>Leave Encashment</th>
                                <th>Mobile Allowance</th>
                                <th>Fuel</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                                {% with financial_impact=employee.financialimpactpermonth %}
                                    <tr data-employee-id="{{ employee.emp_id }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ employee.fullname|default:"-" }}</td>
                                        <td>{{ financial_impact.emp_status.status|default:"-" }}</td>
                                        <td>{{ financial_impact.serving_years|default:"-" }}</td>
                                        <td>{{ financial_impact.salary|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.gratuity|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.bonus|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.leave_encashment|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.mobile_allowance|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.fuel|floatformat:2|default:"-" }}</td>
                                        <td>{{ financial_impact.total|floatformat:2|default:"-" }}</td>
                                    </tr>
                                {% endwith %}
                            {% empty %}
                                <tr>
                                    <td colspan="11" style="text-align: center;">No financial impact details found.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Employee -->
    <div id="createModal" class="popup-overlay" aria-hidden="true" data-company-id="{{ department.company.id }}" data-mode="create">
        <div class="popup-content" role="dialog" aria-modal="true" aria-labelledby="createModalLabel">
            <header class="modal-header">
                <h3 id="createModalLabel">Create New Record</h3>
                <button class="modal-close" type="button" aria-label="Close" id="modalCloseBtn">&times;</button>
            </header>
            <div class="modal-body">
                <form id="createForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Step 1: Employee Details -->
                    <div class="step" id="step-employee">
                        <h4 class="step-title">Step 1: Employee Details</h4>
                        <div class="form-field">
                            <label for="fullname">Full Name <span class="req">*</span></label>
                            <input type="text" id="fullname" name="fullname" required>
                        </div>
                        <div class="form-field">
                            <label for="department_group_id">Department Group <span class="req">*</span></label>
                            <select id="department_group_id" name="department_group_id" required>
                                <option value="">Select Department Group</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="section_id">Section <span class="req">*</span></label>
                            <select id="section_id" name="section_id">
                                <option value="">Select Section</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="designation_id">Designation <span class="req">*</span></label>
                            <div class="inline-group">
                                <select id="designation_id" name="designation_id">
                                    <option value="">Select Designation</option>
                                </select>
                                <label class="inline-check">
                                    <input type="checkbox" id="add_new_designation">
                                    <span>Add New</span>
                                </label>
                            </div>
                            <div class="form-field" id="new_designation_container" style="display: none;">
                                <label for="new_designation_title">New Designation Title</label>
                                <input type="text" id="new_designation_title" name="new_designation_title" placeholder="Enter new designation title" disabled>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="location_id">Location <span class="req">*</span></label>
                            <select id="location_id" name="location_id">
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="form-field split">
                            <div>
                                <label for="date_of_joining">Date of Joining <span class="req">*</span></label>
                                <input type="date" id="date_of_joining" name="date_of_joining">
                            </div>
                            <div>
                                <label for="resign">Resign</label>
                                <select id="resign" name="resign">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field" id="resignation_date_container" style="display: none;">
                            <label for="date_of_resignation">Date of Resignation</label>
                            <input type="date" id="date_of_resignation" name="date_of_resignation" disabled>
                        </div>
                        <div class="form-field">
                            <label for="remarks">Remarks</label>
                            <textarea id="remarks" name="remarks"></textarea>
                        </div>
                        <div class="form-field">
                            <label for="image">Image</label>
                            <input type="file" id="image" name="image" accept="image/*">
                        </div>
                    </div>
                    
                    <!-- Step 2: Current Package -->
                    <div class="step hidden" id="step-current_package">
                        <h4 class="step-title">Step 2: Current Package Details</h4>
                        <div class="form-field">
                            <label for="gross_salary">Gross Salary</label>
                            <input type="number" id="gross_salary" name="gross_salary" step="0.01">
                        </div>
                        <div class="form-field">
                            <label for="vehicle_id">Vehicle</label>
                            <select id="vehicle_id" name="vehicle_id">
                                <option value="">Select Vehicle</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="fuel_limit">Fuel Limit</label>
                            <input type="number" id="fuel_limit" name="fuel_limit" step="0.01">
                        </div>
                        <div class="form-field">
                            <label for="mobile_allowance">Mobile Allowance</label>
                            <input type="number" id="mobile_allowance" name="mobile_allowance" step="0.01">
                        </div>
                    </div>
                    
                    <!-- Step 3: Proposed Package -->
                    <div class="step hidden" id="step-proposed_package">
                        <h4 class="step-title">Step 3: Proposed Package Details</h4>
                        <div class="form-field">
                            <label for="increment_percentage">Increment Percentage</label>
                            <input type="number" id="increment_percentage" name="increment_percentage" step="0.01">
                        </div>
                        <div class="form-field">
                            <label for="increased_fuel_amount">Increased Fuel Amount</label>
                            <input type="number" id="increased_fuel_amount" name="increased_fuel_amount" step="0.01">
                        </div>
                        <div class="form-field">
                            <label for="mobile_allowance_proposed">Mobile Allowance</label>
                            <input type="number" id="mobile_allowance_proposed" name="mobile_allowance_proposed" step="0.01">
                        </div>
                        <div class="form-field">
                            <label for="vehicle_proposed_id">Vehicle</label>
                            <select id="vehicle_proposed_id" name="vehicle_proposed">
                                <option value="">Select Vehicle</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Step 4: Financial Impact -->
                    <div class="step hidden" id="step-financial_impact">
                        <h4 class="step-title">Step 4: Financial Impact Details</h4>
                        <div class="form-field">
                            <label for="emp_status_id">Employee Status</label>
                            <select id="emp_status_id" name="emp_status_id">
                                <option value="">Select Employee Status</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Hidden Fields -->
                    <input type="hidden" name="step" id="step">
                    <input type="hidden" name="employee_id" id="employee_id">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                </form>
            </div>
            <footer class="modal-footer">
                <button type="button" class="form-btn btn-back hidden" id="prevBtn">Previous</button>
                <button type="button" class="form-btn btn-submit" id="nextBtn" onclick="confirmNext()">Next</button>
                <button type="button" class="form-btn btn-submit hidden" id="submitBtn" onclick="handleSubmit()">Submit</button>
                <button type="button" class="form-btn btn-back" id="modalCancelBtn">Cancel</button>
            </footer>
        </div>
    </div>

    <style>
        /* Adding button-group to match Add User styling */
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        /* Section Heading */
        .section-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-head h2 {
            margin: 0;
            font-size: 24px;
            color: #343a40;
        }

        /* Table Styling */
        table {
            border-collapse: collapse;
            margin-top: 15px;
            width: 100%;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border: 1px solid #dee2e6;
        }
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f3f5;
        }

        /* Tabbed Interface */
        .tab-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-top: 20px;
        }
        .tab-header {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 16px;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            color: #343a40;
            transition: background-color 0.2s;
        }
        .tab-btn.active, .tab-btn:hover {
            background-color: #e9ecef;
            border-bottom: 2px solid #007bff;
        }
        .tab-content {
            max-height: 500px;
            overflow-y: auto;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        /* Buttons */
        .form-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background-color 0.2s;
        }
        .btn-add {
            background-color: #28a745;
            color: #fff;
        }
        .btn-add:hover {
            background-color: #218838;
        }
        .btn-submit {
            background-color: #28a745;
            color: #fff;
        }
        .btn-submit:hover {
            background-color: #218838;
        }
        .btn-back {
            background-color: #6c757d;
            color: #fff;
        }
        .btn-back:hover {
            background-color: #5a6268;
        }
        .action-btn {
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            display: inline-block;
            margin-right: 5px;
        }
        .edit-btn {
            background-color: #007bff;
        }
        .edit-btn:hover {
            background-color: #0056b3;
        }
        .delete-btn {
            background-color: #dc3545;
            border: none;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }

        /* Modal Styling */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .popup-overlay.show {
            display: flex;
        }
        .popup-content {
            background: #fff;
            width: min(960px, 94vw);
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
        }
        .modal-close {
            background: transparent;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #343a40;
        }
        .modal-close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 16px;
        }
        .modal-footer {
            padding: 12px 16px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Confirmation Modal Styling */
        .confirm-popup {
            background: #fff;
            width: min(960px, 94vw);
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            padding: 16px;
            text-align: center;
        }
        .confirm-popup p {
            margin: 0 0 20px;
            font-size: 16px;
        }
        .confirm-popup .form-btn {
            min-width: 100px;
        }

        /* Form Fields */
        .form-field {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-field label {
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }
        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-field textarea {
            min-height: 90px;
            resize: vertical;
        }
        .inline-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .inline-check {
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
        }
        .req {
            color: #dc3545;
        }
        .step {
            /* Controlled via JavaScript */
        }
        .step-title {
            font-size: 18px;
            margin-bottom: 16px;
            color: #343a40;
        }
        .hidden {
            display: none !important;
        }
        .form-field.split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Responsive Design */
        @media screen and (max-width: 768px) {
            table, th, td {
                font-size: 14px;
            }
            .form-btn, .action-btn {
                font-size: 12px;
                padding: 8px 12px;
            }
            .tab-header {
                flex-wrap: wrap;
            }
            .tab-btn {
                flex: 1;
                text-align: center;
            }
            .form-field input,
            .form-field select,
            .form-field textarea {
                font-size: 14px;
                padding: 10px;
            }
        }
        @media screen and (max-width: 500px) {
            .form-btn {
                font-size: 12px;
                padding: 10px;
            }
            .form-field.split {
                grid-template-columns: 1fr;
            }
            .confirm-popup {
                width: 90vw;
                max-width: 400px;
            }
        }
    </style>

    <script>
        // Modal Helpers
        const modal = document.getElementById('createModal');
        const closeBtn = document.getElementById('modalCloseBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');
        const modalTitle = document.getElementById('createModalLabel');
        const form = document.getElementById('createForm');
        const formDataStore = {}; // Store form data for each step

        function openModal(mode = 'create') {
            modal.dataset.mode = mode;
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            currentStep = 0;
            formDataStore[currentStep] = formDataStore[currentStep] || {};
            showStep(currentStep);
            updateResignationFieldVisibility();
            updateDesignationFieldVisibility();
        }

        function closeModal() {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            modal.dataset.mode = 'create';
            modalTitle.textContent = 'Create New Record';
            delete modal.dataset.employeeId;
            form.reset();
            document.getElementById('employee_id').value = '';
            document.getElementById('add_new_designation').checked = false;
            document.getElementById('new_designation_title').disabled = true;
            document.getElementById('designation_id').disabled = false;
            document.getElementById('date_of_resignation').disabled = true;
            updateResignationFieldVisibility();
            updateDesignationFieldVisibility();
            currentStep = 0;
            Object.keys(formDataStore).forEach(key => delete formDataStore[key]); // Clear stored data
            showStep(currentStep);
        }

        closeBtn?.addEventListener('click', closeModal);
        cancelBtn?.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Tabbed Interface
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Data Fetching
        const companyId = modal.dataset.companyId;

        async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            try {
                console.log(`Fetching URL: ${url}`);
                const res = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                    },
                    signal: controller.signal,
                    ...opts,
                });
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const data = await res.json();
                console.log(`Response from ${url}:`, data);
                return data;
            } catch (err) {
                clearTimeout(timeoutId);
                console.error(`Error fetching ${url}:`, err);
                showSnackbar(`Error: ${err.message}`, '#dc3545');
                throw err;
            }
        }

        function asArray(payload) {
            console.log('Processing payload:', payload);
            if (Array.isArray(payload)) return payload;
            if (payload && Array.isArray(payload.data)) return payload.data;
            if (payload && Array.isArray(payload.results)) return payload.results;
            if (payload && Array.isArray(payload.items)) return payload.items;
            console.warn('No array found in payload, returning empty array');
            return [];
        }

        async function fetchDropdownData() {
            console.log('Fetching dropdown data for company:', companyId);
            if (!companyId) {
                console.error('Company ID is missing');
                showSnackbar('Company ID is missing', '#dc3545');
                return;
            }
            try {
                const raw = await fetchJSON('/payroll/department-groups-sections/');
                const list = asArray(raw);
                if (!Array.isArray(list)) {
                    console.error('Invalid department groups data:', raw);
                    showSnackbar('No department groups available', '#dc3545');
                    window.departmentGroups = [];
                    return;
                }
                console.log('Department groups:', list);
                populateDepartmentGroups(list);
            } catch (e) {
                console.error('Error fetching department groups:', e);
                showSnackbar('Error loading department groups', '#dc3545');
                window.departmentGroups = [];
            }

            try {
                const [designationsRaw, locationsRaw, vehiclesRaw, statusRaw] = await Promise.all([
                    fetchJSON(`/payroll/designations/?company_id=${companyId}`),
                    fetchJSON('/payroll/locations/'),
                    fetchJSON('/payroll/vehicles-dropdown/'),
                    fetchJSON('/payroll/employee-status-choices/'),
                ]);
                const designations = asArray(designationsRaw);
                const locations = asArray(locationsRaw);
                const vehicles = asArray(vehiclesRaw);
                const statuses = asArray(statusRaw);

                console.log('Designations:', designations);
                console.log('Locations:', locations);
                console.log('Vehicles:', vehicles);
                console.log('Statuses:', statuses);

                if (designationsRaw.error || !designations) {
                    console.error('Invalid designations data:', designationsRaw);
                    showSnackbar(designationsRaw.error || 'Invalid designations data', '#dc3545');
                } else {
                    populateDesignations(designations);
                }
                if (locationsRaw.error || !locations) {
                    console.error('Invalid locations data:', locationsRaw);
                    showSnackbar(locationsRaw.error || 'Invalid locations data', '#dc3545');
                } else {
                    populateLocations(locations);
                }
                if (vehiclesRaw.error || !vehicles) {
                    console.error('Invalid vehicles data:', vehiclesRaw);
                    showSnackbar('No vehicles available', '#dc3545');
                } else {
                    populateVehicles(vehicles);
                }
                if (statusRaw.error || !statuses) {
                    console.error('Invalid employee status data:', statusRaw);
                    showSnackbar(statusRaw.error || 'No employee status choices available', '#dc3545');
                } else {
                    populateEmployeeStatusDropdown(statuses);
                }
            } catch (e) {
                console.error('Error fetching dropdown data:', e);
                showSnackbar('Error loading dropdown data', '#dc3545');
            }
        }

        function populateDepartmentGroups(data) {
            const select = document.getElementById('department_group_id');
            select.innerHTML = '<option value="">Select Department Group</option>';
            window.departmentGroups = [];
            data.forEach(dept => {
                const opt = document.createElement('option');
                opt.value = dept.id;
                opt.textContent = dept.name;
                select.appendChild(opt);
                window.departmentGroups.push({ id: dept.id, name: dept.name, sections: dept.sections || [] });
            });
            console.log('Populated department groups:', window.departmentGroups);
        }

        function populateDesignations(data) {
            const select = document.getElementById('designation_id');
            select.innerHTML = '<option value="">Select Designation</option>';
            data.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = d.title;
                select.appendChild(opt);
            });
            console.log('Populated designations:', data);
        }

        function populateLocations(data) {
            const select = document.getElementById('location_id');
            select.innerHTML = '<option value="">Select Location</option>';
            data.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.location;
                select.appendChild(opt);
            });
            console.log('Populated locations:', data);
        }

        function populateVehicles(data) {
            const currentSelect = document.getElementById('vehicle_id');
            const proposedSelect = document.getElementById('vehicle_proposed_id');
            currentSelect.innerHTML = '<option value="">Select Vehicle</option>';
            proposedSelect.innerHTML = '<option value="">Select Vehicle</option>';
            data.forEach(v => {
                const plateText = `Number Plate (${v.registration_number && v.registration_number.trim() ? v.registration_number : 'Not Assigned'})`;
                const label = `${v.brand_name} ${v.model_name} ${v.year} (${v.condition}) - ${plateText}`;
                const opt1 = document.createElement('option');
                opt1.value = v.id;
                opt1.textContent = label;
                currentSelect.appendChild(opt1);
                const opt2 = opt1.cloneNode(true);
                proposedSelect.appendChild(opt2);
            });
            console.log('Populated vehicles:', data);
        }

        function populateEmployeeStatusDropdown(data) {
            const select = document.getElementById('emp_status_id');
            select.innerHTML = '<option value="">Select Employee Status</option>';
            window.employeeStatusChoices = [];
            data.forEach(choice => {
                const opt = document.createElement('option');
                opt.value = choice.id;
                opt.textContent = choice.status;
                select.appendChild(opt);
                window.employeeStatusChoices.push({ id: choice.id, status: choice.status });
            });
            console.log('Populated employee statuses:', data);
        }

        function populateSections(groupId) {
            const select = document.getElementById('section_id');
            select.innerHTML = '<option value="">Select Section</option>';
            if (!window.departmentGroups) {
                console.error('window.departmentGroups is undefined');
                showSnackbar('Department groups not loaded', '#dc3545');
                return;
            }
            if (groupId) {
                const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
                if (group && group.sections) {
                    group.sections.forEach(section => {
                        const opt = document.createElement('option');
                        opt.value = section.id;
                        opt.textContent = section.name;
                        select.appendChild(opt);
                    });
                    console.log('Populated sections for group', groupId, ':', group.sections);
                } else {
                    console.warn('No sections found for group ID:', groupId);
                }
            }
        }

        // Form Interactivity
        const resignDropdown = document.getElementById('resign');
        const resignationInput = document.getElementById('date_of_resignation');
        const resignationContainer = document.getElementById('resignation_date_container');
        const addNewDesignationCheckbox = document.getElementById('add_new_designation');
        const newDesignationInput = document.getElementById('new_designation_title');
        const newDesignationContainer = document.getElementById('new_designation_container');
        const designationSelect = document.getElementById('designation_id');

        function updateResignationFieldVisibility() {
            const isResigned = resignDropdown.value === 'true';
            resignationContainer.style.display = isResigned ? 'block' : 'none';
            resignationInput.disabled = !isResigned;
            if (!isResigned) resignationInput.value = '';
        }

        function updateDesignationFieldVisibility() {
            const isAddNew = addNewDesignationCheckbox.checked;
            newDesignationContainer.style.display = isAddNew ? 'block' : 'none';
            newDesignationInput.disabled = !isAddNew;
            designationSelect.disabled = isAddNew;
            if (!isAddNew) {
                newDesignationInput.value = '';
                designationSelect.value = '';
            }
        }

        resignDropdown.addEventListener('change', updateResignationFieldVisibility);
        addNewDesignationCheckbox.addEventListener('change', updateDesignationFieldVisibility);

        document.getElementById('department_group_id').addEventListener('change', function () {
            populateSections(this.value);
        });

        async function createNewDesignation() {
            const title = newDesignationInput.value.trim();
            if (!title) {
                showSnackbar('Please enter a designation title', '#dc3545');
                return null;
            }
            try {
                const res = await fetch('/payroll/designations/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ title, company: companyId }),
                });
                if (!res.ok) throw new Error('Failed to create designation');
                const result = await res.json();
                if (result.error) {
                    showSnackbar(result.error, '#dc3545');
                    return null;
                }
                console.log('Created new designation:', result);
                return result;
            } catch (e) {
                console.error('Error creating designation:', e);
                showSnackbar('Error creating designation', '#dc3545');
                return null;
            }
        }

        function validateEmployeeStep() {
            const errors = [];
            const q = sel => form.querySelector(sel);
            if (!q('#fullname').value.trim()) errors.push('Full Name is required');
            if (!q('#department_group_id').value) errors.push('Department Group is required');
            if (!q('#section_id').value) errors.push('Section is required');
            if (!q('#location_id').value) errors.push('Location is required');
            if (!q('#date_of_joining').value) errors.push('Date of Joining is required');
            if (q('#resign').value === 'true' && !q('#date_of_resignation').value.trim()) errors.push('Date of Resignation is required');
            if (addNewDesignationCheckbox.checked && !newDesignationInput.value.trim()) errors.push('New Designation Title is required');
            if (!addNewDesignationCheckbox.checked && !designationSelect.value) errors.push('Designation is required');
            return errors;
        }

        async function fetchEmployeeData(employeeId) {
            try {
                const data = await fetchJSON(`/payroll/get-data/employee/${employeeId}/`);
                console.log('Fetched employee data:', data);
                if (data.error || !data.data || !data.data.employee) {
                    console.error('Invalid response structure:', data);
                    showSnackbar(data.error || 'Invalid employee data', '#dc3545');
                    return null;
                }
                return data.data;
            } catch (e) {
                console.error('Error fetching employee data:', e);
                showSnackbar('Error fetching employee data', '#dc3545');
                return null;
            }
        }

        function populateForm(data) {
            console.log('Populating form with data:', data);
            if (!data || !data.employee) {
                showSnackbar('No employee data available', '#dc3545');
                return;
            }
            const q = sel => form.querySelector(sel);
            q('#fullname').value = data.employee.fullname || '';
            q('#department_group_id').value = data.employee.department_group_id || '';
            populateSections(data.employee.department_group_id);
            q('#section_id').value = data.employee.section_id || '';
            q('#designation_id').value = data.employee.designation_id || '';
            addNewDesignationCheckbox.checked = false;
            updateDesignationFieldVisibility();
            q('#location_id').value = data.employee.location_id || '';
            q('#date_of_joining').value = data.employee.date_of_joining || '';
            q('#resign').value = data.employee.resign ? 'true' : 'false';
            updateResignationFieldVisibility();
            q('#date_of_resignation').value = data.employee.date_of_resignation || '';
            q('#remarks').value = data.employee.remarks || '';
            q('#gross_salary').value = data.current_package?.gross_salary || '';
            q('#vehicle_id').value = data.current_package?.vehicle_id || '';
            q('#fuel_limit').value = data.current_package?.fuel_limit || '';
            q('#mobile_allowance').value = data.current_package?.mobile_allowance || '';
            q('#increment_percentage').value = data.proposed_package?.increment_percentage || '';
            q('#increased_fuel_amount').value = data.proposed_package?.increased_fuel_amount || '';
            q('#mobile_allowance_proposed').value = data.proposed_package?.mobile_allowance || '';
            q('#vehicle_proposed_id').value = data.proposed_package?.vehicle_id || '';
            q('#emp_status_id').value = data.financial_impact?.emp_status_id || '';
            // Store initial data for edit mode
            if (modal.dataset.mode === 'edit') {
                formDataStore[0] = { ...formDataStore[0], fullname: q('#fullname').value, department_group_id: q('#department_group_id').value, section_id: q('#section_id').value, designation_id: q('#designation_id').value, location_id: q('#location_id').value, date_of_joining: q('#date_of_joining').value, resign: q('#resign').value, date_of_resignation: q('#date_of_resignation').value, remarks: q('#remarks').value };
                formDataStore[1] = { ...formDataStore[1], gross_salary: q('#gross_salary').value, vehicle_id: q('#vehicle_id').value, fuel_limit: q('#fuel_limit').value, mobile_allowance: q('#mobile_allowance').value };
                formDataStore[2] = { ...formDataStore[2], increment_percentage: q('#increment_percentage').value, increased_fuel_amount: q('#increased_fuel_amount').value, mobile_allowance_proposed: q('#mobile_allowance_proposed').value, vehicle_proposed_id: q('#vehicle_proposed_id').value };
                formDataStore[3] = { ...formDataStore[3], emp_status_id: q('#emp_status_id').value };
            }
            console.log('Form populated, checking values:', {
                fullname: q('#fullname').value,
                department_group_id: q('#department_group_id').value,
                section_id: q('#section_id').value,
                designation_id: q('#designation_id').value,
                location_id: q('#location_id').value,
            });
        }

        // Multi-step Form Logic
        const steps = ['employee', 'current_package', 'proposed_package', 'financial_impact'];
        let currentStep = 0;

        function showStep(stepIndex) {
            document.querySelectorAll('.step').forEach((el, i) => {
                el.classList.toggle('hidden', i !== stepIndex);
            });
            document.getElementById('step').value = steps[stepIndex];
            document.getElementById('prevBtn').classList.toggle('hidden', stepIndex === 0);
            document.getElementById('nextBtn').classList.toggle('hidden', stepIndex === steps.length - 1);
            document.getElementById('submitBtn').classList.toggle('hidden', stepIndex !== steps.length - 1);
            const mode = modal.dataset.mode === 'edit' ? 'Edit Record' : 'Create New Record';
            modalTitle.textContent = `${mode} - Step ${stepIndex + 1}`;
            // Repopulate form with stored data
            if (formDataStore[stepIndex]) {
                const q = sel => form.querySelector(sel);
                for (const [key, value] of Object.entries(formDataStore[stepIndex])) {
                    const input = q(`#${key}`);
                    if (input) {
                        input.value = value || '';
                        if (key === 'department_group_id' && value) populateSections(value);
                        if (key === 'resign') updateResignationFieldVisibility();
                        if (key === 'designation_id' || key === 'new_designation_title') updateDesignationFieldVisibility();
                    }
                }
            }
        }

        function storeFormData(stepIndex) {
            const formData = new FormData(form);
            const data = {};
            for (const [key, value] of formData.entries()) {
                if (!['step', 'employee_id', 'csrfmiddlewaretoken'].includes(key)) {
                    data[key] = value;
                }
            }
            formDataStore[stepIndex] = data;
            console.log('Stored form data for step', stepIndex, ':', formDataStore[stepIndex]);
        }

        // Previous Button Handler
        function handlePrevious() {
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
            }
        }

        document.getElementById('prevBtn').addEventListener('click', handlePrevious);

        // Next Button with Validation and Confirmation
        function confirmNext() {
            if (modal.dataset.mode === 'create' && currentStep === 0) {
                const errors = validateEmployeeStep();
                if (errors.length) {
                    showSnackbar(`Please fix the following errors: ${errors.join(', ')}`, '#dc3545');
                    return;
                }
            }
            showConfirmPopup('Are you sure you want to proceed to the next step?', async () => {
                await handleNext();
            });
        }

        async function handleFormSubmission(formData, step) {
            if (step === 'employee') {
                const errors = validateEmployeeStep();
                if (errors.length) {
                    showSnackbar(`Please fix the following errors: ${errors.join(', ')}`, '#dc3545');
                    return null;
                }
                if (addNewDesignationCheckbox.checked) {
                    const created = await createNewDesignation();
                    if (created) {
                        formData.set('designation_id', created.id);
                        try {
                            const data = await fetchJSON(`/payroll/designations/?company_id=${companyId}`);
                            populateDesignations(asArray(data));
                            designationSelect.value = created.id;
                        } catch (e) {
                            console.error('Error refreshing designations:', e);
                        }
                    } else {
                        return null;
                    }
                }
            }
            return formData;
        }

        async function handleNext() {
            let formData = new FormData(form);
            formData = await handleFormSubmission(formData, steps[currentStep]);
            if (!formData) return;

            const isEdit = modal.dataset.mode === 'edit';
            const url = isEdit ? `/payroll/update-data/{{ department_id }}/` : `/payroll/create-data/{{ department_id }}/`;
            if (isEdit) formData.append('employee_id', modal.dataset.employeeId);

            try {
                let headers = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
                let body = formData;
                let method = isEdit ? 'PATCH' : 'POST';

                if (isEdit) {
                    headers['X-CSRFToken'] = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    headers['Content-Type'] = 'application/json';
                    const obj = {};
                    for (const [k, v] of formData.entries()) {
                        if (k !== 'csrfmiddlewaretoken') obj[k] = v;
                    }
                    body = JSON.stringify(obj);
                }

                const res = await fetch(url, { method, headers, body });
                if (!res.ok) throw new Error('Failed to save step');
                const result = await res.json();
                if (result.error) {
                    showSnackbar(result.error, '#dc3545');
                    return;
                }
                if (result.employee_id) document.getElementById('employee_id').value = result.employee_id;

                // Store form data before advancing
                storeFormData(currentStep);
                currentStep++;
                if (currentStep < steps.length) {
                    showStep(currentStep);
                    if (!isEdit) {
                        // Only clear fields for create mode if no stored data
                        if (!formDataStore[currentStep]) {
                            form.querySelectorAll('input:not([type="hidden"]), textarea, select').forEach(input => {
                                if (['employee_id', 'step', 'csrfmiddlewaretoken'].includes(input.id)) return;
                                input.value = '';
                            });
                            addNewDesignationCheckbox.checked = false;
                            updateDesignationFieldVisibility();
                            resignDropdown.value = 'false';
                            updateResignationFieldVisibility();
                        }
                    }
                }
            } catch (e) {
                console.error('Error saving step:', e);
                showSnackbar('Error saving step', '#dc3545');
            }
        }

        async function handleSubmit() {
            let formData = new FormData(form);
            formData = await handleFormSubmission(formData, steps[currentStep]);
            if (!formData) return;

            const isEdit = modal.dataset.mode === 'edit';
            const url = isEdit ? `/payroll/update-data/{{ department_id }}/` : `/payroll/create-data/{{ department_id }}/`;
            if (isEdit) formData.append('employee_id', modal.dataset.employeeId);

            try {
                let headers = { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' };
                let body = formData;
                let method = isEdit ? 'PATCH' : 'POST';

                if (isEdit) {
                    headers['X-CSRFToken'] = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                    headers['Content-Type'] = 'application/json';
                    const obj = {};
                    for (const [k, v] of formData.entries()) {
                        if (k !== 'csrfmiddlewaretoken') obj[k] = v;
                    }
                    body = JSON.stringify(obj);
                }

                const res = await fetch(url, { method, headers, body });
                if (!res.ok) throw new Error('Failed to save final step');
                const result = await res.json();
                if (result.error) {
                    showSnackbar(result.error, '#dc3545');
                } else {
                    closeModal();
                    showSnackbar('Saved successfully', '#28a745');
                    window.location.reload();
                }
            } catch (e) {
                console.error('Error saving final step:', e);
                showSnackbar('Error saving final step', '#dc3545');
            }
        }

        function bindRowActions() {
            document.querySelectorAll('.edit-employee-btn').forEach(btn => {
                btn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const employeeId = this.dataset.employeeId;
                    console.log('Edit button clicked for employee ID:', employeeId);
                    if (!employeeId) {
                        showSnackbar('Invalid employee ID', '#dc3545');
                        return;
                    }
                    if (!window.departmentGroups || !window.employeeStatusChoices) {
                        console.log('Fetching dropdown data before editing');
                        await fetchDropdownData();
                    }
                    const data = await fetchEmployeeData(employeeId);
                    if (data) {
                        modal.dataset.mode = 'edit';
                        modal.dataset.employeeId = employeeId;
                        modalTitle.textContent = 'Edit Record - Step 1';
                        populateForm(data);
                        openModal('edit');
                    }
                });
            });

            document.querySelectorAll('.delete-employee-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const employeeId = this.dataset.employeeId;
                    console.log('Delete button clicked for employee ID:', employeeId);
                    if (!employeeId) {
                        showSnackbar('Invalid employee ID', '#dc3545');
                        return;
                    }
                    showConfirmPopup('Are you sure you want to delete this employee?', async () => {
                        try {
                            const res = await fetch(`/payroll/delete-data/employee/${employeeId}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                                    'Accept': 'application/json',
                                },
                            });
                            if (!res.ok) throw new Error('Failed to delete employee');
                            const out = await res.json();
                            if (out.error) {
                                showSnackbar(out.error, '#dc3545');
                            } else {
                                showSnackbar('Deleted successfully', '#28a745');
                                window.location.reload();
                            }
                        } catch (e) {
                            console.error('Error deleting employee:', e);
                            showSnackbar('Error deleting employee', '#dc3545');
                        }
                    });
                });
            });
        }

        // Initialize on DOM Ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing...');
            fetchDropdownData();
            bindRowActions();
            updateResignationFieldVisibility();
            updateDesignationFieldVisibility();
        });
    </script>
{% else %}
    <p>You do not have permission to view this page.</p>
{% endif %}
{% endblock %}