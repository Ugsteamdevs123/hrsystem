{% extends 'base.html' %}
{% block title %}Company Summary - {{ company.name }}{% endblock %}

{% block content %}
<div style="margin-top:40px;">
    <h1 style="margin-bottom:20px; color:#0d6efd;">Company Summary - {{ company.name }}</h1>

    <div style="background:#f8f9fa; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1);">
        <h5 style="margin-bottom:15px;">Summary Table</h5>
        <div id="table-container">
            {{ table_html | safe }}
        </div>
    </div>
</div>

<!-- Modal for editing eligible_for_increment -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; position:relative;">
        <h5 style="margin-bottom:15px;">Edit Eligible for Increment</h5>
        <form id="editForm">
            <div style="margin-bottom:15px;">
                <label for="eligibleInput" style="display:block; margin-bottom:5px;">Eligible for Increment</label>
                <input type="number" id="eligibleInput" name="eligible_for_increment" style="width:100%; padding:6px 8px; border-radius:4px; border:1px solid #ced4da;" required>
                <input type="hidden" id="summaryId" name="id">
            </div>
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
        </form>
        <div style="text-align:right;">
            <button id="cancelBtn" style="padding:6px 12px; margin-right:10px; border:none; border-radius:4px; background:#6c757d; color:#fff; cursor:pointer;">Cancel</button>
            <button id="submitBtn" style="padding:6px 12px; border:none; border-radius:4px; background:#0d6efd; color:#fff; cursor:pointer;">Submit</button>
        </div>
    </div>
</div>

<style>
    /* Custom table styling */
    .custom-table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
    }
    .custom-table th, .custom-table td {
        min-width: 120px;
        max-width: 300px;
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
    }
    .custom-table th {
        background-color: #e9ecef;
    }
    .custom-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    .custom-table tr:nth-child(odd) {
        background-color: #ffffff;
    }
    .custom-table .btn-edit, .custom-table .btn-save, .custom-table .btn-delete {
        padding: 4px 8px;
        margin-right: 5px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 13px;
    }
    .btn-edit { background:#0d6efd; color:#fff; }
    .btn-save { background:#198754; color:#fff; }
    .btn-delete { background:#dc3545; color:#fff; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('editModal');
    const cancelBtn = document.getElementById('cancelBtn');

    // Show modal
    function showModal() { modal.style.display = 'flex'; }
    // Hide modal
    function hideModal() { modal.style.display = 'none'; }

    cancelBtn.addEventListener('click', hideModal);

    // Open modal for editing
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function () {
            const row = this.closest('tr');
            const id = row.dataset.id;
            const eligibleValue = row.dataset.eligible;
            document.getElementById('summaryId').value = id;
            document.getElementById('eligibleInput').value = eligibleValue;
            showModal();
        });
    });

    // Submit changes
    document.getElementById('submitBtn').addEventListener('click', async function () {
        const id = document.getElementById('summaryId').value;
        const value = document.getElementById('eligibleInput').value.trim();
        if (!value || isNaN(value)) {
            alert('Please enter a valid number');
            return;
        }

        try {
            const formData = new FormData(document.getElementById('editForm'));
            const entries = {};
            for (const [key, val] of formData.entries()) {
                if (key === 'csrfmiddlewaretoken') continue;
                entries[key] = val;
            }

            const response = await fetch("/payroll/company-summary/{{ company.id }}/", {
                method: 'PATCH',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entries)
            });

            if (!response.ok) throw new Error(`Failed to update: ${response.statusText}`);
            const result = await response.json();
            if (result.error) {
                alert(result.error);
            }
            hideModal();
            window.location.reload(); // Refresh table after update
        } catch (error) {
            console.error('Error updating summary:', error);
            alert('Error updating summary');
            hideModal();
            window.location.reload();
        }
    });
});
</script>
{% endblock %}
