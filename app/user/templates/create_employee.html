{% extends 'base.html' %}
{% block title %}Create Employee{% endblock %}

{% block content %}
{% if perms.user.add_employee %}
    <div class="section-head">
        <h2>Create New Employee</h2>
    </div>

    <div class="form-container" data-company-id="{{ company_id }}">
        <form id="createForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- Step 1: Employee Details -->
            <div class="step" id="step-employee">
                <h4 class="step-title">Step 1: Employee Details</h4>
                
                <div class="form-field">
                    <label for="emp_id">Employee ID <span class="req">*</span></label>
                    <input type="text" id="emp_id" name="emp_id" required>
                </div>

                <div class="form-field">
                    <label for="fullname">Full Name <span class="req">*</span></label>
                    <input type="text" id="fullname" name="fullname" required>
                </div>

                <div class="form-field">
                    <label for="department_team_id">Department Group <span class="req">*</span></label>
                    <select id="department_team_id" name="department_team_id" required>
                        <option value="">Select Department Group</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="department_group_id">Department <span class="req">*</span></label>
                    <select id="department_group_id" name="department_group_id" required>
                        <option value="">Select Department</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="section_id">Section <span class="req">*</span></label>
                    <select id="section_id" name="section_id">
                        <option value="">Select Section</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="designation_id">Designation <span class="req">*</span></label>
                    <div class="inline-group">
                        <select id="designation_id" name="designation_id">
                            <option value="">Select Designation</option>
                        </select>
                        <label class="inline-check">
                            <input type="checkbox" id="add_new_designation">
                            <span>Add New</span>
                        </label>
                    </div>
                    <div class="form-field" id="new_designation_container" style="display: none;">
                        <label for="new_designation_title">New Designation Title</label>
                        <input type="text" id="new_designation_title" name="new_designation_title" placeholder="Enter new designation title" disabled>
                    </div>
                </div>

                <div class="form-field">
                    <label for="location_id">Location <span class="req">*</span></label>
                    <select id="location_id" name="location_id">
                        <option value="">Select Location</option>
                    </select>
                </div>
                
                <div class="form-field">
                    <label for="date_of_joining">Date of Joining <span class="req">*</span></label>
                    <input type="date" id="date_of_joining" name="date_of_joining">
                </div>

                <div class="form-field" id="resignation_date_container" style="display: none;">
                    <label for="date_of_resignation">Date of Resignation</label>
                    <input type="date" id="date_of_resignation" name="date_of_resignation" disabled>
                </div>

                <div class="form-field">
                    <label for="image">Image</label>
                    <input type="file" id="image" name="image" accept="image/*">
                </div>
            </div>

            <!-- Step 2: Current Package -->
            <div class="step hidden" id="step-current_package">
                <h4 class="step-title">Step 2: Current Package Details</h4>
                <div class="form-field">
                    <label for="gross_salary">Gross Salary</label>
                    <input type="number" id="gross_salary" name="gross_salary" step="0.01">
                </div>

                <div class="form-field">
                    <label for="company_pickup">Company Pickup</label>
                    <div class="inline-group">
                        <label class="inline-check">
                            <input type="radio" name="company_pickup" value="true"> Yes
                        </label>
                        <label class="inline-check">
                            <input type="radio" name="company_pickup" value="false" checked> No
                        </label>
                    </div>
                </div>

                <div class="form-field">
                    <label for="vehicle_id">Vehicle</label>
                    <select id="vehicle_id" name="vehicle_id">
                        <option value="">Select Vehicle</option>
                    </select>
                </div>

                <div class="form-field">
                    <label for="mobile_provided">Mobile Provided</label>
                    <div class="inline-group">
                        <label class="inline-check">
                            <input type="radio" name="mobile_provided" value="true"> Yes
                        </label>
                        <label class="inline-check">
                            <input type="radio" name="mobile_provided" value="false" checked> No
                        </label>
                    </div>
                </div>

                <div class="form-field">
                    <label for="fuel_allowance">Fuel Allowance</label>
                    <input type="number" id="fuel_allowance" name="fuel_allowance" step="0.01">
                </div>

                <div class="form-field">
                    <label for="fuel_litre">Fuel (Litres)</label>
                    <input type="number" id="fuel_litre" name="fuel_litre" step="0.01">
                </div>
            </div>

            <!-- Step 4: Financial Impact -->
            <div class="step hidden" id="step-financial_impact">
                <h4 class="step-title">Step 3: Financial Impact Details</h4>
                <div class="form-field">
                    <label for="emp_status_id">Employee Status</label>
                    <select id="emp_status_id" name="emp_status_id">
                        <option value="">Select Employee Status</option>
                    </select>
                </div>
            </div>

            <!-- Hidden Fields -->
            <input type="hidden" name="step" id="step">
            <input type="hidden" name="employee_id" id="employee_id">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <input type="hidden" name="company_id" id="company_id" value="{{ company_id }}">
            <input type="hidden" name="is_update" id="is_update" value="false">
            <input type="hidden" name="original_emp_id" id="original_emp_id" value="">

            <div class="form-footer">
                <button type="button" class="form-btn btn-back hidden" id="prevBtn">Previous</button>
                <button type="button" class="form-btn btn-submit" id="nextBtn" onclick="confirmNext()">Next</button>
                <button type="button" class="form-btn btn-submit hidden" id="submitBtn" onclick="handleSubmit()">Submit</button>
                <a href="{% url 'employees_view' %}" class="form-btn btn-back">Cancel</a>
            </div>
        </form>
    </div>

    <style>
        .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-head h2 { margin: 0; font-size: 24px; color: #343a40; }
        .form-container { background: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); padding: 16px; margin-top: 20px; }
        .form-btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 5px; transition: background-color 0.2s; }
        .btn-submit { background-color: #28a745; color: #fff; }
        .btn-submit:hover { background-color: #218838; }
        .btn-back { background-color: #6c757d; color: #fff; }
        .btn-back:hover { background-color: #5a6268; }
        .form-field { margin-bottom: 15px; text-align: left; }
        .form-field label { font-weight: 500; margin-bottom: 6px; display: block; }
        .form-field input, .form-field select, .form-field textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .form-field textarea { min-height: 90px; resize: vertical; }
        .inline-group { display: flex; align-items: center; gap: 10px; }
        .inline-check { display: flex; align-items: center; gap: 6px; user-select: none; }
        .req { color: #dc3545; }
        .step-title { font-size: 18px; margin-bottom: 16px; color: #343a40; }
        .hidden { display: none !important; }
        .form-footer { padding: 12px 16px; border-top: 1px solid #eee; display: flex; gap: 8px; justify-content: flex-end; }
        .confirm-popup { background: #fff; width: min(960px, 94vw); max-width: 500px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); padding: 16px; text-align: center; }
        .confirm-popup p { margin: 0 0 20px; font-size: 16px; }
        .confirm-popup .form-btn { min-width: 100px; }
        @media screen and (max-width: 768px) {
            .form-field input, .form-field select, .form-field textarea { font-size: 14px; padding: 10px; }
            .form-btn { font-size: 12px; padding: 8px 12px; }
        }
        @media screen and (max-width: 500px) {
            .form-field.split { grid-template-columns: 1fr; }
            .form-btn { font-size: 12px; padding: 10px; }
            .confirm-popup { width: 90vw; max-width: 400px; }
        }
    </style>

    <script>
        const form = document.getElementById('createForm');
        const companyId = document.querySelector('#company_id').value;
        const formDataStore = {};
        let currentStep = 0;
        const steps = ['employee', 'current_package', 'financial_impact'];

        async function fetchJSON(url, opts = {}, timeoutMs = 5000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }, signal: controller.signal, ...opts });
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                return await res.json();
            } catch (err) {
                clearTimeout(timeoutId);
                console.error(`Error fetching ${url}:`, err);
                showSnackbar(`Error: ${err.message}`, '#dc3545');
                throw err;
            }
        }

        function asArray(payload) {
            if (Array.isArray(payload)) return payload;
            if (payload && Array.isArray(payload.data)) return payload.data;
            if (payload && Array.isArray(payload.results)) return payload.results;
            if (payload && Array.isArray(payload.items)) return payload.items;
            return [];
        }

        async function fetchDropdownData() {
            if (!companyId) {
                showSnackbar('Company ID is missing', '#dc3545');
                return;
            }
            try {
                const [departmentTeamsRaw, departmentGroupsRaw, designationsRaw, locationsRaw, vehiclesRaw, statusRaw] = await Promise.all([
                    fetchJSON(`/payroll/department-teams/?company_id=${companyId}`),
                    fetchJSON('/payroll/department-groups-sections/'),
                    fetchJSON(`/payroll/designations/?company_id=${companyId}`),
                    fetchJSON('/payroll/locations/'),
                    fetchJSON('/payroll/vehicles-dropdown/'),
                    fetchJSON('/payroll/employee-status-choices/'),
                ]);

                const departmentTeams = asArray(departmentTeamsRaw);
                const departmentGroups = asArray(departmentGroupsRaw);
                const designations = asArray(designationsRaw);
                const locations = asArray(locationsRaw);
                const vehicles = asArray(vehiclesRaw);
                const statuses = asArray(statusRaw);

                if (departmentTeamsRaw.error || !departmentTeams) {
                    showSnackbar(departmentTeamsRaw.error || 'No department teams available', '#dc3545');
                } else {
                    populateDepartmentTeams(departmentTeams);
                }

                if (departmentGroupsRaw.error || !departmentGroups) {
                    showSnackbar('No department groups available', '#dc3545');
                    window.departmentGroups = [];
                } else {
                    populateDepartmentGroups(departmentGroups);
                }

                if (designationsRaw.error || !designations) {
                    showSnackbar(designationsRaw.error || 'Invalid designations data', '#dc3545');
                } else {
                    populateDesignations(designations);
                }

                if (locationsRaw.error || !locations) {
                    showSnackbar(locationsRaw.error || 'Invalid locations data', '#dc3545');
                } else {
                    populateLocations(locations);
                }

                if (vehiclesRaw.error || !vehicles) {
                    showSnackbar('No vehicles available', '#dc3545');
                } else {
                    populateVehicles(vehicles);
                }

                if (statusRaw.error || !statuses) {
                    showSnackbar(statusRaw.error || 'No employee status choices available', '#dc3545');
                } else {
                    populateEmployeeStatusDropdown(statuses);
                }
            } catch (e) {
                showSnackbar('Error loading dropdown data', '#dc3545');
            }
        }

        function populateDepartmentTeams(data) {
            const select = document.getElementById('department_team_id');
            select.innerHTML = '<option value="">Select Department Group</option>';
            data.forEach(team => {
                const opt = document.createElement('option');
                opt.value = team.id;
                opt.textContent = team.name;
                select.appendChild(opt);
            });
        }

        function populateDepartmentGroups(data) {
            const select = document.getElementById('department_group_id');
            select.innerHTML = '<option value="">Select Department</option>';
            window.departmentGroups = [];
            data.forEach(dept => {
                const opt = document.createElement('option');
                opt.value = dept.id;
                opt.textContent = dept.name;
                select.appendChild(opt);
                window.departmentGroups.push({ id: dept.id, name: dept.name, sections: dept.sections || [] });
            });
        }

        function populateDesignations(data) {
            const select = document.getElementById('designation_id');
            select.innerHTML = '<option value="">Select Designation</option>';
            data.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = d.title;
                select.appendChild(opt);
            });
        }

        function populateLocations(data) {
            const select = document.getElementById('location_id');
            select.innerHTML = '<option value="">Select Location</option>';
            data.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.location;
                select.appendChild(opt);
            });
        }

        function populateVehicles(data) {
            const currentSelect = document.getElementById('vehicle_id');
            currentSelect.innerHTML = '<option value="">Select Vehicle</option>';
            data.forEach(v => {
                const label = `${v.brand_name} ${v.model_name} - ${v.engine_cc}`;
                const opt1 = document.createElement('option');
                opt1.value = v.id;
                opt1.textContent = label;
                currentSelect.appendChild(opt1);
                const opt2 = opt1.cloneNode(true);
            });
        }

        function populateEmployeeStatusDropdown(data) {
            const select = document.getElementById('emp_status_id');
            select.innerHTML = '<option value="">Select Employee Status</option>';
            window.employeeStatusChoices = [];
            data.forEach(choice => {
                const opt = document.createElement('option');
                opt.value = choice.id;
                opt.textContent = choice.status;
                select.appendChild(opt);
                window.employeeStatusChoices.push({ id: choice.id, status: choice.status });
            });
        }

        function populateSections(groupId) {
            const select = document.getElementById('section_id');
            select.innerHTML = '<option value="">Select Section</option>';
            if (!window.departmentGroups) {
                // showSnackbar('Department groups not loaded', '#dc3545');
                return;
            }
            if (groupId) {
                const group = window.departmentGroups.find(g => g.id === parseInt(groupId));
                if (group && group.sections) {
                    group.sections.forEach(section => {
                        const opt = document.createElement('option');
                        opt.value = section.id;
                        opt.textContent = section.name;
                        select.appendChild(opt);
                    });
                }
            }
        }

        const resignationInput = document.getElementById('date_of_resignation');
        const resignationContainer = document.getElementById('resignation_date_container');
        const addNewDesignationCheckbox = document.getElementById('add_new_designation');
        const newDesignationInput = document.getElementById('new_designation_title');
        const newDesignationContainer = document.getElementById('new_designation_container');
        const designationSelect = document.getElementById('designation_id');

        function updateDesignationFieldVisibility() {
            const isAddNew = addNewDesignationCheckbox.checked;
            newDesignationContainer.style.display = isAddNew ? 'block' : 'none';
            newDesignationInput.disabled = !isAddNew;
            designationSelect.disabled = isAddNew;
            if (!isAddNew) {
                newDesignationInput.value = '';
                designationSelect.value = '';
            }
        }

        addNewDesignationCheckbox.addEventListener('change', updateDesignationFieldVisibility);
        document.getElementById('department_group_id').addEventListener('change', function () {
            populateSections(this.value);
        });

        async function createNewDesignation() {
            const title = newDesignationInput.value.trim();
            if (!title) {
                showSnackbar('Please enter a designation title', '#dc3545');
                return null;
            }
            try {
                const res = await fetch('/payroll/designations/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ title, company: companyId }),
                });
                if (!res.ok) throw new Error('Failed to create designation');
                const result = await res.json();
                if (result.error) {
                    showSnackbar(result.error, '#dc3545');
                    return null;
                }
                return result;
            } catch (e) {
                showSnackbar('Error creating designation', '#dc3545');
                return null;
            }
        }

        function validateEmployeeStep() {
            const errors = [];
            const q = sel => form.querySelector(sel);
            if (!q('#emp_id').value.trim()) errors.push('Employee ID is required');
            if (!q('#fullname').value.trim()) errors.push('Full Name is required');
            if (!q('#department_team_id').value) errors.push('Department Team is required');
            if (!q('#department_group_id').value) errors.push('Department Group is required');
            if (!q('#section_id').value) errors.push('Section is required');
            if (!q('#location_id').value) errors.push('Location is required');
            if (!q('#date_of_joining').value) errors.push('Date of Joining is required');
            if (addNewDesignationCheckbox.checked && !newDesignationInput.value.trim()) errors.push('New Designation Title is required');
            if (!addNewDesignationCheckbox.checked && !designationSelect.value) errors.push('Designation is required');
            // if (!q('input[name="eligible_for_increment"]:checked')) errors.push('Eligible for Increment is required');
            return errors;
        }

        function validateFinancialImpactStep() {
            const errors = [];
            const q = sel => form.querySelector(sel);
            if (!q('#emp_status_id').value) errors.push('Employee Status is required');
            return errors;
        }

        function showStep(stepIndex) {
    document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('hidden', i !== stepIndex);
    });
    document.getElementById('step').value = steps[stepIndex];
    document.getElementById('prevBtn').classList.toggle('hidden', stepIndex === 0);
    document.getElementById('nextBtn').classList.toggle('hidden', stepIndex === steps.length - 1);
    document.getElementById('submitBtn').classList.toggle('hidden', stepIndex !== steps.length - 1);
    document.querySelector('.section-head h2').textContent = `Create New Employee — Step ${stepIndex + 1}`;
    
    // Restore data for the current step
    if (formDataStore[stepIndex]) {
        restoreStepData(stepIndex);
    } else {
        // Clear form if no stored data
        clearStepData(stepIndex);
    }
}


function clearStepData(stepIndex) {
    // Clear form fields specific to the current step
    const stepFields = [];
    if (stepIndex === 0) { // Employee step
        stepFields.push('#emp_id', '#fullname', '#department_team_id', '#department_group_id', 
                       '#section_id', '#designation_id', '#location_id', '#date_of_joining',
                       '#date_of_resignation', '#image', '#new_designation_title');
    } else if (stepIndex === 1) { // Current package step
        stepFields.push('#gross_salary', 'input[name="company_pickup"]', '#vehicle_id', 
                       'input[name="mobile_provided"]', '#fuel_allowance', '#fuel_litre');
    } else if (stepIndex === 2) { // Financial impact step
        stepFields.push('#emp_status_id');
    }
    
    stepFields.forEach(selector => {
        const elements = form.querySelectorAll(selector);
        elements.forEach(el => {
            if (el.type === 'radio') {
                el.checked = false;
            } else if (el.type !== 'file') {
                el.value = '';
            }
        });
    });
    
    // Reset special states
    if (stepIndex === 0) {
        addNewDesignationCheckbox.checked = false;
        updateDesignationFieldVisibility();
        resignationContainer.style.display = 'none';
        resignationInput.disabled = true;
        populateSections('');
    }
}

// Add this variable at the top with other variables
let originalEmpId = '';

// Update the storeFormData function to capture original emp_id
function storeFormData(stepIndex) {
    const formData = new FormData(form);
    const data = {};
    
    for (const [key, value] of formData.entries()) {
        if (!['step', 'csrfmiddlewaretoken', 'company_id'].includes(key)) {
            // Handle radio buttons - only store the checked one
            if (key === 'company_pickup' || key === 'mobile_provided') {
                if (value === 'true' || value === 'false') {
                    data[key] = value;
                }
            } else {
                data[key] = value;
            }
        }
    }
    
    // Ensure we capture radio button states
    ['company_pickup', 'mobile_provided'].forEach(radioName => {
        const checkedRadio = form.querySelector(`input[name="${radioName}"]:checked`);
        if (checkedRadio) {
            data[radioName] = checkedRadio.value;
        }
    });
    
    // Always store the CURRENT original_emp_id value
    data.is_update = document.getElementById('is_update').value;
    data.employee_id = document.getElementById('employee_id').value;
    data.original_emp_id = document.getElementById('original_emp_id').value || originalEmpId;
    data.emp_id = formData.get('emp_id') || ''; // Also store current emp_id for comparison
    
    // If this is employee step and no original set yet, capture it
    if (stepIndex === 0 && !data.original_emp_id && data.emp_id) {
        data.original_emp_id = data.emp_id;
        document.getElementById('original_emp_id').value = data.emp_id;
        originalEmpId = data.emp_id;
    }
    
    formDataStore[stepIndex] = data;
}

function setupEmpIdChangeMonitoring() {
    const empIdInput = document.getElementById('emp_id');
    
    // Function to check if emp_id has changed from stored original
    function checkEmpIdChange() {
        const currentValue = empIdInput.value.trim();
        const hasChanged = originalEmpId && currentValue && currentValue !== originalEmpId;
        
        console.log('👀 Emp ID Change Check:', {
            currentValue: currentValue,
            originalEmpId: originalEmpId,
            hasChanged: hasChanged
        });
        
        if (hasChanged) {
            empIdInput.style.borderColor = '#ffc107';
            empIdInput.title = `Changed from: ${originalEmpId}`;
            return true;
        } else {
            empIdInput.style.borderColor = '';
            empIdInput.title = '';
            return false;
        }
    }
    
    empIdInput.addEventListener('input', () => {
        checkEmpIdChange();
    });
    
    // Also check on form load/restore
    empIdInput.addEventListener('focus', () => {
        setTimeout(checkEmpIdChange, 100);
    });
    
    // Check immediately when function is called
    setTimeout(checkEmpIdChange, 50);
}

// Update the restoreStepData function to handle emp_id change indication
function restoreStepData(stepIndex) {
    const data = formDataStore[stepIndex];
    const q = sel => form.querySelector(sel);
    
    console.log('📂 Restoring step data:', stepIndex, data);
    console.log('data.original_emp_id', data.original_emp_id);
    
    // Restore update flags and original emp_id FIRST
    if (data && data.is_update) {
        document.getElementById('is_update').value = data.is_update;
        isUpdatingExisting = data.is_update === 'true';
    }
    
    if (data && data.employee_id) {
        document.getElementById('employee_id').value = data.employee_id;
    }
    
    if (data && data.original_emp_id) {
        const newOriginalEmpId = data.original_emp_id;
        if (newOriginalEmpId !== originalEmpId) {
            console.log('🔄 Restoring original_emp_id from stored data:', newOriginalEmpId);
            originalEmpId = newOriginalEmpId;
        }
        document.getElementById('original_emp_id').value = newOriginalEmpId;
    }
    
    // Clear all form fields first
    form.querySelectorAll('input:not([type="hidden"]), textarea, select').forEach(input => {
        if (['employee_id', 'step', 'csrfmiddlewaretoken', 'company_id', 'is_update', 'original_emp_id'].includes(input.id)) return;
        if (input.type === 'radio') {
            const radioGroup = form.querySelectorAll(`input[name="${input.name}"]`);
            radioGroup.forEach(radio => radio.checked = false);
        } else {
            input.value = '';
        }
    });
    
    // Restore specific data
    if (data) {
        for (const [key, value] of Object.entries(data)) {
            if (['is_update', 'employee_id', 'original_emp_id'].includes(key)) continue;
            
            const input = q(`#${key}`);
            if (input) {
                if (input.type === 'radio') {
                    const radio = q(`input[name="${key}"][value="${value}"]`);
                    if (radio) radio.checked = true;
                } else if (input.type === 'file') {
                    continue;
                } else {
                    input.value = value || '';
                }
            }
            
            // Handle dependent fields
            if (key === 'department_group_id' && value) {
                populateSections(value);
            }
            
            if (key === 'designation_id' && value) {
                addNewDesignationCheckbox.checked = false;
                updateDesignationFieldVisibility();
                designationSelect.value = value;
            }
            
            if (key === 'new_designation_title' && value) {
                addNewDesignationCheckbox.checked = true;
                updateDesignationFieldVisibility();
                newDesignationInput.value = value;
            }
            
            if (key === 'date_of_resignation' && value) {
                resignationContainer.style.display = 'block';
                resignationInput.disabled = false;
            }
        }
    }
    
    // After restoring, check if emp_id has changed from original (with delay)
    if (stepIndex === 0) {
        setTimeout(() => {
            const empIdInput = document.getElementById('emp_id');
            const currentValue = empIdInput ? empIdInput.value.trim() : '';
            const hasChanged = originalEmpId && currentValue && currentValue !== originalEmpId;
            
            console.log('🔍 Post-restore emp_id check:', {
                currentValue: currentValue,
                originalEmpId: originalEmpId,
                hasChanged: hasChanged
            });
            
            if (hasChanged) {
                empIdInput.style.borderColor = '#ffc107';
                empIdInput.title = `Changed from: ${originalEmpId}`;
            } else {
                empIdInput.style.borderColor = '';
                empIdInput.title = '';
            }
        }, 100);
    }
}

// Add this variable at the top with other variables
let isUpdatingExisting = false;

// Update the handleNext function to track original emp_id
// Update the handleNext function with explicit emp_id change detection
async function handleNext() {
    let formData = new FormData(form);
    formData = await handleFormSubmission(formData, steps[currentStep]);
    if (!formData) return;

    // Set update flag if we're going back and then forward again
    if (currentStep > 0 && formDataStore[currentStep]) {
        isUpdatingExisting = true;
        document.getElementById('is_update').value = 'true';
    }

    // If this is the employee step, capture the original emp_id (only if not set)
    if (currentStep === 0 && !originalEmpId) {
        const currentEmpId = formData.get('emp_id') || '';
        if (currentEmpId) {
            originalEmpId = currentEmpId;
            document.getElementById('original_emp_id').value = currentEmpId;
            console.log('🎯 Set initial original_emp_id:', originalEmpId);
        }
    }

    // Get current values for comparison
    const currentEmpId = formData.get('emp_id') || '';
    const currentOriginalEmpId = document.getElementById('original_emp_id').value || originalEmpId;
    
    // Check if emp_id has actually changed from the stored original
    const empIdChanged = currentEmpId && currentOriginalEmpId && currentEmpId.trim() !== currentOriginalEmpId.trim();
    
    console.log('🔍 Emp ID Debug Info:', {
        step: currentStep,
        currentEmpId: currentEmpId,
        currentOriginalEmpId: currentOriginalEmpId,
        empIdChanged: empIdChanged,
        isUpdatingExisting: isUpdatingExisting
    });

    try {
        const res = await fetch("{% url 'create_employee' %}", {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            body: formData
        });

        const result = await res.json();
        
        if (result.error) {
            console.error('❌ Backend error:', result.error);
            showSnackbar(result.error, '#dc3545');
            return;
        }
        
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        console.log('✅ Backend response:', result);
        
        // SUCCESS - Update original_emp_id ONLY if it was changed AND backend confirms the change
        if (empIdChanged) {
            console.log('🔄 Updating original_emp_id from', currentOriginalEmpId, 'to', currentEmpId);
            
            // Update the global variable and hidden field
            originalEmpId = currentEmpId;
            document.getElementById('original_emp_id').value = currentEmpId;

            console.log("document.getElementById('original_emp_id').value 2: ", document.getElementById('original_emp_id').value);
            
            // Update ALL stored data to reflect the new original
            Object.keys(formDataStore).forEach(stepIndex => {
                if (formDataStore[stepIndex]) {
                    formDataStore[stepIndex].original_emp_id = currentEmpId;
                    formDataStore[stepIndex].emp_id = currentEmpId;
                    console.log(`📝 Updated step ${stepIndex} original_emp_id to:`, currentEmpId);
                }
            });
            
            console.log("document.getElementById('original_emp_id').value 3: ", document.getElementById('original_emp_id').value);

            // Clear visual indicators
            const empIdInput = document.getElementById('emp_id');
            empIdInput.style.borderColor = '';
            empIdInput.title = '';
            
            showSnackbar(`Employee ID successfully updated to "${currentEmpId}"`, '#28a745');
        } else if (empIdChanged && !result.emp_id_changed) {
            console.log('⚠️ Emp ID changed but backend didn\'t process it as a change');
            // Keep the visual indicator since the change wasn't confirmed
            const empIdInput = document.getElementById('emp_id');
            empIdInput.style.borderColor = '#ffc107';
            empIdInput.title = `Change pending (original: ${currentOriginalEmpId})`;
        }
        
        if (result.employee_id) {
            document.getElementById('employee_id').value = result.employee_id;
            if (result.employee_id && !isUpdatingExisting) {
                isUpdatingExisting = true;
                document.getElementById('is_update').value = 'true';
            }
        }

        // Store data BEFORE moving to next step
        storeFormData(currentStep);
        
        currentStep++;
        if (currentStep < steps.length) {
            showStep(currentStep);
        }
        
    } catch (e) {
        console.error('💥 Network/Server Error:', e);
        showSnackbar('Error saving step: ' + e.message, '#dc3545');
        
        // ERROR - Keep original_emp_id UNCHANGED
        document.getElementById('original_emp_id').value = currentOriginalEmpId;
        originalEmpId = currentOriginalEmpId;
        
        // Keep visual indicator if emp_id was changed
        if (empIdChanged) {
            const empIdInput = document.getElementById('emp_id');
            empIdInput.style.borderColor = '#ffc107';
            empIdInput.title = `Change pending (original: ${currentOriginalEmpId})`;
        }
    }
}

// Update the back button handler
document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentStep > 0) {
        // Store current step data before going back
        storeFormData(currentStep);
        
        // When going back, remember we're in update mode if we have an employee_id
        const employeeId = document.getElementById('employee_id').value;
        if (employeeId) {
            isUpdatingExisting = true;
            document.getElementById('is_update').value = 'true';
        }
        
        currentStep--;
        showStep(currentStep);
    }
});

// Update the handleSubmit function
async function handleSubmit() {
    // Ensure update flag is set if we have an employee_id
    const employeeId = document.getElementById('employee_id').value;
    if (employeeId) {
        document.getElementById('is_update').value = 'true';
        isUpdatingExisting = true;
    }
    
    // Ensure we have the original emp_id for updates
    if (isUpdatingExisting && !originalEmpId) {
        const currentEmpId = document.getElementById('emp_id').value;
        if (currentEmpId) {
            originalEmpId = currentEmpId;
            document.getElementById('original_emp_id').value = currentEmpId;
        }
    }
    
    let formData = new FormData(form);
    formData = await handleFormSubmission(formData, steps[currentStep]);
    if (!formData) return;

    // Get current values for comparison
    const currentEmpId = formData.get('emp_id') || '';
    const currentOriginalEmpId = document.getElementById('original_emp_id').value || originalEmpId;
    const empIdChanged = currentEmpId && currentOriginalEmpId && currentEmpId.trim() !== currentOriginalEmpId.trim();
    
    console.log('🔍 Submit Debug Info:', {
        currentEmpId: currentEmpId,
        currentOriginalEmpId: currentOriginalEmpId,
        empIdChanged: empIdChanged,
        isUpdatingExisting: isUpdatingExisting
    });

    try {
        const res = await fetch("{% url 'create_employee' %}", {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            body: formData
        });
        
        if (!res.ok) {
            const errorText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const result = await res.json();
        
        if (result.error) {
            console.error('❌ Backend error on submit:', result.error);
            showSnackbar(result.error, '#dc3545');
            
            // ERROR - Keep visual indicator if emp_id was changed
            if (empIdChanged) {
                const empIdInput = document.getElementById('emp_id');
                empIdInput.style.borderColor = '#ffc107';
                empIdInput.title = `Change pending (original: ${currentOriginalEmpId})`;
            }
            return;
        }
        
        console.log('✅ Submit response:', result);
        
        // SUCCESS - Update original_emp_id ONLY if it was changed AND backend confirms
        if (result.success && empIdChanged && result.emp_id_changed === true) {
            console.log('🔄 Updating original_emp_id on submit from', currentOriginalEmpId, 'to', currentEmpId);
            
            // Update the global variable and hidden field
            originalEmpId = currentEmpId;
            document.getElementById('original_emp_id').value = currentEmpId;

            console.log("document.getElementById('original_emp_id').value: ", document.getElementById('original_emp_id').value);
            
            // Update ALL stored data to reflect the new original
            Object.keys(formDataStore).forEach(stepIndex => {
                if (formDataStore[stepIndex]) {
                    formDataStore[stepIndex].original_emp_id = currentEmpId;
                    formDataStore[stepIndex].emp_id = currentEmpId;
                }
            });
            
            // Clear visual indicators
            const empIdInput = document.getElementById('emp_id');
            empIdInput.style.borderColor = '';
            empIdInput.title = '';
        }
        
        showSpinner();
        const action = isUpdatingExisting ? 'updated' : 'created';
        showSnackbar(`Employee ${action} successfully`, '#28a745');
        window.location.href = "{% url 'employees_view' %}";
        
    } catch (e) {
        console.error('💥 Submit Error:', e);
        showSnackbar('Error saving final step: ' + e.message, '#dc3545');
        
        // ERROR - Keep original_emp_id UNCHANGED
        document.getElementById('original_emp_id').value = currentOriginalEmpId;
        originalEmpId = currentOriginalEmpId;
        
        if (empIdChanged) {
            const empIdInput = document.getElementById('emp_id');
            empIdInput.style.borderColor = '#ffc107';
            empIdInput.title = `Change pending (original: ${currentOriginalEmpId})`;
        }
    }
}

// Update the resetForm function
function resetForm() {
    isUpdatingExisting = false;
    originalEmpId = '';
    document.getElementById('is_update').value = 'false';
    document.getElementById('employee_id').value = '';
    document.getElementById('original_emp_id').value = '';
    currentStep = 0;
    formDataStore = {};
    form.reset();
    clearStepData(0);
    showStep(0);
}

// Update the DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
    fetchDropdownData();
    updateDesignationFieldVisibility();
    showStep(currentStep);
    
    // Update the back button handler
    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentStep > 0) {
            // Store current step data before going back
            storeFormData(currentStep);
            currentStep--;
            showStep(currentStep);
        }
    });
});

        async function confirmNext() {
            if (currentStep === 0) {
                const errors = validateEmployeeStep();
                if (errors.length) {
                    showSnackbar(`Please fix the following errors: ${errors.join(', ')}`, '#dc3545');
                    return;
                }
            }
            showConfirmPopup('Are you sure you want to proceed to the next step?', async () => {
                await handleNext();
            });
        }

        async function handleFormSubmission(formData, step) {
            if (step === 'employee') {
                const errors = validateEmployeeStep();
                if (errors.length) {
                    showSnackbar(`Please fix the following errors: ${errors.join(', ')}`, '#dc3545');
                    return null;
                }
                if (addNewDesignationCheckbox.checked) {
                    const created = await createNewDesignation();
                    if (created) {
                        formData.set('designation_id', created.id);
                        try {
                            const data = await fetchJSON(`/payroll/designations/?company_id=${companyId}`);
                            populateDesignations(asArray(data));
                            designationSelect.value = created.id;
                        } catch (e) {
                            console.error('Error refreshing designations:', e);
                        }
                    } else {
                        return null;
                    }
                }
            } else if (step === 'financial_impact') {
                const errors = validateFinancialImpactStep();
                if (errors.length) {
                    showSnackbar(`Please fix the following errors: ${errors.join(', ')}`, '#dc3545');
                    return null;
                }
            }
            return formData;
        }

        function showSnackbar(message, bgColor) {
            const snackbar = document.createElement('div');
            snackbar.textContent = message;
            snackbar.style.position = 'fixed';
            snackbar.style.bottom = '20px';
            snackbar.style.left = '50%';
            snackbar.style.transform = 'translateX(-50%)';
            snackbar.style.backgroundColor = bgColor;
            snackbar.style.color = '#fff';
            snackbar.style.padding = '12px 24px';
            snackbar.style.borderRadius = '6px';
            snackbar.style.zIndex = '1000';
            document.body.appendChild(snackbar);
            setTimeout(() => snackbar.remove(), 3000);
        }

        function showConfirmPopup(message, callback) {
            const popup = document.createElement('div');
            popup.className = 'confirm-popup';
            popup.innerHTML = `
                <p>${message}</p>
                <div class="button-group">
                    <button class="form-btn btn-submit" onclick="this.closest('.confirm-popup').remove(); (${callback.toString()})();">Confirm</button>
                    <button class="form-btn btn-back" onclick="this.closest('.confirm-popup').remove();">Cancel</button>
                </div>
            `;
            document.body.appendChild(popup);
            popup.style.position = 'fixed';
            popup.style.top = '50%';
            popup.style.left = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.background = '#fff';
            popup.style.borderRadius = '8px';
            popup.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
            popup.style.padding = '16px';
            popup.style.textAlign = 'center';
            popup.style.zIndex = '1000';
        }

        function showSpinner() {
            const spinner = document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.position = 'fixed';
            spinner.style.top = '50%';
            spinner.style.left = '50%';
            spinner.style.transform = 'translate(-50%, -50%)';
            spinner.style.width = '40px';
            spinner.style.height = '40px';
            spinner.style.border = '4px solid #f3f3f3';
            spinner.style.borderTop = '4px solid #3498db';
            spinner.style.borderRadius = '50%';
            spinner.style.animation = 'spin 1s linear infinite';
            document.body.appendChild(spinner);
            setTimeout(() => spinner.remove(), 1000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchDropdownData();
            updateDesignationFieldVisibility();
            showStep(currentStep);
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });
        });
    </script>
{% else %}
    <p>You do not have permission to add employees.</p>
{% endif %}
{% endblock %}