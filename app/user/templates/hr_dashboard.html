{% extends 'base.html' %}
{% block content %}
{% load custom_tags %}
<div class="header-container">
    <h2>United Marine Agencies (Pvt.) Ltd.</h2>
    {% if summary_status and not summary_status.summary_submitted %}
    <button class="action-btn btn-primary final-approval-btn" onclick="confirmFinalApproval('{{ summary_status.id }}')">Approve Summary</button>
    {% endif %}
</div>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Increment Details -->
<div id="increment-data" class="mt-20">
    {% if data %}
    <h4>Increment Details</h4>
    <div class="table-scroll-container">
        <table class="custom-table">
            <thead>
                <tr>
                    <th rowspan="3" class="status-col sticky-col sticky-col-1 sticky-header"></th>
                    <th rowspan="3" class="sticky-col sticky-col-2 sticky-header">Department</th>
                    <th rowspan="2" colspan="2" class="group-header sticky-col sticky-col-3 sticky-header">No. of Employees</th>
                    <th rowspan="3" class="sticky-col sticky-col-5 sticky-header">Current Salary</th>
                    <th rowspan="3" class="sticky-col sticky-col-6 sticky-header">Effective increment rate HOD</th>
                    <th rowspan="3" class="sticky-col sticky-col-7 sticky-header">Effective Fuel % HOD</th>
                    <th rowspan="1" colspan="2" class="group-header sticky-col sticky-col-8 sticky-header">Increment</th>
                    <th rowspan="3" class="non-sticky-header">Other costs in P&L</th>
                    <th rowspan="3" class="non-sticky-header">Total Cost on P&L per month</th>
                    <th rowspan="3" class="non-sticky-header">Revised Department Salary</th>
                    <th rowspan="3" class="non-sticky-header">Staff Revised Cost</th>
                    <th rowspan="3" class="non-sticky-header">Approved</th>
                </tr>
                <tr>
                    <th class="sticky-col sticky-col-8 sticky-header">Salary</th>
                    <th class="sticky-col sticky-col-9 sticky-header">Fuel</th>
                </tr>
                <tr>
                    <th class="sticky-col sticky-col-3 sticky-header">Total</th>
                    <th class="sticky-col sticky-col-4 sticky-header">Eligible for Increment</th>
                    <th class="sticky-col sticky-col-8 sticky-header">Impact HOD</th>
                    <th class="sticky-col sticky-col-9 sticky-header">Impact HOD</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr data-id="{{ row.id }}" data-eligible="{{ row.eligible_for_increment|default:'' }}">
                    <td class="status-cell sticky-col sticky-col-1 {% if row.is_draft %}draft{% endif %}"></td>
                    <td class="sticky-col sticky-col-2">{{ row.department|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-3">{{ row|get_item:"total employees"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-4">{{ row|get_item:"eligible for increment"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-5">{{ row|get_item:"current salary"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-6">{{ row|get_item:"effective increment rate hod"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-7">{{ row|get_item:"effective fuel percentage hod"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-8">{{ row|get_item:"salary increment impact hod"|default_if_none:'' }}</td>
                    <td class="sticky-col sticky-col-9">{{ row|get_item:"fuel increment impact hod"|default_if_none:'' }}</td>
                    <td class="non-sticky">{{ row|get_item:"other costs in p and l"|default_if_none:'' }}</td>
                    <td class="non-sticky">{{ row|get_item:"total cost on p and l per month"|default_if_none:'' }}</td>
                    <td class="non-sticky">{{ row|get_item:"revised department salary"|default_if_none:'' }}</td>
                    <td class="non-sticky">{{ row|get_item:"staff revised cost"|default_if_none:'' }}</td>
                    {% if row.is_draft %}
                    <td class="non-sticky approved-cell">
                        <input type="checkbox" class="approved-checkbox" data-id="{{ row.id }}"
                            onchange="updateApproved(this)" {% if row.approved %}checked{% endif %}>
                    </td>
                    {% else %}
                    <td class="non-sticky"></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="muted">No increment details found.</p>
    {% endif %}
</div>

<style>
/* Existing styles remain unchanged, adding new styles for header container */
.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.final-approval-btn {
    margin-left: auto; /* Pushes button to the right of the title */
}

/* Adjust button size for consistency */
.action-btn.btn-primary.final-approval-btn {
    padding: 10px 20px;
    font-size: 16px;
}

/* Responsive adjustments */
@media screen and (max-width: 768px) {
    .header-container {
        flex-direction: column;
        align-items: flex-start;
    }
    .final-approval-btn {
        margin-left: 0;
        margin-top: 10px;
    }
}

/* Existing styles for table, buttons, etc. remain unchanged */
.increment-data {
    overflow: hidden !important;
    padding: 20px;
}
.content {
    overflow: hidden !important;
}
.table-scroll-container {
    max-height: 500px;
    overflow-x: auto;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    position: relative;
    width: 100%;
    min-width: 100%;
    -webkit-clip-path: inset(0);
    clip-path: inset(0);
}
.custom-table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
    table-layout: auto;
}
.custom-table th, .custom-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
    background-color: inherit;
}
.custom-table th {
    background-color: #f2f2f2;
}
.custom-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 40;
    border: none !important;
    background-color: #f2f2f2 !important;
    box-shadow: inset 0 -1px 0 #dee2e6;
}
.sticky-col {
    position: sticky;
    z-index: 30;
    background-color: #ffffff !important;
    border: none !important;
    box-shadow: inset 0 -1px 0 #dee2e6;
}
.sticky-col.sticky-header {
    z-index: 50;
    background-color: #f2f2f2 !important;
    border: none !important;
}
.non-sticky-header {
    position: sticky;
    top: 0;
    z-index: 20;
    background-color: #f2f2f2 !important;
}
.non-sticky {
    z-index: 5;
    background-color: #ffffff !important;
}
th.group-header {
    text-align: center;
}
.action-btn {
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    margin-right: 5px;
    border: none;
}
.btn-primary { background-color: #007bff; }
.btn-primary:hover { background-color: #0056b3; }
.btn-secondary { background-color: #6c757d; }
.btn-secondary:hover { background-color: #565e64; }
td.approved-cell {
    text-align: center;
    vertical-align: middle;
}
.approved-checkbox {
    appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 4px;
    background-color: #fff;
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}
.approved-checkbox:checked {
    background-color: #4caf50;
    border-color: #4caf50;
}
.approved-checkbox:checked::after {
    content: '';
    position: absolute;
    left: 6px;
    top: 2px;
    width: 4px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}
.status-col, .status-cell {
    width: 2px;
    padding: 0;
    box-shadow: inset 0 -1px 0 #dee2e6;
}
.status-cell.draft {
    background-color: #ffc107 !important;
}
@media screen and (max-width: 768px) {
    .custom-table th, .custom-table td {
        font-size: 14px;
        padding: 6px;
    }
    .action-btn {
        font-size: 12px;
        padding: 6px 12px;
    }
}
.sticky-col-4, .sticky-col-6, .sticky-col-7 {
    width: 100px;
    max-width: 100px;
}
.sticky-col-4.sticky-header,
.sticky-col-6.sticky-header,
.sticky-col-7.sticky-header {
    white-space: normal;
    line-height: 1.2;
    padding: 8px;
    text-align: center;
}
.sticky-col-1 { width: 2px; }
.sticky-col-2 { width: 150px; }
.sticky-col-3 { width: 80px; }
.sticky-col-5 { width: 120px; }
.sticky-col-8 { width: 100px; }
.sticky-col-9 { width: 100px; }

/* Fake right border */
.sticky-col-1::after,
.sticky-col-2::after,
.sticky-col-3::after,
.sticky-col-4::after,
.sticky-col-5::after,
.sticky-col-6::after,
.sticky-col-7::after,
.sticky-col-8::after,
.sticky-col-9::after {
    content: "";
    position: absolute;
    top: 0;
    right: 0; /* use left: 0 if you want a left border instead */
    width: 1px;
    height: 100%;
    background-color: #ccc; /* the color of your border line */
    z-index: 20; /* ensure it's above other content */
}




{% comment %} css by grok to fix align issue  {% endcomment %}

/* Remove or comment out fixed top values */
th.group-header,
th.sticky-subheader {
    /* top: 40px; /* Remove this */
    position: sticky; /* Handled by JS */
    z-index: 45; /* Default z-index, overridden by JS */
    background-color: #f2f2f2 !important;
    border: none !important;
    box-shadow: inset 0 -1px 0 #dee2e6;
}

.sticky-col {
    position: sticky; /* Handled by JS */
    z-index: 46; /* Default, overridden by JS */
    background-color: #ffffff !important;
    border: none !important;
    box-shadow: inset 0 -1px 0 #dee2e6;
}





</style>

<script>
// Existing JavaScript remains unchanged
{% comment %} document.addEventListener('DOMContentLoaded', () => {
    const table = document.querySelector('.custom-table');
    const headerRows = table.querySelectorAll('thead tr');
    const bodyRows = table.querySelectorAll('tbody tr');

    const firstRow = document.querySelector('thead tr:first-child');
        const subHeaders = document.querySelectorAll('th.sticky-subheader');
        if (firstRow && subHeaders.length) {
            const firstRowHeight = firstRow.getBoundingClientRect().height;
            subHeaders.forEach(subHeader => {
                subHeader.style.top = `${firstRowHeight}px`;
            });
        }

    const setStickyOffsets = () => {
        const stickyColumns = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        let cumulativeLeft = 0;

        stickyColumns.forEach((colIndex, index) => {
            const headerCell = headerRows[2].querySelector(`th.sticky-col-${colIndex}`) || headerRows[0].querySelector(`th.sticky-col-${colIndex}`);
            if (headerCell) {
                const width = headerCell.offsetWidth;
                const className = `.sticky-col-${colIndex}`;
                document.querySelectorAll(className).forEach(cell => {
                    cell.style.left = `${cumulativeLeft}px`;
                });
                cumulativeLeft += width;
            }
        });
    };

    setStickyOffsets();
    window.addEventListener('resize', setStickyOffsets);
}); {% endcomment %}



document.addEventListener('DOMContentLoaded', () => {
    const table = document.querySelector('.custom-table');
    const headerRows = table.querySelectorAll('thead tr');
    const bodyRows = table.querySelectorAll('tbody tr');

    // Function to update sticky header positions dynamically
    const updateStickyHeaders = () => {
        // Calculate the cumulative height of all header rows above each row
        headerRows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll('th');
            const offsetTop = Array.from(headerRows)
                .slice(0, rowIndex)
                .reduce((sum, prevRow) => sum + prevRow.getBoundingClientRect().height, 0);

            cells.forEach(cell => {
                // Apply sticky positioning with dynamic top offset
                cell.style.position = 'sticky';
                cell.style.top = `${offsetTop}px`;
                cell.style.zIndex = rowIndex === 0 ? 50 : 45; // Higher z-index for top row
                cell.style.backgroundColor = '#f2f2f2'; // Ensure background for readability
                cell.style.borderBottom = '1px solid #dee2e6'; // Maintain separation

                // Handle sticky columns
                if (cell.classList.contains('sticky-col')) {
                    cell.style.zIndex = rowIndex === 0 ? 55 : 46; // Higher z-index for sticky cols
                    cell.style.backgroundColor = '#ffffff'; // Distinct background for sticky cols
                }
            });
        });

        // Set sticky column offsets dynamically
        const stickyColumns = [1, 2, 3, 4, 5, 6, 7, 8, 9];
        let cumulativeLeft = 0;

        stickyColumns.forEach((colIndex) => {
            const headerCell = headerRows[headerRows.length - 1].querySelector(`th.sticky-col-${colIndex}`) ||
                              headerRows[0].querySelector(`th.sticky-col-${colIndex}`);
            if (headerCell) {
                const width = headerCell.offsetWidth;
                const className = `.sticky-col-${colIndex}`;
                document.querySelectorAll(className).forEach(cell => {
                    cell.style.left = `${cumulativeLeft}px`;
                    // Ensure sub-headers align with their columns
                    if (cell.parentElement.rowIndex > 0) {
                        const parentRowOffset = Array.from(headerRows)
                            .slice(0, cell.parentElement.rowIndex)
                            .reduce((sum, prevRow) => sum + prevRow.getBoundingClientRect().height, 0);
                        cell.style.top = `${parentRowOffset}px`;
                    }
                });
                cumulativeLeft += width;
            }
        });
    };

    // Initial setup and event listeners
    updateStickyHeaders();
    window.addEventListener('resize', updateStickyHeaders);
    window.addEventListener('scroll', updateStickyHeaders); // Update on scroll if needed

    // Ensure the table recalculates on content change (e.g., data load)
    const observer = new MutationObserver(updateStickyHeaders);
    observer.observe(table, { childList: true, subtree: true });
});



async function submitEdit() {
    const formData = new FormData(document.getElementById('editForm'));
    const entries = {};
    for (const [k,v] of formData.entries()) { if (k !== 'csrfmiddlewaretoken') entries[k] = v; }

    try {
        const resp = await fetch('/payroll/hr/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(entries)
        });

        if (!resp.ok) throw new Error('Failed to save');
        showSnackbar('Increment detail updated successfully!');
        window.location.reload();
    } catch (e) {
        console.error(e);
        showSnackbar('Error updating increment detail. Please try again.', '#dc3545');
    }
}

async function updateApproved(checkbox) {
    const rowId = checkbox.dataset.id;
    const approved = checkbox.checked;

    try {
        const resp = await fetch('/payroll/hr/approved/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: rowId, approved: approved })
        });

        if (!resp.ok) throw new Error('Failed to save approved');
        // showSnackbar(`Row ${rowId} approved status updated to ${approved}`);
        showSnackbar(`Approved status updated to ${approved}`);
        window.location.reload();
    } catch (e) {
        console.error(e);
        showSnackbar('Error updating approved status. Please try again.', '#dc3545');
    }
}

function confirmFinalApproval(statusId) {
    showConfirmPopup(
        "This will approve the entire summary. Please confirm before proceeding.",
        async function yesCallback() {
            await updateFinalApproval(statusId);
        },
        function noCallback() {
            // do nothing
        }
    );
}

async function updateFinalApproval(statusId) {
    try {
        const resp = await fetch('/payroll/hr/final-approve/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: statusId })
        });

        if (!resp.ok) throw new Error("Failed to approve summary");
        showSnackbar("Summary approved successfully!");
        window.location.reload();
    } catch (e) {
        console.error(e);
        showSnackbar("Error approving summary", "#dc3545");
    }
}
</script>
{% endblock %}