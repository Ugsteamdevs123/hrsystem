{% extends 'base.html' %}

{% block title %}HR Dashboard{% endblock %}

{% block content %}
<h2>HR Dashboard</h2>

<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<!-- Final Approval Section -->
{% if summary_status and not summary_status.summary_submitted %}
<div class="card-like" id="final-approval-box">
    <h3>Final Approval</h3>
    <p>This will approve the entire summary. Please confirm before proceeding.</p>
    <button class="action-btn btn-primary" onclick="confirmFinalApproval('{{ summary_status.id }}')">Approve Summary</button>
</div>
{% else %}
<div class="card-like" id="final-approval-box" style="display:none;">
    <h3>Final Approval</h3>
    <p>This will approve the entire summary. Please confirm before proceeding.</p>
    <button class="action-btn btn-primary" onclick="confirmFinalApproval()">Approve Summary</button>
</div>
{% endif %}

<!-- Increment Details -->
<div id="increment-data" class="mt-20">
    {% if data %}
    <h4>Increment Details</h4>
    <table class="custom-table">
        <thead>
            <tr>
                <th rowspan="3" class="status-col"></th> <!-- Nameless thin header for draft indicator -->
                <th rowspan="3">Department</th>
                <th rowspan="2" colspan="2" class="group-header">No. of Employees</th>
                <th rowspan="3">Current Salary</th>
                <th rowspan="3">Effective increment rate HOD</th>
                <th rowspan="3">Effective Fuel % HOD</th>
                <th rowspan="1" colspan="2" class="group-header">Increment</th>
                <th rowspan="3">Other costs in P&L</th>
                <th rowspan="3">Total Cost on P&L per month</th>
                <th rowspan="3">Revised Department Salary</th>
                <th rowspan="3">Staff Revised Cost</th>
                <th rowspan="3">Approved</th>
            </tr>
            <tr>
                <th>Salary</th>
                <th>Fuel</th>
            </tr>
            <tr>
                <!-- Employee Details Subheaders -->
                <th>Total</th>
                <th>Eligible for Increment</th>
                <th>Impact HOD</th>
                <th>Impact HOD</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data %}
            <tr data-id="{{ row.id }}" data-eligible="{{ row.eligible_for_increment|default:'' }}">
                <!-- Draft indicator cell -->
                <td class="status-cell {% if row.is_draft %}draft{% endif %}"></td>
                {% for key, value in row.items %}
                    {% if key != 'id' and key != 'is_draft' %}
                        {% if key == 'approved' and row.is_draft %}
                            <td>
                                <select class="approved-select" data-id="{{ row.id }}" onchange="updateApproved(this)">
                                    <option value="true" {% if value %}selected{% endif %}>True</option>
                                    <option value="false" {% if not value %}selected{% endif %}>False</option>
                                </select>
                            </td>
                        {% elif key == 'approved' %}
                            <td></td>
                        {% else %}
                            <td>{{ value|default_if_none:'' }}</td>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="muted">No increment details found.</p>
    {% endif %}
</div>

<style>
/* Card container */
.card-like {
    background: #fff;
    padding: 20px;
    margin: 10px 0;
    border-radius: 8px;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
}
/* Table styling */
.custom-table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
}
.custom-table th, .custom-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
}
.custom-table th {
    background-color: #f2f2f2;
}
.custom-table tr:nth-child(even) {
    background-color: #f9f9f9;
}
/* Buttons */
.action-btn {
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    margin-right: 5px;
    border: none;
}
.btn-primary { background-color: #007bff; }
.btn-primary:hover { background-color: #0056b3; }
.btn-secondary { background-color: #6c757d; }
.btn-secondary:hover { background-color: #565e64; }

.status-col, .status-cell {
    width: 2px;        /* make it as thin as possible */
    padding: 0;        /* remove inner spacing */
    border: none;      /* no border, otherwise it looks wider */
}

.status-cell.draft {
    background-color: #ffc107;  /* yellow */
}

/* Responsive */
@media screen and (max-width: 768px) {
    .custom-table, th, td { font-size: 14px; }
    .action-btn { font-size: 12px; padding: 6px 12px; }
}

th.group-header {
    text-align: center;
}
</style>

<script>

async function submitEdit() {
    const formData = new FormData(document.getElementById('editForm'));
    const entries = {};
    for (const [k,v] of formData.entries()) { if (k !== 'csrfmiddlewaretoken') entries[k] = v; }

    try {
        const resp = await fetch('/payroll/hr/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(entries)
        });

        if (!resp.ok) throw new Error('Failed to save');
        showSnackbar('Increment detail updated successfully!');
        window.location.reload(); // Reload to refresh server-rendered table
    } catch (e) {
        console.error(e);
        showSnackbar('Error updating increment detail. Please try again.', '#dc3545');
    }
}

async function updateApproved(select) {
    console.log("hello");
    const rowId = select.dataset.id;
    console.log("rowId: ", rowId);
    const newVal = select.value === 'true';
    console.log("newVal: ", newVal);

    try {
        console.log(document.querySelector('input[name="csrfmiddlewaretoken"]').value);
        const resp = await fetch('/payroll/hr/approved/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: rowId, approved: newVal })
        });

        if (!resp.ok) throw new Error('Failed to save approved');
        showSnackbar(`Row ${rowId} approved status updated to ${newVal}`);
        window.location.reload(); // Reload to refresh server-rendered table
    } catch (e) {
        console.error(e);
        showSnackbar('Error updating approved status. Please try again.', '#dc3545');
    }
}

function confirmFinalApproval(statusId) {
    showConfirmPopup(
        "Are you sure you want to approve this summary? This action is final.",
        async function yesCallback() {
            await updateFinalApproval(statusId);
        },
        function noCallback() {
            // do nothing
        }
    );
}

async function updateFinalApproval(statusId) {
    try {
        const resp = await fetch('/payroll/hr/final-approve/', {
            method: 'PATCH',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: statusId })
        });

        if (!resp.ok) throw new Error("Failed to approve summary");
        showSnackbar("Summary approved successfully!");
        window.location.reload(); // Reload to refresh server-rendered table
    } catch (e) {
        console.error(e);
        showSnackbar("Error approving summary", "#dc3545");
    }
}

</script>
{% endblock %}