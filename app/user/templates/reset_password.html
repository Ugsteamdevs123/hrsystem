{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}

{% block content %}
<h2>Reset Password</h2>

{% comment %} <!-- Show Django messages (works if base.html includes {% for message in messages %}...) -->
{% if messages %}
  <div>
    {% for message in messages %}
      <div class="alert {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %} {% endcomment %}

<form id="resetPasswordForm" method="POST">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- Old password -->
    <div class="form-field">
        {{ form.old_password.label_tag }}
        <div style="position: relative;">
            {{ form.old_password }}
            <button type="button" class="toggle-password" onclick="togglePassword('id_old_password', this)">üëÅ</button>
        </div>
        {% if form.old_password.errors %}
            <div class="error">{{ form.old_password.errors|striptags }}</div>
        {% endif %}
    </div>

    <!-- New password -->
    <div class="form-field">
        {{ form.new_password1.label_tag }}
        <div style="position: relative;">
            {{ form.new_password1 }}
            <button type="button" class="toggle-password" onclick="togglePassword('id_new_password1', this)">üëÅ</button>
        </div>
        <div class="error" id="new_password_error">
            {% if form.new_password1.errors %}{{ form.new_password1.errors|striptags }}{% endif %}
        </div>
    </div>

    <!-- Confirm new password -->
    <div class="form-field">
        {{ form.new_password2.label_tag }}
        <div style="position: relative;">
            {{ form.new_password2 }}
            <button type="button" class="toggle-password" onclick="togglePassword('id_new_password2', this)">üëÅ</button>
        </div>
        <div class="error" id="confirm_password_error">
            {% if form.new_password2.errors %}{{ form.new_password2.errors|striptags }}{% endif %}
        </div>
    </div>

    <div class="button-group">
        <button type="button" class="form-btn btn-submit" id="resetBtn">Reset Password</button>
        <button type="button" class="form-btn btn-back" onclick="window.location.href='{% url 'login' %}'">Cancel</button>
    </div>
</form>

<style>
.form-field {
    margin-bottom: 15px;
    text-align: left;
}
.form-field input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
}
.error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
}
.form-btn {
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    margin-right: 10px;
}
.btn-submit { background-color: #28a745; color: #fff; }
.btn-submit:hover { background-color: #218838; }
.btn-back { background-color: #6c757d; color: #fff; }
.btn-back:hover { background-color: #5a6268; }
.toggle-password {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
}
@media screen and (max-width: 500px) {
    .form-btn { font-size: 12px; padding: 10px; }
    .form-field input { font-size: 14px; padding: 10px; }
}
</style>

    <script>
        // Toggle show/hide password
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                btn.textContent = "üôà";
            } else {
                input.type = "password";
                btn.textContent = "üëÅ";
            }
        }

        if (typeof showConfirmPopup !== 'function') {
            window.showConfirmPopup = function (message, cb) {
                if (confirm(message)) cb();
            };
        }

        document.getElementById('resetBtn').addEventListener('click', function () {
            const oldPwEl = document.getElementById('id_old_password');
            const newPwEl = document.getElementById('id_new_password1');
            const confirmPwEl = document.getElementById('id_new_password2');

            const new_password_error = document.getElementById('new_password_error');
            const confirm_password_error = document.getElementById('confirm_password_error');

            new_password_error.textContent = '';
            confirm_password_error.textContent = '';

            const old_password = oldPwEl && oldPwEl.value.trim();
            const new_password = newPwEl && newPwEl.value.trim();
            const confirm_password = confirmPwEl && confirmPwEl.value.trim();

            if (!old_password) {
                new_password_error.textContent = 'Please enter your current password.';
                return;
            }

            // Regex: at least 8 chars, 1 uppercase, 1 number, 1 special char
            const passwordRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\<>?]).{8,}$/;

            if (!passwordRegex.test(new_password)) {
                new_password_error.textContent = 'Password must be at least 8 characters, include 1 uppercase, 1 number, 1 special character.';
                return;
            }

            if (new_password !== confirm_password) {
                confirm_password_error.textContent = 'Passwords do not match.';
                return;
            }

            showConfirmPopup('Are you sure you want to reset your password?', function () {
                document.getElementById('resetPasswordForm').submit();
            });
        });
    </script>

{% endblock %}
